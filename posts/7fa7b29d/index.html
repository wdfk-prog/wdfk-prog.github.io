<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SDMMC | wdfk-prog的个人博客</title><meta name="author" content="Liya Huang"><meta name="copyright" content="Liya Huang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SDMMC SD 协议 SD 卡系统定义了三种通信协议：SD ， SPI 和 UHS-II。主机系统可以选择任意一种。当收到 reset 命令的时候，SD 卡通过主机的信息来决定 使用何种模式，并且之后的通讯都会使用相同的模式。不推荐多卡槽用共同的总线信号。一个单独的 SD 总线应该连接一个单独的 可移除的 SD 卡。UHS-II 支持多个器件通过环形（Ring）或 Hub 拓扑连接 在默认速度下">
<meta property="og:type" content="article">
<meta property="og:title" content="SDMMC">
<meta property="og:url" content="https://wdfk-prog.space/posts/7fa7b29d/index.html">
<meta property="og:site_name" content="wdfk-prog的个人博客">
<meta property="og:description" content="SDMMC SD 协议 SD 卡系统定义了三种通信协议：SD ， SPI 和 UHS-II。主机系统可以选择任意一种。当收到 reset 命令的时候，SD 卡通过主机的信息来决定 使用何种模式，并且之后的通讯都会使用相同的模式。不推荐多卡槽用共同的总线信号。一个单独的 SD 总线应该连接一个单独的 可移除的 SD 卡。UHS-II 支持多个器件通过环形（Ring）或 Hub 拓扑连接 在默认速度下">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wdfk-prog.space/images/covers/09.jpg">
<meta property="article:published_time" content="2025-10-03T01:44:51.000Z">
<meta property="article:modified_time" content="2025-10-03T09:23:27.902Z">
<meta property="article:author" content="Liya Huang">
<meta property="article:tag" content="rt-thread">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wdfk-prog.space/images/covers/09.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "SDMMC",
  "url": "https://wdfk-prog.space/posts/7fa7b29d/",
  "image": "https://wdfk-prog.space/images/covers/09.jpg",
  "datePublished": "2025-10-03T01:44:51.000Z",
  "dateModified": "2025-10-03T09:23:27.902Z",
  "author": [
    {
      "@type": "Person",
      "name": "Liya Huang",
      "url": "https://github.com/wdfk-prog"
    }
  ]
}</script><link rel="shortcut icon" href="/images/favicon.png"><link rel="canonical" href="https://wdfk-prog.space/posts/7fa7b29d/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//static.cloudflareinsights.com"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxxxxx"/><meta name="baidu-site-verification" content="xxxxxxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-3978542742563797',
  enable_page_level_ads: 'true'
});</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?3c49dd4913ab43efb1bfc8d12b1cded9";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-PF2CVP2PL4"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-PF2CVP2PL4')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-PF2CVP2PL4', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script defer="defer" data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;17ff914b5e28493597b7dc19f3356022&quot;}"></script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "tkaenn1tjv");
</script><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
"https://www.googletagmanager.com/gtm.js?id="+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MF3J339H');
btf.addGlobalFn('pjaxComplete', () => {
  dataLayer.push({'event': 'pjaxComplete', 'page_title': document.title, 'page_location': location.href, 'page_path': window.location.pathname})
}, 'google_tag_manager')</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SDMMC',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.0.0"><link rel="alternate" href="/atom.xml" title="wdfk-prog的个人博客" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (true) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/images/subtle-texture.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/avatar.png" onerror="this.onerror=null;this.src='/images/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">414</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">49</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">53</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book-open"></i><span> 页面</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-quote-left"></i><span> 说说</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 示例</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i><span> 歌曲</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/images/covers/09.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/my-logo.png" alt="Logo"><span class="site-name">wdfk-prog的个人博客</span></a><a class="nav-page-title" href="/"><span class="site-name">SDMMC</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book-open"></i><span> 页面</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-quote-left"></i><span> 说说</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 示例</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i><span> 歌曲</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">SDMMC<a class="post-edit-link" href="null_posts/rt-thread/SDMMC.md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-10-03T01:44:51.000Z" title="发表于 2025-10-03 09:44:51">2025-10-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-10-03T09:23:27.902Z" title="更新于 2025-10-03 17:23:27">2025-10-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/rt-thread/">rt-thread</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">8.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>33分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/7fa7b29d/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;已经过了&quot;,&quot;messageNext&quot;:&quot;自上次更新以来，文章的内容可能已经过时&quot;,&quot;postUpdate&quot;:&quot;2025-10-03 17:23:27&quot;}" hidden></div><h1 id="SDMMC"><a href="#SDMMC" class="headerlink" title="SDMMC"></a>SDMMC</h1><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/readme.assets/858c8facb65c2fa2d177c05d6dce6715.png.webp" alt="screenshot_image.png"></p>
<h2 id="SD-协议"><a href="#SD-协议" class="headerlink" title="SD 协议"></a>SD 协议</h2><ul>
<li>SD 卡系统定义了三种通信协议：SD ， SPI 和 UHS-II。主机系统可以选择任意一种。当收到 reset 命令的时候，SD 卡通过主机的信息来决定 使用何种模式，并且之后的通讯都会使用相同的模式。不推荐多卡槽用共同的总线信号。一个单独的 SD 总线应该连接一个单独的 可移除的 SD 卡。UHS-II 支持多个器件通过环形（Ring）或 Hub 拓扑连接</li>
<li>在默认速度下，SD 卡总线有一个主(应用),多个从(卡)，同步的星型拓扑结构(图 3-1)。时钟，电源和 地信号是所有卡都有的。在高速模式和 UHS-I 模式下，SD 卡总线有一个主机（应用）一个从（卡），同步的点对点拓扑。命令(CMD)和数据(DAT0-3)信号是根据每张卡的，提供连续地点对点连接到所有卡。</li>
<li>在初始化时，处理命令会单独发送到每个卡，允许应用程序检测卡以及分配逻辑地址给物理卡槽。数据总是单独发送(接收)到(从)每张卡。但是，为了简化卡的堆栈操作，在初始 化过</li>
</ul>
<p>程结束后，所有的命令都是同时发送到所有卡。地址信息包含在命令包中。</p>
<ul>
<li>SD 总线允许数据线的动态配置。上电后，SD 卡默认只使用 DAT0 来传输数据。初始化之 后，主机可以改变总线宽度(使用的数据线数目)。这个功能允许硬件成本和系统性能之间的简单交换。注意：当 DAT1-DAT3 没有使用的时候，相关的主机 DAT 先应该被设置为输入模式。SDIO 卡 DAT1 和 DAT2 用于信令。</li>
</ul>
<h3 id="SD总线"><a href="#SD总线" class="headerlink" title="SD总线"></a>SD总线</h3><ol>
<li>SD 总线的通信是基于命令和数据流的。由一个起始位开始，由一个停止位终止。</li>
</ol>
<ul>
<li>命令(Command)：命令就是一个标记，用于发起一个操作。由主机发送到单个卡(寻址命令)或者所有卡(广播命令)。命令在CMD线上是连续传输的。</li>
<li>响应(Response)：响应是一个标记，从寻址的卡或者所有卡(同步)发送给主机，作为向前接收到的命令的回答。响应也是在CMD线上连续传输的。</li>
<li>数据(Data)：数据可以从主机到卡，也可以从卡到主机。通过数据线传输。</li>
</ul>
<ol start="2">
<li>卡片寻址通过使用会话地址来实现，会话地址会在初始化阶段分配给卡。命令，响应和 数据块的结构在第 4 章中描述。SD 总线上的基本交互是命令&#x2F;响应交互(图 3-4)。这种总线交互直接在命令或者响应的结构里面传输他们的信息。此外，一些操作还有数据内容。</li>
<li>SD 卡发送或接收的数据在块(block)中完成。数据块以 CRC 位来保证成功。目前有单块或多块操作。注意：多块操作模式在快速写操作时更好一点。多块传输以命令线上的结束命 令为结束标志。主机端可以配置单线还是多线传输。</li>
<li>块写操作使用简单的busy来表示DAT0数据线上的持续写操作，不管使用几线传输。</li>
<li>命令内容：命令+地址信息&#x2F;参数+7位CRC校验(48bit)</li>
</ol>
<ul>
<li>每一个命令标记都是以起始位 bit(0)在最开始，以结束位 bit(1)表示成功。总长度是48Bit。每个命令都使用 CRC 位来保护，这样可以检测到传输错误，并且再次发送命令。</li>
<li>。数据块的 CRC 保护算法是一个 16bit 的 CCITT 多项式。</li>
</ul>
<ol start="6">
<li>在命令线上最高有效位(MSB)先发送，最低有效位(LSB)后发送(从高位到低位传输)。 当使用宽总线操作的时候，数据每次传 4Bit(见图3-10)。起始位、结束位以及 CRC 位，每条数据线上都要发送。CRC 位每条数据线都要分别检查。CRC 状态反馈和忙碌只是只会从 DAT0 发送到 host 端，DAT1-DAT3 忽略。</li>
<li>上电时，这条线在卡中有一个 50KOhm 的上拉。这个电阻有两个作用：卡检测和模式选择。作为模式选择，主机可以拉高或让别人拉高这个脚来选择 SD 模式。如果主机想选择 SPI 模式，应该把管脚拉低；作为卡检测，当管脚被拉高时，认为卡插入了。这条线的上拉在数据传输期间应由用户通过命令 SET_CLR_CARD_DETECT(ACMD42)命令断开 。DAT1 脚在 SDIO 模式下，一旦没有数据传输，可能被用于输出中断(从卡到主机);DAT2 脚在 SDIO 模式下，可能被用于“读等待信号”;</li>
</ol>
<ul>
<li>硬件原理图</li>
</ul>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/readme.assets/image-20240802174438586.png" alt="image-20240802174438586"></p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/readme.assets/image-20240802174446590.png" alt="image-20240802174446590"></p>
<ol start="8">
<li>每个卡都有一组信息寄存器</li>
</ol>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/readme.assets/image-20240803093934996.png" alt="image-20240803093934996"></p>
<ol start="9">
<li>主机可以通过切换电源开关来实现卡的复位。但是每个卡都有自己的电源检测电路，用来在上电后将卡设置到一个预置状态，所以重启电源并不是必须的，通过发送 GO_IDLE(CMD0)同样可以让卡复位。</li>
</ol>
<h3 id="SD命令"><a href="#SD命令" class="headerlink" title="SD命令"></a>SD命令</h3><blockquote>
<p>查看 &lt;&lt;PhysicalLayerSimplifiedSpecificationVersion9.10&gt;&gt; 4.7.4 Detailed Command Description</p>
</blockquote>
<h4 id="命令类型"><a href="#命令类型" class="headerlink" title="命令类型"></a>命令类型</h4><p>Sd 卡定义了 4 种命令类型：</p>
<ul>
<li>广播命令(bc)，无响应 — 广播命令只有当所有的 CMD 线都一起连到主机上时才会 用。如果是分开的，</li>
</ul>
<p>那么每张卡单独处理命令。</p>
<ul>
<li>广播命令，带响应(bcr) — 所有卡同时响应，既然 SD 卡没有开漏模式，这种命令 应该是所有的命令</li>
</ul>
<p>线都是分开的，命令也会每张卡分开接收和响应。</p>
<ul>
<li>寻址命令(ac，点对点) — 没有数据在 DAT 线上</li>
<li>寻址数据传输命令(adtc) — 有数据在 DAT 线上</li>
</ul>
<p>所有命令和响应都是通过SD卡的CMD线发送的。命令的发送总是从最左边的那一位开始。</p>
<h3 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h3><p>所有的响应都是通过 CMD 线发送的。响应总是从 bit 串最左边的 bit 开始发送，对应响 应码。响应的长度取决于响应的类型。</p>
<p>响应总是以开始位开始(0)，跟着是传输方向(card&#x3D;0)。下表中用 x 代替的表明是可变 的。除了 R3 类型之外，所有响应都用CRC7来保护。所有命令以结束位结束(1)。</p>
<p>SD 卡有 5 中响应类型。SDIO 卡支持增加的 R4，R5 类型的响应。</p>
<ul>
<li>R1(正常响应命令)</li>
<li>R1b:R1b 就是 R1 响应命令，同时数据线上有 busy 信号。卡在收到这些命令后可能会变为 busy。主机应该在响应中检查busy。</li>
<li>R2:作为 CMD2 和 CMD10 的响应发送。CSD 寄存器的内容 作为 CMD9 的响应发送。</li>
<li>R3:R3 作为 ACMD41 的响应发送。</li>
<li>R6:发布的 RCA 寄存器响应</li>
<li>R7:长度 48bit。卡支持的电压信息通过 CMD8 的响应发送。Bit[19:16]表明卡支持的电压范围。卡接受提供的电压范围就返回 R7 响应。卡会在响应的参数中返回电压范围和检查模式</li>
</ul>
<h3 id="超时时间"><a href="#超时时间" class="headerlink" title="超时时间"></a>超时时间</h3><ol>
<li>读:对于标准卡来说，读操作的超时时间是100倍的标准访问时间或者是100ms(取较小的)。 读访问时间是 CSD 的参数 TAAC 和 NSAC 的和(见 5.3)。如果是单独的读操作，这些卡的参数定义了</li>
</ol>
<p>读命令的结束位和数据块的起始位之间的延时。如果是多块的读操作，他们也定义了 块与块之间的标准延迟。对于高容量卡（SDHC&#x2F;SDXC）来说，TAAC和 NSAC是写死的值。主机应该使用100ms(最小)作</p>
<p>为超时时间， 而不是使用 TAAC 和 NSAC 的和。</p>
<ol start="2">
<li>写:对于标准卡来说，超时时间应该是100倍的标准操作时间，或者是250ms(取较小的)。CSD中的R2W_FACTOR区域用来指示标准的操作时间，这个值乘以读访问时间就是写访问时</li>
</ol>
<p>间。所有的写操作都是这个时间(SET(CLR)_WRITE_PROTECT，PROGRAM_CSD，以及块读命令)。</p>
<ul>
<li><p>对于高容量卡（SDHC&#x2F;SDXC）来说，R2W_FACTOR也是一个写死的值。所有写操作 Busy的最大值是250ms。</p>
</li>
<li><p>对于 SDXC SDUC卡，卡应尝试维持写操作的 busy 不超过 250ms；如果卡不能在 250ms 内维持 busy，那么卡可以将以下情况中写操作 busy（包括单块和多块写）变为最大 500ms：</p>
<ol>
<li>任何写操作（包括单块和多块写）的最后一次 busy 最大 500ms</li>
<li>当多块写操作被 CMD12 终止，CMD12 响应中的 busy 最大 500ms</li>
<li>当多块写操作被 CMD23 中断，最后一个数据块之后的 busy 最大 500ms</li>
<li>多块写操作中各数据块边界 busy 最大 250ms，除非以下情况：当卡执行连续的 2 块写操作（2*512Bytes）,并且跨越了物理块边界，则每块的 busy 最大 500ms</li>
</ol>
</li>
</ul>
<ol start="3">
<li>擦除: 如果卡在SD状态支持擦除超时参数，主机应该使用他们来确定擦除超时(见4.10.2)。 如果卡不支持这些参数，擦除超时可以通过块写操作延迟来估算。擦除命令的持续时间，可以通过写的块的数目(WTITE_BL)来估算，乘以 250ms 就行</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">voidmmcsd_set_data_timeout(<span class="keyword">struct</span> rt_mmcsd_data       *data,</span><br><span class="line"></span><br><span class="line">                            conststruct rt_mmcsd_card *card)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * SD cards use a 100 multiplier rather than 10</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    mult = (card-&gt;card_type == CARD_TYPE_SD) ? <span class="number">100</span> : <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * Scale up the multiplier (and therefore the timeout) by</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * the r2w factor for writes.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data-&gt;flags &amp; DATA_DIR_WRITE)</span><br><span class="line"></span><br><span class="line">        mult &lt;&lt;= card-&gt;csd.r2w_factor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    data-&gt;timeout_ns = card-&gt;tacc_ns * mult;</span><br><span class="line"></span><br><span class="line">    data-&gt;timeout_clks = card-&gt;tacc_clks * mult;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * SD cards also have an upper limit on the timeout.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (card-&gt;card_type == CARD_TYPE_SD)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">rt_uint32_t</span> timeout_us, limit_us;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        timeout_us = data-&gt;timeout_ns / <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        timeout_us += data-&gt;timeout_clks * <span class="number">1000</span> /</span><br><span class="line"></span><br><span class="line">                      (card-&gt;host-&gt;io_cfg.clock / <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (data-&gt;flags &amp; DATA_DIR_WRITE)</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             * The limit is really 250 ms, but that is</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             * insufficient for some crappy cards.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            limit_us = <span class="number">300000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">            limit_us = <span class="number">100000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         * SDHC cards always use these fixed values.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (timeout_us &gt; limit_us || card-&gt;flags &amp; CARD_FLAG_SDHC)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            data-&gt;timeout_ns = limit_us * <span class="number">1000</span>; <span class="comment">/* SDHC card fixed 250ms */</span></span><br><span class="line"></span><br><span class="line">            data-&gt;timeout_clks = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="mmcsd-core"><a href="#mmcsd-core" class="headerlink" title="mmcsd_core"></a>mmcsd_core</h2><h3 id="rt-mmcsd-core-init"><a href="#rt-mmcsd-core-init" class="headerlink" title="rt_mmcsd_core_init"></a>rt_mmcsd_core_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">intrt_mmcsd_core_init(<span class="type">void</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">rt_err_t</span> ret;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* initialize mailbox and create detect SD card thread */</span></span><br><span class="line"></span><br><span class="line">    ret = rt_mb_init(&amp;mmcsd_detect_mb, <span class="string">&quot;mmcsdmb&quot;</span>,</span><br><span class="line"></span><br><span class="line">                     &amp;mmcsd_detect_mb_pool[<span class="number">0</span>], <span class="keyword">sizeof</span>(mmcsd_detect_mb_pool) / <span class="keyword">sizeof</span>(mmcsd_detect_mb_pool[<span class="number">0</span>]),</span><br><span class="line"></span><br><span class="line">                     RT_IPC_FLAG_FIFO);</span><br><span class="line"></span><br><span class="line">    RT_ASSERT(ret == RT_EOK);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ret = rt_mb_init(&amp;mmcsd_hotpluge_mb, <span class="string">&quot;mmcsdhotplugmb&quot;</span>,</span><br><span class="line"></span><br><span class="line">                     &amp;mmcsd_hotpluge_mb_pool[<span class="number">0</span>], <span class="keyword">sizeof</span>(mmcsd_hotpluge_mb_pool) / <span class="keyword">sizeof</span>(mmcsd_hotpluge_mb_pool[<span class="number">0</span>]),</span><br><span class="line"></span><br><span class="line">                     RT_IPC_FLAG_FIFO);</span><br><span class="line"></span><br><span class="line">    RT_ASSERT(ret == RT_EOK);</span><br><span class="line"></span><br><span class="line">    ret = rt_thread_init(&amp;mmcsd_detect_thread, <span class="string">&quot;mmcsd_detect&quot;</span>, mmcsd_detect, RT_NULL,</span><br><span class="line"></span><br><span class="line">                         &amp;mmcsd_stack[<span class="number">0</span>], RT_MMCSD_STACK_SIZE, RT_MMCSD_THREAD_PREORITY, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret == RT_EOK)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        rt_thread_startup(&amp;mmcsd_detect_thread);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mmcsd-host-init"><a href="#mmcsd-host-init" class="headerlink" title="mmcsd_host_init"></a>mmcsd_host_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">voidmmcsd_host_init(<span class="keyword">struct</span> rt_mmcsd_host *host)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    rt_memset(host, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> rt_mmcsd_host));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strncpy</span>(host-&gt;name, <span class="string">&quot;sd&quot;</span>, <span class="keyword">sizeof</span>(host-&gt;name) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    host-&gt;max_seg_size = <span class="number">65535</span>;</span><br><span class="line"></span><br><span class="line">    host-&gt;max_dma_segs = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    host-&gt;max_blk_size = <span class="number">512</span>;</span><br><span class="line"></span><br><span class="line">    host-&gt;max_blk_count = <span class="number">4096</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    rt_mutex_init(&amp;host-&gt;bus_lock, <span class="string">&quot;sd_bus_lock&quot;</span>, RT_IPC_FLAG_FIFO);</span><br><span class="line"></span><br><span class="line">    rt_sem_init(&amp;host-&gt;sem_ack, <span class="string">&quot;sd_ack&quot;</span>, <span class="number">0</span>, RT_IPC_FLAG_FIFO);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> rt_mmcsd_host *<span class="title function_">mmcsd_alloc_host</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_mmcsd_host</span> *<span class="title">host</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    host = rt_malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> rt_mmcsd_host));</span><br><span class="line"></span><br><span class="line">    mmcsd_host_init(host);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> host;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mmcsd-power-up"><a href="#mmcsd-power-up" class="headerlink" title="mmcsd_power_up"></a>mmcsd_power_up</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticvoidmmcsd_power_up(<span class="keyword">struct</span> rt_mmcsd_host *host)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//找到最大的支持电压</span></span><br><span class="line"></span><br><span class="line">    host-&gt;io_cfg.vdd = __rt_fls(host-&gt;valid_ocr) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置位宽为1,执行上电配置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* SD 总线允许数据线的动态配置。上电后，SD 卡默认只使用 DAT0 来传输数据。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    初始化之 后，主机可以改变总线宽度(使用的数据线数目)。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    这个功能允许硬件成本和系统性能之间的简单交换。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    注意：当 DAT1-DAT3 没有使用的时候，相关的主机 DAT 先应该被设置为输入模式。SDIO 卡 DAT1 和 DAT2 用于信令。 */</span></span><br><span class="line"></span><br><span class="line">    host-&gt;io_cfg.power_mode = MMCSD_POWER_UP;</span><br><span class="line"></span><br><span class="line">    host-&gt;io_cfg.bus_width = MMCSD_BUS_WIDTH_1;</span><br><span class="line"></span><br><span class="line">    mmcsd_set_iocfg(host);<span class="comment">//rthw_sdio_iocfg</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * This delay should be sufficient to allow the power supply</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * to reach the minimum voltage.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    rt_thread_mdelay(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 卡初始化的时候，会有一个默认的相对地址(RCA=0x000)，和一个默认的在 400KHz 时钟频率下的驱动强度。</span></span><br><span class="line"></span><br><span class="line">    host-&gt;io_cfg.clock = host-&gt;freq_min;</span><br><span class="line"></span><br><span class="line">    host-&gt;io_cfg.power_mode = MMCSD_POWER_ON;</span><br><span class="line"></span><br><span class="line">    mmcsd_set_iocfg(host);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mmcsd-detect-检测线程"><a href="#mmcsd-detect-检测线程" class="headerlink" title="mmcsd_detect 检测线程"></a>mmcsd_detect 检测线程</h3><ol>
<li>检测线程通过 <code>mmcsd_detect_mb</code>邮箱接收到 <code>host</code>后,进行SD卡的检测</li>
<li>如果 <code>host-&gt;card</code>为空,则进行SD卡的检测,否则进行SD卡的移除</li>
<li>检查到SD卡后发送 <code>mmcsd_hotpluge_mb</code>邮箱,移除SD卡后发送 <code>mmcsd_hotpluge_mb</code>邮箱</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">voidmmcsd_detect(<span class="type">void</span> *param)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_mmcsd_host</span> *<span class="title">host</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">rt_uint32_t</span>  ocr;</span><br><span class="line"></span><br><span class="line">    <span class="type">rt_int32_t</span>  err;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rt_mb_recv(&amp;mmcsd_detect_mb, (<span class="type">rt_ubase_t</span> *)&amp;host, RT_WAITING_FOREVER) == RT_EOK)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (host-&gt;card == RT_NULL)</span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                mmcsd_host_lock(host);</span><br><span class="line"></span><br><span class="line">                mmcsd_power_up(host);   <span class="comment">//SD卡上电</span></span><br><span class="line"></span><br><span class="line">                mmcsd_go_idle(host);    <span class="comment">//SD卡复位</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                mmcsd_send_if_cond(host, host-&gt;valid_ocr);<span class="comment">//发送CMD8,检测是否为V2.0 SD卡</span></span><br><span class="line"></span><br><span class="line">                err = sdio_io_send_op_cond(host, <span class="number">0</span>, &amp;ocr);<span class="comment">//发送CMD5,检测是否为SDIO卡</span></span><br><span class="line"></span><br><span class="line">                err = mmcsd_send_app_op_cond(host, <span class="number">0</span>, &amp;ocr);<span class="comment">//发送ACMD41,检测是否为SD卡,仅获取电压信息</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!err)</span><br><span class="line"></span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (init_sd(host, ocr))                 <span class="comment">//初始化SD卡,根据分区表注册块设备</span></span><br><span class="line"></span><br><span class="line">                        mmcsd_power_off(host);</span><br><span class="line"></span><br><span class="line">                    mmcsd_host_unlock(host);</span><br><span class="line"></span><br><span class="line">                    rt_mb_send(&amp;mmcsd_hotpluge_mb, (<span class="type">rt_ubase_t</span>)host);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                err = mmc_send_op_cond(host, <span class="number">0</span>, &amp;ocr);<span class="comment">//发送CMD1,检测是否为MMC卡</span></span><br><span class="line"></span><br><span class="line">                mmcsd_host_unlock(host);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* card removed */</span></span><br><span class="line"></span><br><span class="line">                mmcsd_host_lock(host);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (host-&gt;card-&gt;sdio_function_num != <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    LOG_W(<span class="string">&quot;unsupport sdio card plug out!&quot;</span>);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    rt_mmcsd_blk_remove(host-&gt;card);</span><br><span class="line"></span><br><span class="line">                    rt_free(host-&gt;card);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    host-&gt;card = RT_NULL;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mmcsd_host_unlock(host);</span><br><span class="line"></span><br><span class="line">                rt_mb_send(&amp;mmcsd_hotpluge_mb, (<span class="type">rt_ubase_t</span>)host);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mmcsd-select-card"><a href="#mmcsd-select-card" class="headerlink" title="mmcsd_select_card"></a>mmcsd_select_card</h3><ul>
<li>CMD7 的作用是 选择一张卡，然后把它切换到传输模式，每次只能有一张卡处于传输模式。如果一张处于传 输模式的卡同主机的连接被释放，那么它会回到“Stand-by”状态。当 CMD7 带着参数RCA&#x3D;0x0000 发送的时候，所有的卡都会回到“Stand-by”状态(注意：发送 RCA&#x3D;0 来取消卡选择是主机的责任-参考表 4-22，CMD7)</li>
<li>重要注意：如果某些卡收到 CMD7(带有不匹配的 RCA)，卡会被取消选择。如果选择到另一张卡并且命令线是通用的，这个会自动发生。因此，在 SD 卡系统中，以通用命令线进行工作(初始化完成后)也是主机的责任，在这种情况下卡的取消选择会自动完成，如果命令线 是单独的，那么主机应该做必要的事情来取消对卡选择</li>
<li>这个命令在“stand-by”和“transfer”[15:0]填充位 (已选 状态之间使用，以及“programming”定卡) 和“disconnect”状态之间使用。在这两种情况下，地址匹配就被选中，不匹配就被取消选中。address 0，取消所有卡的选中。当 RCA&#x3D;0 时，主机可能做下面的事情：-使用其他的 RCA 号来取消卡-重新发送 CMD3 来改变卡的 RCA 号，使它不为 0。然后在用 RCA&#x3D;0 来取消选择。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticrt_int32_t_mmcsd_select_card(<span class="keyword">struct</span> rt_mmcsd_host *host,</span><br><span class="line"></span><br><span class="line">                                     <span class="keyword">struct</span> rt_mmcsd_card *card)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">rt_int32_t</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_mmcsd_cmd</span> <span class="title">cmd</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    rt_memset(&amp;cmd, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> rt_mmcsd_cmd));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    cmd.cmd_code = SELECT_CARD;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (card)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        cmd.arg = card-&gt;rca &lt;&lt; <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">        cmd.flags = RESP_R1 | CMD_AC;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*address 0，取消所有卡的选中。当 RCA=0 时，主机可能做下面的事情：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        -使用其他的 RCA 号来取消卡</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        -重新发送 CMD3 来改变卡的 RCA 号， 使它不为 0。然后在用 RCA=0 来取消选择。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        cmd.arg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        cmd.flags = RESP_NONE | CMD_AC;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    err = mmcsd_send_cmd(host, &amp;cmd, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mmcsd-all-get-cid"><a href="#mmcsd-all-get-cid" class="headerlink" title="mmcsd_all_get_cid"></a>mmcsd_all_get_cid</h3><ul>
<li>在系统中 ，主机遵照相同 的初始化顺序来 初始化所有的新卡。不兼容的卡会进入“Inactive”状态。主机接着就会发送命令 ALL_SEND_CID(CMD2)给每一个卡，来得到他们的 CID号。未识别的卡(处于Ready 状态的)发送自己的 CID 作为响应。当卡发送了 CID 之后，它就进入“Identification”状态。</li>
<li>通过R2响应获取CID信息</li>
<li>卡识别(CID)寄存器是一个 128 位的寄存器。包含了卡的识别信息，用于卡识别解析。每个读&#x2F;写卡都有一个特殊的识别号。</li>
</ul>
<p>| 名称 | 区域 | 宽度 | CID 位 |</p>
<p>| —- | —- | —- | —— |</p>
<p>| 制造商 ID | MID | 8 |[127:120] |</p>
<p>|OEM&#x2F;应用 ID | OID  | 16 | [119:104]    |</p>
<p>|产品名称   | PNM   | 40 | [103:64] |</p>
<p>|产品版本   | PRV   | 8  |  [63:56] |</p>
<p>|产品序列号 | PSN   | 32 |  [55:24] |</p>
<p>|保留       | –    | 4  |  [23:20] |</p>
<p>|生产日期   | MDT   | 12 |  [19:8]  |</p>
<p>|CRC7校验码 | CRC |  7   |  [7:1]   |</p>
<p>|不使用，总是 1 | –    |1|[0:0]|</p>
<p>● MID</p>
<p>8bit的二进制数，表示卡的制造商。MID号，由SD-3C，LLC来控制、定义、以及分配给 SD卡制造商。这个程序是用来保证CID寄存器的唯一性。</p>
<ul>
<li>OID</li>
</ul>
<p>2 个字符的 ASCII 码，表明卡的 OEM 和&#x2F;或者卡的内容(当用于分发媒体的时候)。OID 同样是由 SD-3C，LLC 来控制、定义和分配的。也是为了保证 CID 的唯一性注：SD-3C，LLC授权给厂家来生产或者销售SD 卡，包含但不限于 Flash存储，ROM，OTP，RAM 和 SDIO 卡。SD-3C，ALL 是由松下电子工业，SanDisk 公司和东芝公司成立的有限责任公司。</p>
<ul>
<li>PNM</li>
</ul>
<p>产品名称，5 个字符的 ASCII 码</p>
<ul>
<li>PRV</li>
</ul>
<p>产品版本，由两个十进制数组成，每个数 4 个 bit，“n.m”，n 表示大版本号，m 表示小版本号。比如，产品版本号是“6.2”，那么 PRV &#x3D;“0110 0010b”</p>
<ul>
<li>PSN</li>
</ul>
<p>序列号，32位二进制数</p>
<ul>
<li>MDT</li>
</ul>
<p>制造日期由两个 16 进制数组成，一个是 8bit 的年(y)，一个是 4bit 的月(m)。m&#x3D;bit[11:8]，1&#x3D; 1 月。n&#x3D;bit[19:12]，0&#x3D;2000;比如 2001 年 4 月，MDT&#x3D;“0000 0001 0100”</p>
<ul>
<li>CRC</li>
</ul>
<p>7 位 CRC 校验码，CID 内容的校验码</p>
<p>The SD Card I’m testing on is a 32 GB SDHC card from SanDisk with a speed class of 10 MB&#x2F;s.</p>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/readme.assets/sdcard.jpg" alt="img"></p>
<p>This card responds to CMD8 and therefore supports V2.X of the SD protocol.</p>
<p>Additionally, it responds with CCS set (&#x3D; SDHC).</p>
<p>The CID 035344534333324780B90C4E7F0138 is decoded as follows:</p>
<p>| field | value      | interpretation |</p>
<p>| —– | ———- | ————– |</p>
<p>| MID   | 03         | SanDisk        |</p>
<p>| OID   | 5344       | SD             |</p>
<p>| PNM   | 5343333247 | SC32G          |</p>
<p>| PRV   | 80         | 8.0            |</p>
<p>| PSN   | B90C4E7F   | Serial Number  |</p>
<p>| MDT   | 138        | August 2019    |</p>
<p>The CSD 400E00325B590000EDC87F800A4040 is decoded as follows:</p>
<p>| field                  | value | interpretation                 |</p>
<p>| —–                  | ——| ————–                 |</p>
<p>| CSD_STRUCTURE         |    01 | SDHC                           |</p>
<p>| (TAAC)                 |    0E | 1.0 ms                         |</p>
<p>| (NSAC)                 |    00 | 0 clocks                       |</p>
<p>| (TRAN_SPEED)          |    32 | 25 Mb&#x2F;s                        |</p>
<p>| CCC                    |   5B5 | 0, 2, 4, 5, 7, 8, 10           |</p>
<p>| (READ_BL_LEN)        |     9 | 512 bytes                      |</p>
<p>| (READ_BL_PARTIAL)    |     0 | No                             |</p>
<p>| (WRITE_BLK_MISALIGN) |     0 | No                             |</p>
<p>| (READ_BLK_MISALIGN)  |     0 | No                             |</p>
<p>| DSR_IMP               |     0 | DSR not implemented            |</p>
<p>| C_SIZE                |  EDC8 | 31 GB                          |</p>
<p>| (ERASE_BLK_EN)       |     1 | Yes                            |</p>
<p>| (SECTOR_SIZE)         |    7F | 64 kB                          |</p>
<p>| (WP_GRP_SIZE)        |    00 | 1 sector                       |</p>
<p>| (WP_GRP_ENABLE)      |     0 | No                             |</p>
<p>| (R2W_FACTOR)          |     2 | factor 4                       |</p>
<p>| (WRITE_BL_LEN)       |     9 | 512 bytes                      |</p>
<p>| (WRITE_BL_PARTIAL)   |     0 | No                             |</p>
<p>| (FILE_FORMAT_GRP)    |     0 | File format group              |</p>
<p>| COPY                   |     1 | copy flag                      |</p>
<p>| PERM_WRITE_PROTECT   |     0 | No                             |</p>
<p>| TMP_WRITE_PROTECT    |     0 | No                             |</p>
<p>| (FILE_FORMAT)         |     0 | Hard disk with partition table |</p>
<h3 id="mmcsd-wait-cd-changed"><a href="#mmcsd-wait-cd-changed" class="headerlink" title="mmcsd_wait_cd_changed"></a>mmcsd_wait_cd_changed</h3><ol>
<li>阻塞检测拔插事件</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">intmmcsd_wait_cd_changed(rt_int32_ttimeout)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_mmcsd_host</span> *<span class="title">host</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rt_mb_recv(&amp;mmcsd_hotpluge_mb, (<span class="type">rt_ubase_t</span> *)&amp;host, timeout) == RT_EOK)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (host-&gt;card == RT_NULL)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> MMCSD_HOST_UNPLUGED;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> MMCSD_HOST_PLUGED;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -RT_ETIMEOUT;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="sd卡"><a href="#sd卡" class="headerlink" title="sd卡"></a>sd卡</h2><h3 id="mmcsd-send-if-cond"><a href="#mmcsd-send-if-cond" class="headerlink" title="mmcsd_send_if_cond"></a>mmcsd_send_if_cond</h3><ul>
<li>SEND_IF_COND(CMD8)用于验证 SD 卡接口操作条件。卡会通过分析 CMD8 的参数来检测操作条件的正确性。而主机会通过分析 CMD8 的响应来检查正确性</li>
<li>SD 卡如果收到CMD8，就会知道主机支持V2.0，就可以使能新的功能。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rt_err_tmmcsd_send_if_cond(<span class="keyword">struct</span> rt_mmcsd_host *host, rt_uint32_tocr)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_mmcsd_cmd</span> <span class="title">cmd</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">rt_err_t</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="type">rt_uint8_t</span> pattern;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    cmd.cmd_code = SD_SEND_IF_COND;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ocr &amp; VDD_270_360)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        cmd.arg = <span class="number">1</span> &lt;&lt; <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        cmd.arg = <span class="number">2</span> &lt;&lt; <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmd.arg |= <span class="number">0xAA</span>;    <span class="comment">//检查模式</span></span><br><span class="line"></span><br><span class="line">    cmd.flags = RESP_SPI_R7 | RESP_R7 | CMD_BCR;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mmcsd-app-cmd"><a href="#mmcsd-app-cmd" class="headerlink" title="mmcsd_app_cmd"></a>mmcsd_app_cmd</h3><ul>
<li>特定应用命令—APP_CMD(CMD55)</li>
<li>当卡收到这个命令时，卡会把接下来的命令作为特定应用命令(ACMD)来解析，ACMD 命令和标准命令有着相同的结构，甚至相同的 CMD 号。只要一个命令跟在 CMD55 之后，卡就会</li>
</ul>
<p>把它当作 ACMD。APP_CMD 的唯一影响就是，如果紧跟着的命令序号有一个 ACMD 相对应，那么就会使用非常规(non-regular)的版本。比如，如果卡定义了 ACMD13，但是没有定义 ACMD7，那么对</p>
<p>于紧跟在 APP_CMD 命令后面的命令，CMD13 会被当作非常规的 ACMD13 执行，但是 CMD7 就只作为常规的CMD7来执行。</p>
<ul>
<li>要想使用特定厂家ACMD命令，主机需要按照以下流程：</li>
</ul>
<ol>
<li>当发送 APP_CMD 时，响应里有 APP_CMD位设置信号，告诉主机现在要接受 ACMD命令了。</li>
<li>ACMD55 不存在。如果多个 CMD55 被连续发送，那么每个响应的 APP_CMD位都会被设置为 1。最后一 个 CMD55 后面紧跟的命令会被当作 ACMD 命令。如果超过一个命令跟在 CMD55 后 (CMD55 除外)，只有第一个命令被当作 ACMD 命令。后面的都作为常规命令。</li>
<li>如果发送的 ACMD 是有定义的并且是合法的，则响应中有 APP_CMD 位，表明当前命令是 ACMD。</li>
<li>如果发送的 ACMD 是未定义的并且是合法的，则响应中 APP_CMD 位被清除，表明当前命令被当作普通 CMD。</li>
<li>如果发送的 ACMD 是有定义或者未定义的，并且是非法的，那么将被当作非法命令，非法命令 error 会在下一个 R1&#x2F;R6 响应中被置起，主机应忽略响应中的 APP_CMD 状态。下一个命令被当作普通命令。</li>
</ol>
<p>如果发送了一个无效命令，就会返回常规的命令错误。</p>
<ol start="6">
<li>从 SD 卡的协议来看，ACMD 号应该由厂家参照某些限制来定义。下面的 ACMD 是保留的，任何厂家都不应该使用它们：ACMD6,ACMD13，ACMD17-25，ACMD38-49，ACMD51。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rt_err_tmmcsd_send_app_cmd(<span class="keyword">struct</span> rt_mmcsd_host *host,</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">struct</span> rt_mmcsd_card *card,</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">struct</span> rt_mmcsd_cmd  *cmd,</span><br><span class="line"></span><br><span class="line">                            <span class="type">int</span>                   retry)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * We have to resend MMC_APP_CMD for each attempt so</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * we cannot use the retries field in mmc_command.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= retry; i++)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        err = mmcsd_app_cmd(host, card);</span><br><span class="line"></span><br><span class="line">        rt_memset(cmd-&gt;resp, <span class="number">0</span>, <span class="keyword">sizeof</span>(cmd-&gt;resp));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        req.cmd = cmd;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//cmd-&gt;data = NULL;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        mmcsd_send_request(host, &amp;req);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mmcsd-send-app-op-cond"><a href="#mmcsd-send-app-op-cond" class="headerlink" title="mmcsd_send_app_op_cond"></a>mmcsd_send_app_op_cond</h3><ul>
<li>如果参数中电压字段（bit23-0）被设为 0，称为“查询 ACMD41”，此时不能启动初始化。该配置被用来获取 OCR 寄存器。“查询 ACMD41”命令不关心参数的其他字段（bit31-24）.</li>
<li>如果参数中电压字段（bit23-0）第一次被设为非 0，称为“初始 ACMD41”,此时启动初始化，而参数中其他字段（bit31-24）是有效的。</li>
<li>卡初始化应该在第一个ACMD41 发出后 1 秒内完成。主机会在至少 1 秒时间内持续发送 ACMD41</li>
<li>注意：ACMD41 是应用特定命令，因此 APP_CMD(CMD55)应该永远在 ACMD41 之前发送。“idle”状态下用于 CMD55的 RCA 寄存器应该是默认的 RCA&#x3D;0x0000。</li>
</ul>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/readme.assets/image-20240803175747363.png" alt="image-20240803175747363"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rt_err_tmmcsd_send_app_op_cond(<span class="keyword">struct</span> rt_mmcsd_host *host,</span><br><span class="line"></span><br><span class="line">                                mmcsd_vdd_e           ocr,</span><br><span class="line"></span><br><span class="line">                                mmcsd_vdd_e          *rocr)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_mmcsd_cmd</span> <span class="title">cmd</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">rt_uint32_t</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="type">rt_err_t</span> err = RT_EOK;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    rt_memset(&amp;cmd, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> rt_mmcsd_cmd));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    cmd.cmd_code = SD_APP_OP_COND;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (controller_is_spi(host))</span><br><span class="line"></span><br><span class="line">        cmd.arg = ocr &amp; (<span class="number">1</span> &lt;&lt; <span class="number">30</span>); <span class="comment">/* SPI only defines one bit */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">        cmd.arg = ocr;</span><br><span class="line"></span><br><span class="line">    cmd.flags = RESP_SPI_R1 | RESP_R3 | CMD_BCR;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//卡初始化应该在第一个ACMD41 发出后 1 秒内完成。主机会在至少 1 秒时间内持续发送 ACMD41</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1000</span>; i; i--)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送APP_CMD命令</span></span><br><span class="line"></span><br><span class="line">        err = mmcsd_send_app_cmd(host, RT_NULL, &amp;cmd, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* if we&#x27;re just probing, do a single pass */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ocr == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* otherwise wait until reset completes */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (controller_is_spi(host))</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!(cmd.resp[<span class="number">0</span>] &amp; R1_SPI_IDLE))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmd.resp[<span class="number">0</span>] &amp; CARD_BUSY)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        err = -RT_ETIMEOUT;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        rt_thread_mdelay(<span class="number">10</span>); <span class="comment">//delay 10ms</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rocr &amp;&amp; !controller_is_spi(host))</span><br><span class="line"></span><br><span class="line">        *rocr = cmd.resp[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mmcsd-get-card-addr"><a href="#mmcsd-get-card-addr" class="headerlink" title="mmcsd_get_card_addr"></a>mmcsd_get_card_addr</h3><ul>
<li>卡识别模式 在复位后，查找总线上的新卡的时候，主机会处于“卡识别模式”。卡在复位后会处于识别模式，直到收到 SEND_RCA(CMD3)命令.</li>
<li>当卡发送了 CID 之后，它就进入“Identification”状态。之后主机发送 SEND_RELATIVE_ADDR(CMD3)命令，通知卡发布一个新的相对地址(RCA),这个地址比 CID 短，用于作为将来数据传输模式的地址。一旦收到RCA，卡就会变为“Stand-by”状态。这时，如果主机想要分配另一个 RCA 号，它可以再发送一个 CMD3，通知卡重新发布一个 RCA 号。最后一个产生的 RCA 才是有效的。主机会重复识别进程，为系统中的每个卡循环发送“CMD2”和“CMD3”。</li>
</ul>
<h3 id="mmcsd-get-csd"><a href="#mmcsd-get-csd" class="headerlink" title="mmcsd_get_csd"></a>mmcsd_get_csd</h3><ul>
<li>主机发送命令SEND_CSD(CMD9)来获得“卡具体数据(Card Specific Data)”，比如“块长度”，“存储容量”数据传输模式所有状态等。</li>
<li>SD协议版本1.0~3.0;SDHC&#x2F;SDXC协议版本2.0;SDUC协议版本3.0;容量有所不同,具体查看CSD Register</li>
</ul>
<h3 id="mmcsd-get-scr"><a href="#mmcsd-get-scr" class="headerlink" title="mmcsd_get_scr"></a>mmcsd_get_scr</h3><ul>
<li>读取配置寄存器SCR</li>
<li>作为 CSD 寄存器的补充，另一个配置寄存器称为 SD 卡配置寄存器(SCR)。SCR 提供了 SD 卡的特殊功能的信息。SCR是一个 64bit 的寄存器，这个寄存器应该由 SD 厂家设置。</li>
</ul>
<p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/readme.assets/image-20240804151512865.png" alt="image-20240804151512865"></p>
<h3 id="mmcsd-app-set-bus-width"><a href="#mmcsd-app-set-bus-width" class="headerlink" title="mmcsd_app_set_bus_width"></a>mmcsd_app_set_bus_width</h3><ul>
<li>宽总线(4Bit宽)操作模式可以通过命令ACMD6来选定和取消。上电或者GO_IDLE(CMD0)命令后，默认的总线宽度是1Bit.</li>
<li>如果想要改变总线宽度，需要具备下面两个条件:</li>
</ul>
<ol>
<li>卡处于 transfer 状态</li>
<li>卡没有被锁定 (锁定的卡会认为 ACMD6 是无效命令)</li>
</ol>
<ul>
<li>定义数据总线的宽度(‘00’&#x3D;1bit，‘10’&#x3D;4bit)。接受的数据总线定义在SCR寄存器中。</li>
</ul>
<h3 id="mmcsd-read-sd-status"><a href="#mmcsd-read-sd-status" class="headerlink" title="mmcsd_read_sd_status"></a>mmcsd_read_sd_status</h3><ul>
<li>SD状态包含了与 sd卡属性功能相关的状态位，可能会用于将来特定的应用命令。SD状态的大小是一个512bit的数据块。这个寄存器的内容会通过DAT总线传递给主机，CRC16。</li>
</ul>
<p>SD 状态会通过 DAT 总线发送给主机，作为 ACMD13(前面是 CMD55)的响应。ACMD13 只能在“transfer”模式发送给已选定的卡。</p>
<h3 id="mmcsd-switch"><a href="#mmcsd-switch" class="headerlink" title="mmcsd_switch"></a>mmcsd_switch</h3><ul>
<li>切换命令(CMD6)①用于切换或扩展存储卡功能。现在定义了四种功能组：</li>
</ul>
<ol>
<li>访问模式：S D 总线接口速度模式的选择</li>
<li>命令系统：通过一套共有的命令来扩展和控制特定的功能</li>
<li>驱动强度：在 U H S - I 模式下选择合适的输出驱动强度，取决于主机环境</li>
<li>电流&#x2F;功率限制：U H S - I 卡在 U H S - I 模式下最大电流的选择，取决于主机电源能力和散热能力（h e a t r e l e a s e）。这个字段在 U H S - I I卡中被重新定义为功率限制，因为 UHS - I I 卡具有两种电源电压。这个是从V1.1版本开始定义的。因此之前的版本不支持这个命令。在发送CMD6之前，主机应该检查SCR寄存器的“SD_SPEC”区域来检查卡支持的版本。也可以检查 CSD 中的CCC bit10 来确认是否支持 CMD6。 V1.1之后的版本是强制 要求支持这个命令的</li>
</ol>
<ul>
<li>CMD6 只在“transfer”模式下有效。CMD6 是 SD 卡用的，SDIO 使用 CCCR 来切换功能</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[31]模式0:查询，1:切换</span><br><span class="line"></span><br><span class="line">[30:24]保留，全 0</span><br><span class="line"></span><br><span class="line">[23:20]保留给组 6(0h 或 Fh)</span><br><span class="line"></span><br><span class="line">[19:16]保留给组 5</span><br><span class="line"></span><br><span class="line">[15:12]保留给组 4</span><br><span class="line"></span><br><span class="line">[11:8]保留给组 3</span><br><span class="line"></span><br><span class="line">[7:4] 功能组 2-命令系统</span><br><span class="line"></span><br><span class="line">[3:0] 功能组 1-访问模式</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticrt_int32_tmmcsd_switch(<span class="keyword">struct</span> rt_mmcsd_card *card)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    buf = (<span class="type">rt_uint8_t</span>*)rt_malloc(<span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SD卡才支持CMD6</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (card-&gt;card_type != CARD_TYPE_SD)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//V1.1之后的版本是强制要求支持这个命令的</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (card-&gt;scr.sd_version &lt; SCR_SPEC_VER_1)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询命令,组1:访问模式 功能1: 高速/SDR25</span></span><br><span class="line"></span><br><span class="line">    cmd.arg = <span class="number">0x00FFFFF1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//切换命令,组1:访问模式</span></span><br><span class="line"></span><br><span class="line">    cmd.arg = <span class="number">0x80FFFFF0</span> | switch_func_timing;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mmcsd-sd-init-card"><a href="#mmcsd-sd-init-card" class="headerlink" title="mmcsd_sd_init_card"></a>mmcsd_sd_init_card</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticrt_int32_tmmcsd_sd_init_card(<span class="keyword">struct</span> rt_mmcsd_host *host,</span><br><span class="line"></span><br><span class="line">                                     mmcsd_vdd_e           ocr)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    mmcsd_go_idle(host);                            <span class="comment">//SD卡复位</span></span><br><span class="line"></span><br><span class="line">    mmcsd_send_if_cond(host, ocr);            <span class="comment">//发送CMD8,检测是否为V2.0 SD卡</span></span><br><span class="line"></span><br><span class="line">    mmcsd_send_app_op_cond(host, ocr, &amp;ocr);  <span class="comment">//发送ACMD41,设置电压</span></span><br><span class="line"></span><br><span class="line">    mmcsd_all_get_cid(host, resp);            <span class="comment">//获取CID信息</span></span><br><span class="line"></span><br><span class="line">    mmcsd_get_card_addr(host, &amp;card-&gt;rca);    <span class="comment">//获取RCA</span></span><br><span class="line"></span><br><span class="line">    mmcsd_get_csd(host, &amp;card-&gt;csd);          <span class="comment">//获取CSD信息</span></span><br><span class="line"></span><br><span class="line">    mmcsd_parse_csd(card);                    <span class="comment">//解析CSD信息</span></span><br><span class="line"></span><br><span class="line">    mmcsd_select_card(card);                  <span class="comment">//选择卡,进入传输模式</span></span><br><span class="line"></span><br><span class="line">    mmcsd_get_scr(card, card-&gt;resp_scr);      <span class="comment">//获取SCR信息</span></span><br><span class="line"></span><br><span class="line">    mmcsd_set_timing(host, card);             <span class="comment">//设置时序</span></span><br><span class="line"></span><br><span class="line">    mmcsd_set_clock(host, <span class="number">25000000</span>);          <span class="comment">//设置时钟频率</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*switch bus width*/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((host-&gt;flags &amp; MMCSD_BUSWIDTH_4) &amp;&amp; (card-&gt;scr.sd_bus_widths &amp; SD_SCR_BUS_WIDTH_4))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送ACMD6,设置总线宽度</span></span><br><span class="line"></span><br><span class="line">        err = mmcsd_app_set_bus_width(card, MMCSD_BUS_WIDTH_4);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//修改主机总线宽度</span></span><br><span class="line"></span><br><span class="line">        mmcsd_set_bus_width(host, MMCSD_BUS_WIDTH_4);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Read and decode SD Status and check whether UHS mode is supported */</span></span><br><span class="line"></span><br><span class="line">    err = mmcsd_read_sd_status(card, sd_status.status_words);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * change SD card to the highest supported speed</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    err = mmcsd_switch(card);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="init-sd"><a href="#init-sd" class="headerlink" title="init_sd"></a>init_sd</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rt_int32_tinit_sd(<span class="keyword">struct</span> rt_mmcsd_host *host, mmcsd_vdd_e ocr)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    current_ocr = mmcsd_select_voltage(host, ocr);  <span class="comment">//设置电压</span></span><br><span class="line"></span><br><span class="line">    err = mmcsd_sd_init_card(host, current_ocr);    <span class="comment">//初始化SD卡,发送命令执行流程</span></span><br><span class="line"></span><br><span class="line">    err = rt_mmcsd_blk_probe(host-&gt;card);           <span class="comment">//识别块设备与分区,注册块设备</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="block设备"><a href="#block设备" class="headerlink" title="block设备"></a>block设备</h2><h3 id="rt-mmcsd-blk-probe"><a href="#rt-mmcsd-blk-probe" class="headerlink" title="rt_mmcsd_blk_probe"></a>rt_mmcsd_blk_probe</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rt_int32_trt_mmcsd_blk_probe(<span class="keyword">struct</span> rt_mmcsd_card *card)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    LOG_D(<span class="string">&quot;probe mmcsd block device!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (check_gpt(card) != <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据分区执行设备注册</span></span><br><span class="line"></span><br><span class="line">        err = gpt_device_probe(card);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据分区执行设备注册</span></span><br><span class="line"></span><br><span class="line">        err = mbr_device_probe(card);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="find-valid-gpt"><a href="#find-valid-gpt" class="headerlink" title="find_valid_gpt"></a>find_valid_gpt</h3><ul>
<li>检测是否具mbr分区,且分区内容是什么</li>
</ul>
<h3 id="read-lba"><a href="#read-lba" class="headerlink" title="read_lba"></a>read_lba</h3><ul>
<li>读取LBA数据块</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rt_int32_tread_lba(<span class="keyword">struct</span> rt_mmcsd_card *card, size_tlba, <span class="type">uint8_t</span> *buffer, size_tcount)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">rt_uint8_t</span> status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    status = mmcsd_set_blksize(card);   <span class="comment">//设置数据块大小512Byte</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rt_thread_mdelay(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    status = rt_mmcsd_req_blk(card, lba, buffer, count, <span class="number">0</span>); <span class="comment">//发送读命令</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mmcsd-set-blksize"><a href="#mmcsd-set-blksize" class="headerlink" title="mmcsd_set_blksize"></a>mmcsd_set_blksize</h3><ul>
<li>如果是标准 SD 卡，数据块的长度是 CMD16 中定义的BLOCK_LEN。如 果是高容量卡，数据块的大小固定为 512Byte。</li>
</ul>
<h3 id="rt-mmcsd-req-blk"><a href="#rt-mmcsd-req-blk" class="headerlink" title="rt_mmcsd_req_blk"></a>rt_mmcsd_req_blk</h3><ul>
<li>READ_SINGLE_BLOCK(CMD17)代表读取一个块的内容，传输结束后，回到 transfer 状态。READ_MULTIPLE_BLOCK(CMD18) 代 表 读 取 多 个 连 续 的 块 。 块 会 连 续 的 传 输 ， 直 到STOP_TRANSMISSON(CMD12)命令发出。因为连续数据传输，停止命令会有些执行延迟。数据 传输会在停止命令的结束位发送之后停止。当 CMD18 读取最后一个块的用户区时，应忽略 OUT_OF_RANGE 错误，该情况下即使序列是正确的，这种错误也可能会发生。</li>
<li>命令参数:SDHC 和 SDXC 卡中，内容访问命令的32bit参数，使用块地址格式。不论 CMD16 怎么设置，块长度都固定为512Byte。 SDSC 中，内容访问命令的32bit参数使用的是字节</li>
</ul>
<p>地址格式。块长度由CMD16决定。(a) SDSC 卡的 0001h 参数表示字节地址 0001h，SDHC&#x2F;SDXC 卡表示第 0001h 个block(b) SDSC 卡的 0200h 参数表示字节地址 0200h，SDHC&#x2F;SDXC 卡表示第 0200h 个</p>
<p>block</p>
<ol>
<li>从 <code>sector</code>执行读取或写入;根据 <code>blks</code>判断是否为多块读写,根据 <code>dir</code>判断读写,根据 <code>card-&gt;flags</code>判断是否为SDHC卡</li>
<li>如果是多块读写,则需要发送 <code>STOP_TRANSMISSION</code>命令</li>
<li>因为连续数据传输，停止命令会有些执行延迟,所以需要等待停止命令结束</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticrt_err_trt_mmcsd_req_blk(<span class="keyword">struct</span> rt_mmcsd_card *card,</span><br><span class="line"></span><br><span class="line">                                 <span class="type">rt_uint32_t</span>           sector,</span><br><span class="line"></span><br><span class="line">                                 <span class="type">void</span>                 *buf,</span><br><span class="line"></span><br><span class="line">                                 <span class="type">rt_size_t</span>             blks,</span><br><span class="line"></span><br><span class="line">                                 <span class="type">rt_uint8_t</span>            dir)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    cmd.arg = sector;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(card-&gt;flags &amp; CARD_FLAG_SDHC))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        cmd.arg &lt;&lt;= <span class="number">9</span>;<span class="comment">//*512</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (blks &gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!controller_is_spi(card-&gt;host) || !dir)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            req.stop = &amp;stop;</span><br><span class="line"></span><br><span class="line">            stop.cmd_code = STOP_TRANSMISSION;</span><br><span class="line"></span><br><span class="line">            stop.arg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            stop.flags = RESP_SPI_R1B | RESP_R1B | CMD_AC;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r_cmd = READ_MULTIPLE_BLOCK;</span><br><span class="line"></span><br><span class="line">        w_cmd = WRITE_MULTIPLE_BLOCK;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        req.stop = RT_NULL;</span><br><span class="line"></span><br><span class="line">        r_cmd = READ_SINGLE_BLOCK;</span><br><span class="line"></span><br><span class="line">        w_cmd = WRITE_BLOCK;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!controller_is_spi(card-&gt;host) &amp;&amp; (card-&gt;flags &amp; <span class="number">0x8000</span>))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* last request is WRITE,need check busy */</span></span><br><span class="line"></span><br><span class="line">        card_busy_detect(card, <span class="number">10000</span>, RT_NULL);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!dir)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        cmd.cmd_code = r_cmd;</span><br><span class="line"></span><br><span class="line">        data.flags |= DATA_DIR_READ;</span><br><span class="line"></span><br><span class="line">        card-&gt;flags &amp;= <span class="number">0x7fff</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        cmd.cmd_code = w_cmd;</span><br><span class="line"></span><br><span class="line">        data.flags |= DATA_DIR_WRITE;</span><br><span class="line"></span><br><span class="line">        card-&gt;flags |= <span class="number">0x8000</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mbr-device-probe"><a href="#mbr-device-probe" class="headerlink" title="mbr_device_probe"></a>mbr_device_probe</h3><ol>
<li>根据mbr分区表,获取分区信息,并为每个分区注册块设备</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">rt_int32_tmbr_device_probe(<span class="keyword">struct</span> rt_mmcsd_card *card)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    status = rt_mmcsd_req_blk(card, <span class="number">0</span>, sector, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    blk_dev-&gt;part.lock = rt_sem_create(sname, <span class="number">1</span>, RT_IPC_FLAG_FIFO);</span><br><span class="line"></span><br><span class="line">    blk_dev-&gt;dev.init = rt_mmcsd_init;</span><br><span class="line"></span><br><span class="line">    blk_dev-&gt;dev.open = rt_mmcsd_open;</span><br><span class="line"></span><br><span class="line">    blk_dev-&gt;dev.close = rt_mmcsd_close;</span><br><span class="line"></span><br><span class="line">    blk_dev-&gt;dev.read = rt_mmcsd_read;</span><br><span class="line"></span><br><span class="line">    blk_dev-&gt;dev.write = rt_mmcsd_write;</span><br><span class="line"></span><br><span class="line">    blk_dev-&gt;dev.control = rt_mmcsd_control;</span><br><span class="line"></span><br><span class="line">    blk_dev-&gt;card = card;</span><br><span class="line"></span><br><span class="line">    blk_dev-&gt;dev.user_data = blk_dev;</span><br><span class="line"></span><br><span class="line">    rt_device_register(&amp;(blk_dev-&gt;dev), card-&gt;host-&gt;name,</span><br><span class="line"></span><br><span class="line">                        RT_DEVICE_FLAG_RDWR);</span><br><span class="line"></span><br><span class="line">    rt_list_insert_after(&amp;blk_devices, &amp;blk_dev-&gt;<span class="built_in">list</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; RT_MMCSD_MAX_PARTITION; i++)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        blk_dev = rt_calloc(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mmcsd_blk_device));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* get the first partition */</span></span><br><span class="line"></span><br><span class="line">        status = dfs_filesystem_get_partition(&amp;blk_dev-&gt;part, sector, i);</span><br><span class="line"></span><br><span class="line">        blk_dev-&gt;part.lock = rt_sem_create(sname, <span class="number">1</span>, RT_IPC_FLAG_FIFO);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="stm32-sdmmc"><a href="#stm32-sdmmc" class="headerlink" title="stm32 sdmmc"></a>stm32 sdmmc</h2><h3 id="rt-hw-sdio-init"><a href="#rt-hw-sdio-init" class="headerlink" title="rt_hw_sdio_init"></a>rt_hw_sdio_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">|   drv_sdmmc.c                     ||  mmcsd_core.c    |</span><br><span class="line"></span><br><span class="line">rt_hw_sdio_init -&gt; sdio_host_create -&gt; mmcsd_alloc_host(分配host空间并初始化配置)</span><br><span class="line"></span><br><span class="line">                                    -&gt; mmcsd_change(发送检测邮箱)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">intrt_hw_sdio_init(<span class="type">void</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stm32_sdio_des</span> <span class="title">sdio_des1</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    sdio_des1.hw_sdio.Instance = SDMMC1;</span><br><span class="line"></span><br><span class="line">    HAL_SD_MspInit(&amp;sdio_des1.hw_sdio);</span><br><span class="line"></span><br><span class="line">    HAL_NVIC_SetPriority(SDMMC1_IRQn, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    HAL_NVIC_EnableIRQ(SDMMC1_IRQn);</span><br><span class="line"></span><br><span class="line">    sdio_des1.clk_get  = stm32_sdio_clock_get;</span><br><span class="line"></span><br><span class="line">    host1 = sdio_host_create(&amp;sdio_des1);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> rt_mmcsd_host *<span class="title function_">sdio_host_create</span><span class="params">(<span class="keyword">struct</span> stm32_sdio_des *sdio_des)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    host = mmcsd_alloc_host();</span><br><span class="line"></span><br><span class="line">    rt_event_init(&amp;sdio-&gt;event, <span class="string">&quot;sdio&quot;</span>, RT_IPC_FLAG_FIFO);</span><br><span class="line"></span><br><span class="line">    rt_mutex_init(&amp;sdio-&gt;mutex, <span class="string">&quot;sdio&quot;</span>, RT_IPC_FLAG_PRIO);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    rthw_sdio_irq_update(host, RT_TRUE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ready to change */</span></span><br><span class="line"></span><br><span class="line">    mmcsd_change(host);<span class="comment">//rt_mb_send(&amp;mmcsd_detect_mb, (rt_ubase_t)host);</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">INIT_PREV_EXPORT(rt_mmcsd_core_init);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="rthw-sdio-iocfg"><a href="#rthw-sdio-iocfg" class="headerlink" title="rthw_sdio_iocfg"></a>rthw_sdio_iocfg</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticvoidrthw_sdio_iocfg(<span class="keyword">struct</span> rt_mmcsd_host *host, <span class="keyword">struct</span> rt_mmcsd_io_cfg *io_cfg)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算clk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算bus_width</span></span><br><span class="line"></span><br><span class="line">    (<span class="type">void</span>)SDMMC_Init(hsd-&gt;Instance, Init);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//控制power</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="rthw-sdio-request"><a href="#rthw-sdio-request" class="headerlink" title="rthw_sdio_request"></a>rthw_sdio_request</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticvoidrthw_sdio_request(<span class="keyword">struct</span> rt_mmcsd_host *host, <span class="keyword">struct</span> rt_mmcsd_req *req)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sdio_pkg</span> <span class="title">pkg</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rthw_sdio</span> *<span class="title">sdio</span> =</span> host-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_mmcsd_data</span> *<span class="title">data</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    RTHW_SDIO_LOCK(sdio);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (req-&gt;cmd != RT_NULL)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        rthw_sdio_send_command(sdio, &amp;pkg);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (req-&gt;stop != RT_NULL)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        rthw_sdio_send_command(sdio, &amp;pkg);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RTHW_SDIO_UNLOCK(sdio);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mmcsd_req_complete(sdio-&gt;host);<span class="comment">//    rt_sem_release(&amp;host-&gt;sem_ack);</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="rthw-sdio-send-command"><a href="#rthw-sdio-send-command" class="headerlink" title="rthw_sdio_send_command"></a>rthw_sdio_send_command</h3><ol>
<li>使用中断方式;有 <code>data</code>通过 <code>IDMA</code>发送,有 <code>cmd</code>直接发送;<code>rthw_sdio_wait_completed</code>等待事件完成</li>
<li>中断触发后通过事件将状态数据传到线程中;进行数据获取与错误处理</li>
</ol>
<h2 id="file-system"><a href="#file-system" class="headerlink" title="file system"></a>file system</h2><h3 id="sd-mount"><a href="#sd-mount" class="headerlink" title="sd_mount"></a>sd_mount</h3><ol>
<li>创建线程执行SD卡检测,以完成挂载与卸载</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticvoidsd_mount(<span class="type">void</span> *parameter)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">rt_uint8_t</span> re_sd_check_pin = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    rt_thread_mdelay(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rt_pin_read(SD_CHECK_PIN))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        _sdcard_mount();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        rt_thread_mdelay(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!re_sd_check_pin &amp;&amp; (re_sd_check_pin = rt_pin_read(SD_CHECK_PIN)) != <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            _sdcard_mount();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (re_sd_check_pin &amp;&amp; (re_sd_check_pin = rt_pin_read(SD_CHECK_PIN)) == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            _sdcard_unmount();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="sdcard-mount"><a href="#sdcard-mount" class="headerlink" title="_sdcard_mount"></a>_sdcard_mount</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticvoid_sdcard_mount(<span class="type">void</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">rt_device_t</span> device;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    device = rt_device_find(<span class="string">&quot;sd&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (device == <span class="literal">NULL</span>)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        sdcard_change();    <span class="comment">//发送要求mmcsd检测线程执行检测程序</span></span><br><span class="line"></span><br><span class="line">        mmcsd_wait_cd_changed(RT_WAITING_FOREVER);<span class="comment">//阻塞等待检测结果</span></span><br><span class="line"></span><br><span class="line">        device = rt_device_find(<span class="string">&quot;sd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (device != RT_NULL)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">rt_err_t</span> ret = RT_EOK;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dfs_mount(<span class="string">&quot;sd0&quot;</span>, <span class="string">&quot;/sdcard&quot;</span>, <span class="string">&quot;elm&quot;</span>, <span class="number">0</span>, <span class="number">0</span>) == RT_EOK)</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            LOG_I(<span class="string">&quot;sd card mount to &#x27;/sdcard&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            dfs_mkfs(<span class="string">&quot;elm&quot;</span>, <span class="string">&quot;sd0&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dfs_mount(<span class="string">&quot;sd0&quot;</span>, <span class="string">&quot;/sdcard&quot;</span>, <span class="string">&quot;elm&quot;</span>, <span class="number">0</span>, <span class="number">0</span>) == RT_EOK)</span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                LOG_I(<span class="string">&quot;sd card mkfs to &#x27;/sdcard&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                LOG_W(<span class="string">&quot;sd card mount to &#x27;/sdcard&#x27; failed!&quot;</span>);</span><br><span class="line"></span><br><span class="line">                ret = -RT_ERROR;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="sdcard-unmount"><a href="#sdcard-unmount" class="headerlink" title="_sdcard_unmount"></a>_sdcard_unmount</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticvoid_sdcard_unmount(<span class="type">void</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    rt_thread_mdelay(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">    dfs_unmount(<span class="string">&quot;/sdcard&quot;</span>);</span><br><span class="line"></span><br><span class="line">    LOG_I(<span class="string">&quot;Unmount \&quot;/sdcard\&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mmcsd_wait_cd_changed(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    sdcard_change();</span><br><span class="line"></span><br><span class="line">    mmcsd_wait_cd_changed(RT_WAITING_FOREVER);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="rt-mmcsd-control"><a href="#rt-mmcsd-control" class="headerlink" title="rt_mmcsd_control"></a>rt_mmcsd_control</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * block device geometry structure</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rt_device_blk_geometry</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">rt_uint64_t</span> sector_count;                           <span class="comment">/**&lt; count of sectors */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">rt_uint32_t</span> bytes_per_sector;                       <span class="comment">/**&lt; number of bytes per sector */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">rt_uint32_t</span> block_size;                             <span class="comment">/**&lt; number of bytes to erase one block */</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">staticrt_err_trt_mmcsd_control(rt_device_tdev, intcmd, <span class="type">void</span> *args)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mmcsd_blk_device</span> *<span class="title">blk_dev</span> =</span> (<span class="keyword">struct</span> mmcsd_blk_device *)dev-&gt;user_data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> RT_DEVICE_CTRL_BLK_GETGEOME:</span><br><span class="line"></span><br><span class="line">        rt_memcpy(args, &amp;blk_dev-&gt;geometry, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> rt_device_blk_geometry));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> RT_DEVICE_CTRL_BLK_PARTITION:</span><br><span class="line"></span><br><span class="line">        rt_memcpy(args, &amp;blk_dev-&gt;part, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> dfs_partition));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> RT_DEVICE_CTRL_BLK_SSIZEGET:</span><br><span class="line"></span><br><span class="line">        rt_memcpy(args, &amp;blk_dev-&gt;geometry.bytes_per_sector, <span class="keyword">sizeof</span>(<span class="type">rt_uint32_t</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> RT_DEVICE_CTRL_ALL_BLK_SSIZEGET:</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">rt_uint64_t</span> count_mul_per = blk_dev-&gt;geometry.bytes_per_sector * blk_dev-&gt;geometry.sector_count;</span><br><span class="line"></span><br><span class="line">        rt_memcpy(args, &amp;count_mul_per, <span class="keyword">sizeof</span>(<span class="type">rt_uint64_t</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RT_EOK;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="rt-mmcsd-read"><a href="#rt-mmcsd-read" class="headerlink" title="rt_mmcsd_read"></a>rt_mmcsd_read</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticrt_ssize_trt_mmcsd_read(rt_device_tdev,</span><br><span class="line"></span><br><span class="line">                               <span class="type">rt_off_t</span>    pos,</span><br><span class="line"></span><br><span class="line">                               <span class="type">void</span>       *buffer,</span><br><span class="line"></span><br><span class="line">                               <span class="type">rt_size_t</span>   size)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    rt_sem_take(part-&gt;lock, RT_WAITING_FOREVER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每次传输一次允许的块大小</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (remain_size)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        req_size = (remain_size &gt; blk_dev-&gt;max_req_size) ? blk_dev-&gt;max_req_size : remain_size;</span><br><span class="line"></span><br><span class="line">        err = rt_mmcsd_req_blk(blk_dev-&gt;card, part-&gt;offset + pos + offset, rd_ptr, req_size, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        offset += req_size;</span><br><span class="line"></span><br><span class="line">        rd_ptr = (<span class="type">void</span> *)((<span class="type">rt_uint8_t</span> *)rd_ptr + (req_size &lt;&lt; <span class="number">9</span>));</span><br><span class="line"></span><br><span class="line">        remain_size -= req_size;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rt_sem_release(part-&gt;lock);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="rt-mmcsd-write"><a href="#rt-mmcsd-write" class="headerlink" title="rt_mmcsd_write"></a>rt_mmcsd_write</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticrt_ssize_trt_mmcsd_write(rt_device_tdev,</span><br><span class="line"></span><br><span class="line">                                <span class="type">rt_off_t</span>    pos,</span><br><span class="line"></span><br><span class="line">                                constvoid *buffer,</span><br><span class="line"></span><br><span class="line">                                <span class="type">rt_size_t</span>   size)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    rt_sem_take(part-&gt;lock, RT_WAITING_FOREVER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (remain_size)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        req_size = (remain_size &gt; blk_dev-&gt;max_req_size) ? blk_dev-&gt;max_req_size : remain_size;</span><br><span class="line"></span><br><span class="line">        err = rt_mmcsd_req_blk(blk_dev-&gt;card, part-&gt;offset + pos + offset, wr_ptr, req_size, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        offset += req_size;</span><br><span class="line"></span><br><span class="line">        wr_ptr = (<span class="type">void</span> *)((<span class="type">rt_uint8_t</span> *)wr_ptr + (req_size &lt;&lt; <span class="number">9</span>));</span><br><span class="line"></span><br><span class="line">        remain_size -= req_size;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rt_sem_release(part-&gt;lock);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wdfk-prog">Liya Huang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wdfk-prog.space/posts/7fa7b29d/">https://wdfk-prog.space/posts/7fa7b29d/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://wdfk-prog.space" target="_blank">wdfk-prog的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/rt-thread/">rt-thread</a></div><div class="post-share"><div class="social-share" data-image="/images/covers/09.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/images/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/images/alipay.png" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/alipay.png" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/9997c49a/" title="dataqueue"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/03.jpg" onerror="onerror=null;src='/images/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">dataqueue</div></div><div class="info-2"><div class="info-item-1">dataqueue消息队列：消息队列能够接收来自线程或中断服务例程中不固定长度的消息，并把消息缓存在自己的内存空间中。其他线程也能够从消息队列中读取相应的消息，而当消息队列是空的时候，可以挂起读取线程。当有新的消息到达时，挂起的线程将被唤醒以接收并处理消息。消息队列是一种异步的通信方式。(摘自 RT-Thread文档中心). 数据队列：没有找到官方详细的说明，只是在 RT-Thread API参考手册,有介绍。数据队列能够接收来自线程中不固定长度的数据，数据 不会 缓存在自己的内存空间中，自己的内存空间只有一个指向这包数据的指针。其他线程也能够从数据队列获取数据，当数据队列为空的时候，可以挂起线程。当有新的数据到达时，挂起的线程将被唤醒以接收并处理消息。数据队列是一种异步的通信方式。 消息队列 是用于线程消息传递的，属于线程间同步异步 IPC；消息队列在 recv 数据之后，这组数据就没了。 数据队列 更多的使用在流式数据传递，属于线程间通信 IPC；数据队列可以使用 peak 的方式 舔一下 这组数据不会丢失。自带高、低水位，可以对锯齿速度(压入数据的间隔不一致，时快时慢的)情...</div></div></div></a><a class="pagination-related" href="/posts/38d6377e/" title="completion"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/10.jpg" onerror="onerror=null;src='/images/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">completion</div></div><div class="info-2"><div class="info-item-1">completion completion 可以称之为完成量，是一种轻量级的线程间（IPC）同步机制 完成量和信号量对比  信号量是一种非常灵活的同步方式，可以运用在多种场合中。形成锁、同步、资源计数等关系，也能方便的用于线程与线程、中断与线程间的同步中。 完成量，是一种更加轻型的线程间同步的一种实现，可以理解为轻量级的二值信号，可以用于线程和线程间同步，也可以用于线程和中断之间的同步。 完成量不支持在某个线程中调用 rt_completion_wait，还未唤醒退出时，在另一个线程中调用该函数。 注意：当完成量应用于线程和中断之间的同步时，中断函数中只能调用 rt_completion_done 接口，而不能调用 rt_completion_wait 接口，因为 wait 接口是阻塞型接口，不可以在中断函数中调用 12345678910111213141516171819202122232425262728/** * Completion - A tiny &amp; rapid IPC primitive for resource-constrained scenarios ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/fa99c9bd/" title="fatfs"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/06.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">fatfs</div></div><div class="info-2"><div class="info-item-1">fatfs[TOC] 硬盘的物理结构：概述 盘片（platter） 磁头（head） 磁道（track） 扇区（sector） 柱面（cylinder）  盘片 片面 和 磁头硬盘中一般会有多个盘片组成，每个盘片包含两个面，每个盘面都对应地有一个读&#x2F;写磁头。受到硬盘整体体积和生产成本的限制，盘片数量都受到限制，一般都在5片以内。盘片的编号自下向上从0开始，如最下边的盘片有0面和1面，再上一个盘片就编号为2面和3面。如下图：  图1 扇区 和 磁道下图显示的是一个盘面，盘面中一圈圈灰色同心圆为一条条磁道，从圆心向外画直线，可以将磁道划分为若干个弧段，每个磁道上一个弧段被称之为一个扇区（图中绿色部分），对于老式磁盘，每个扇区存储容量是相同的（也就是每个磁道的容量是相同的，但不同磁道的数据密度是不同的，半径越小的磁道的密度越大，这个是怎么做到的，还不清楚，但我个人猜测是因为旋转角度，转动相同的角度，外部扇区移动的距离更长，而内部扇区移动距离短，就是通过磁头每次移动是固定角度的，但由于磁臂的长度不同，分别对应不同的磁道，那对于外围的扇区，由于磁臂较长，每次移动固定角度，则划过的...</div></div></div></a><a class="pagination-related" href="/posts/fa82c01a/" title="RT-Thread 学习笔记"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/09.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">RT-Thread 学习笔记</div></div><div class="info-2"><div class="info-item-1">RT-Thread 学习笔记  其他资料   1.1. fatfs 1.1.1. fatfs.md     2. ARM指针寄存器.md 3. CAN驱动.md 4. completion.md 5. condvar.md 6. dataqueue.md 7. DFS.md 8. fal.md 9. fatfs.md 10. FINSH模块.md 11. I2C驱动.md 12. IDLE线程.md 13. IPC.md 14. littlefs.md 15. map文件分析.md 16. pipe.md 17. PM电源管理.md 18. readme.md 19. ringblock.md 20. ringbuffer.md 21. romfs.md 22. RTC.md 23. RT-LINK.md 24. RTT系统初始化.md 25. SDMMC.md 26. SIGNAL.md 27. SPI驱动.md 28. tmpfs.md 29. ULOG.md 30. USB.md 31. waitqueue.md 32. 串口驱动.md 33. 调度.md 34. 工作队列...</div></div></div></a><a class="pagination-related" href="/posts/427ac97f/" title="map文件分析"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/09.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">map文件分析</div></div><div class="info-2"><div class="info-item-1">map文件分析1234567891011121314151617181920212223242526272829303132333435363738394041424344454647Image$$ER_IROM1$$Base                    0x90000000   Number         0  anon$$obj.o ABSOLUTE__Vectors                                0x90000000   Data           4  startup_stm32h750xx.o(RESET)__Vectors_End                            0x90000298   Data           0  startup_stm32h750xx.o(RESET)__main                                   0x90000299   Thumb Code     0  entry.o(.ARM.Collect$$$$00000000)_main_st...</div></div></div></a><a class="pagination-related" href="/posts/1f9a630e/" title="pipe"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/10.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">pipe</div></div><div class="info-2"><div class="info-item-1">pipepipe： 匿名管道。pipe 是一种 IPC 机制，他的作用是用作有血缘进程间完成数据传递，只能从一端写入，从另外一端读出。为了解决 pipe 的弊端，linux 又引入了 mkfifo(实名管道)。 创建管道12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455rt_pipe_t *rt_pipe_create(constchar *name, intbufsz)&#123;    //分配管道内存,初始化锁,初始化等待队列,初始化条件变量    rt_mutex_init(&amp;pipe-&gt;lock, name, RT_IPC_FLAG_FIFO);    rt_wqueue_init(&amp;pipe-&gt;reader_queue);    rt_wqueue_init(&amp;pipe-&gt;writer_queue);    rt_condvar_init(&amp;pipe-&gt;waitf...</div></div></div></a><a class="pagination-related" href="/posts/a5eec7a4/" title="littlefs"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/08.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">littlefs</div></div><div class="info-2"><div class="info-item-1">littlefs123456789101112131415161718192021// Users can override lfs_util.h with their own configuration by defining// LFS_CONFIG as a header file to include (-DLFS_CONFIG=lfs_config.h).//// If LFS_CONFIG is used, none of the default utils will be emitted and must be// provided by the config file. To start, I would suggest copying lfs_util.h// and modifying as needed.#ifdef LFS_CONFIG#define LFS_STRINGIZE(x) LFS_STRINGIZE2(x)#define LFS_STRINGIZE2(x) #x#include LFS_STRINGIZE(LFS_CONFIG)  机制 断电恢...</div></div></div></a><a class="pagination-related" href="/posts/7cb92c08/" title="ringblock"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/01.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">ringblock</div></div><div class="info-2"><div class="info-item-1">环形缓冲块 ringblock环形块状缓冲区简称为：rbb。与传统的环形缓冲区不同的是，rbb 是一个由很多不定长度的块组成的环形缓冲区，而传统的环形缓冲区是由很多个单字节的 char 组成。rbb 支持 零字节拷贝 。所以 rbb 非常适合用于生产者顺序 put 数据块，消费者顺序 get 数据块的场景，例如：DMA 传输，通信帧的接收与发送等等 ringblk: 是由 多个不同长度 的 block 组成的，ringbuff : 是由单字节的数据组成的。ringblk 每一个 block 有多少个字节可以由用户自己设定。 ringblk 支持零字节拷贝(不需要额外的 memcpy 操作)。所以 rbb 非常适合用于生产者顺序 put 数据块，消费者顺序 get 数据块的场景，例如：DMA 传输，通信帧的接收与发送等等。 初始化 初始化块链表和释放链表 对每一个块链表进行初始化,并插入到释放链表中  PUT &amp; GET 块 put  123block-&gt;status = RT_RBB_BLK_PUT;   get   判断块链表为空,则返回NULL 遍历链表,找到具...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/avatar.png" onerror="this.onerror=null;this.src='/images/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Liya Huang</div><div class="author-info-description">WORK-LIFE BALANCE</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">414</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">49</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">53</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wdfk-prog"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/wdfk-prog" rel="external nofollow noreferrer" target="_blank" title="GitHub"><i class="fab fa-github" style="color: #181717;"></i></a><a class="social-icon" href="https://wdfk-prog.blog.csdn.net/" rel="external nofollow noreferrer" target="_blank" title="CSDN"><i class="fas fa-blog" style="color: #FC5531;"></i></a><a class="social-icon" href="mailto:1425075683@qq.com" rel="external nofollow noreferrer" target="_blank" title="E-mail"><i class="fas fa-envelope" style="color: #4A4A4A;"></i></a><a class="social-icon" href="/images/wechat-qrcode.jpg" target="_blank" title="微信公众号"><i class="fab fa-weixin" style="color: #07C160;"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #EE802F;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎光临！有任何问题或想法，欢迎在文章下留言交流，或者通过 <a href='/about/'>关于页面</a> 联系我。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SDMMC"><span class="toc-number">1.</span> <span class="toc-text">SDMMC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SD-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.1.</span> <span class="toc-text">SD 协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SD%E6%80%BB%E7%BA%BF"><span class="toc-number">1.1.1.</span> <span class="toc-text">SD总线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SD%E5%91%BD%E4%BB%A4"><span class="toc-number">1.1.2.</span> <span class="toc-text">SD命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">命令类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94"><span class="toc-number">1.1.3.</span> <span class="toc-text">响应</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="toc-number">1.1.4.</span> <span class="toc-text">超时时间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mmcsd-core"><span class="toc-number">1.2.</span> <span class="toc-text">mmcsd_core</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rt-mmcsd-core-init"><span class="toc-number">1.2.1.</span> <span class="toc-text">rt_mmcsd_core_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-host-init"><span class="toc-number">1.2.2.</span> <span class="toc-text">mmcsd_host_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-power-up"><span class="toc-number">1.2.3.</span> <span class="toc-text">mmcsd_power_up</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-detect-%E6%A3%80%E6%B5%8B%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.2.4.</span> <span class="toc-text">mmcsd_detect 检测线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-select-card"><span class="toc-number">1.2.5.</span> <span class="toc-text">mmcsd_select_card</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-all-get-cid"><span class="toc-number">1.2.6.</span> <span class="toc-text">mmcsd_all_get_cid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-wait-cd-changed"><span class="toc-number">1.2.7.</span> <span class="toc-text">mmcsd_wait_cd_changed</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sd%E5%8D%A1"><span class="toc-number">1.3.</span> <span class="toc-text">sd卡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-send-if-cond"><span class="toc-number">1.3.1.</span> <span class="toc-text">mmcsd_send_if_cond</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-app-cmd"><span class="toc-number">1.3.2.</span> <span class="toc-text">mmcsd_app_cmd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-send-app-op-cond"><span class="toc-number">1.3.3.</span> <span class="toc-text">mmcsd_send_app_op_cond</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-get-card-addr"><span class="toc-number">1.3.4.</span> <span class="toc-text">mmcsd_get_card_addr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-get-csd"><span class="toc-number">1.3.5.</span> <span class="toc-text">mmcsd_get_csd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-get-scr"><span class="toc-number">1.3.6.</span> <span class="toc-text">mmcsd_get_scr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-app-set-bus-width"><span class="toc-number">1.3.7.</span> <span class="toc-text">mmcsd_app_set_bus_width</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-read-sd-status"><span class="toc-number">1.3.8.</span> <span class="toc-text">mmcsd_read_sd_status</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-switch"><span class="toc-number">1.3.9.</span> <span class="toc-text">mmcsd_switch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-sd-init-card"><span class="toc-number">1.3.10.</span> <span class="toc-text">mmcsd_sd_init_card</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#init-sd"><span class="toc-number">1.3.11.</span> <span class="toc-text">init_sd</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#block%E8%AE%BE%E5%A4%87"><span class="toc-number">1.4.</span> <span class="toc-text">block设备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rt-mmcsd-blk-probe"><span class="toc-number">1.4.1.</span> <span class="toc-text">rt_mmcsd_blk_probe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#find-valid-gpt"><span class="toc-number">1.4.2.</span> <span class="toc-text">find_valid_gpt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#read-lba"><span class="toc-number">1.4.3.</span> <span class="toc-text">read_lba</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmcsd-set-blksize"><span class="toc-number">1.4.4.</span> <span class="toc-text">mmcsd_set_blksize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rt-mmcsd-req-blk"><span class="toc-number">1.4.5.</span> <span class="toc-text">rt_mmcsd_req_blk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mbr-device-probe"><span class="toc-number">1.4.6.</span> <span class="toc-text">mbr_device_probe</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stm32-sdmmc"><span class="toc-number">1.5.</span> <span class="toc-text">stm32 sdmmc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rt-hw-sdio-init"><span class="toc-number">1.5.1.</span> <span class="toc-text">rt_hw_sdio_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rthw-sdio-iocfg"><span class="toc-number">1.5.2.</span> <span class="toc-text">rthw_sdio_iocfg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rthw-sdio-request"><span class="toc-number">1.5.3.</span> <span class="toc-text">rthw_sdio_request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rthw-sdio-send-command"><span class="toc-number">1.5.4.</span> <span class="toc-text">rthw_sdio_send_command</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#file-system"><span class="toc-number">1.6.</span> <span class="toc-text">file system</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sd-mount"><span class="toc-number">1.6.1.</span> <span class="toc-text">sd_mount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sdcard-mount"><span class="toc-number">1.6.2.</span> <span class="toc-text">_sdcard_mount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sdcard-unmount"><span class="toc-number">1.6.3.</span> <span class="toc-text">_sdcard_unmount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rt-mmcsd-control"><span class="toc-number">1.6.4.</span> <span class="toc-text">rt_mmcsd_control</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rt-mmcsd-read"><span class="toc-number">1.6.5.</span> <span class="toc-text">rt_mmcsd_read</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rt-mmcsd-write"><span class="toc-number">1.6.6.</span> <span class="toc-text">rt_mmcsd_write</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/1db9a982/" title="ext4"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/04.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="ext4"/></a><div class="content"><a class="title" href="/posts/1db9a982/" title="ext4">ext4</a><time datetime="2025-10-07T03:18:15.310Z" title="更新于 2025-10-07 11:18:15">2025-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b554c0f0/" title="mbcache"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/03.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="mbcache"/></a><div class="content"><a class="title" href="/posts/b554c0f0/" title="mbcache">mbcache</a><time datetime="2025-10-07T03:16:04.099Z" title="更新于 2025-10-07 11:16:04">2025-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/88ab2b13/" title="fs-writeback"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/08.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="fs-writeback"/></a><div class="content"><a class="title" href="/posts/88ab2b13/" title="fs-writeback">fs-writeback</a><time datetime="2025-10-07T03:08:29.811Z" title="更新于 2025-10-07 11:08:29">2025-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2089198e/" title="filesystems"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/03.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="filesystems"/></a><div class="content"><a class="title" href="/posts/2089198e/" title="filesystems">filesystems</a><time datetime="2025-10-07T02:52:10.933Z" title="更新于 2025-10-07 10:52:10">2025-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/933a291e/" title="hweight"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/10.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="hweight"/></a><div class="content"><a class="title" href="/posts/933a291e/" title="hweight">hweight</a><time datetime="2025-10-07T02:49:48.378Z" title="更新于 2025-10-07 10:49:48">2025-10-07</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/images/covers/09.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">文档</div><div class="footer-flex-content"><a href="/categories/linux/" target="_blank" title="🚀 linux">🚀 linux</a><a href="/categories/rt-thread/" target="_blank" title="📑 rt-thread">📑 rt-thread</a><a href="/categories/uboot/" target="_blank" title="📌 uboot">📌 uboot</a><a href="/categories/LoraWan/" target="_blank" title="⚔️ LoraWan">⚔️ LoraWan</a><a href="/categories/hpatch/" target="_blank" title="❓ hpatch">❓ hpatch</a><a href="/categories/git/" target="_blank" title="⚡️ git">⚡️ git</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/gallery/" target="_blank" title="图库">图库</a><a href="/messageboard/" target="_blank" title="留言板">留言板</a><a href="/shuoshuo/" target="_blank" title="说说">说说</a><a href="/link/" target="_blank" title="示例">示例</a><a href="/link/" target="_blank" title="友链">友链</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">框架</div><div class="footer-flex-content"><a href="https://hexo.io/zh-cn/" rel="external nofollow noreferrer" target="_blank" title="Hexo">Hexo</a><a href="https://butterfly.js.org/" rel="external nofollow noreferrer" target="_blank" title="Butterfly">Butterfly</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">贊助</div><div class="footer-flex-content"><div><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/alipay.png" alt='wdfk_prog' width='100px' height='100px'></div></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Liya Huang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 8.0.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.1</a></span></div><div class="footer_custom_text">你好，欢迎来到我的 <a href="/about/">数字花园</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天" style="display:none"><i class="fas fa-message"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script><script>(() => {
  const abcjsInit = () => {
    const abcjsFn = () => {
      setTimeout(() => {
        const sheets = document.querySelectorAll(".abc-music-sheet")
        for (let i = 0; i < sheets.length; i++) {
          const ele = sheets[i]
          if (ele.children.length > 0) continue

          // Parse parameters from data-params attribute
          let params = {}
          const dp = ele.getAttribute("data-params")
          if (dp) {
            try {
              params = JSON.parse(dp)
            } catch (e) {
              console.error("Failed to parse data-params:", e)
            }
          }

          // Merge parsed parameters with the responsive option
          // Ensures params content appears before responsive
          const options = { ...params, responsive: "resize" }

          // Render the music score using ABCJS.renderAbc
          ABCJS.renderAbc(ele, ele.innerHTML, options)
        }
      }, 100)
    }

    if (typeof ABCJS === "object") {
      abcjsFn()
    } else {
      btf.getScript("https://cdn.jsdelivr.net/npm/abcjs/dist/abcjs-basic-min.min.js").then(abcjsFn)
    }
  }

  if (window.pjax) {
    abcjsInit()
  } else {
    window.addEventListener("load", abcjsInit)
  }

  btf.addGlobalFn("encrypt", abcjsInit, "abcjs")
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: 'Ov23livBmwx65h3XIdfT',
      clientSecret: '9f23bdaa2ea11322f9f405d77bcdc27166077a7d',
      repo: 'wdfk-prog.github.io',
      owner: 'wdfk-prog',
      admin: ['wdfk-prog'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || '6fdce96dd8560d9f4bf8dc175832d842'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script>window.newestComments = {
  changeContent: content => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<code>.*?<\/code>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g, "") // remove html tag

    if (content.length > 150) {
      content = content.substring(0, 150) + '...'
    }
    return content
  },

  generateHtml: (array, ele) => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class="aside-list-item">'

        if (true && array[i].avatar) {
          const imgAttr = 'data-lazy-src'
          const lazyloadNative = ''
          result += `<a href="${array[i].url}" class="thumbnail"><img ${imgAttr}="${array[i].avatar}" alt="${array[i].nick}" ${lazyloadNative}></a>`
        }

        result += `<div class="content">
        <a class="comment" href="${array[i].url}" title="${array[i].content}">${array[i].content}</a>
        <div class="name"><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '暂无评论'
    }

    ele.innerHTML = result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh(ele)
  },

  newestCommentInit: (name, getComment) => {
    const $dom = document.querySelector('#card-newest-comments .aside-list')
    if ($dom) {
      const data = btf.saveToLocal.get(name)
      if (data) {
        newestComments.generateHtml(JSON.parse(data), $dom)
      } else {
        getComment($dom)
      }
    }
  },

  run: (name, getComment) => {
    newestComments.newestCommentInit(name, getComment)
    btf.addGlobalFn('pjaxComplete', () => newestComments.newestCommentInit(name, getComment), name)
  }
}</script><script>window.addEventListener('load', () => {
  const keyName = 'github-newest-comments'
  const { changeContent, generateHtml, run } = window.newestComments

  const findTrueUrl = (array, ele) => {
    Promise.all(array.map(item =>
      fetch(item.url).then(resp => resp.json()).then(data => {
        let urlArray = data.body ? data.body.match(/(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?/ig) : []
        if (!Array.isArray(urlArray) || urlArray.length === 0) {
          urlArray = [`${data.html_url}`]
        }
        if (data.user.login === 'utterances-bot') {
          return urlArray.pop()
        } else {
          return urlArray.shift()
        }
      })
    )).then(res => {
        array = array.map((i,index)=> {
          return {
            ...i,
            url: res[index]
          }
        })

        btf.saveToLocal.set(keyName, JSON.stringify(array), 10/(60*24))
        generateHtml(array, ele)
    });
  }

  const getComment = ele => {
    fetch('https://api.github.com/repos/wdfk-prog/wdfk-prog.github.io/issues/comments?sort=updated&direction=desc&per_page=6&page=1',{
      "headers": {
        Accept: 'application/vnd.github.v3.html+json'
      }
    })
      .then(response => response.json())
      .then(data => {
        const githubArray = data.map(item => {
          return {
            'avatar': item.user.avatar_url,
            'content': changeContent(item.body_html || item.body),
            'nick': item.user.login,
            'url': item.issue_url,
            'date': item.updated_at
          }
        })
        findTrueUrl(githubArray, ele)
      }).catch(e => {
        console.error(e)
        ele.textContent= "无法获取评论，请确认相关配置是否正确"
      })
  }
  run(keyName, getComment)
})</script><div class="aplayer no-destroy" data-id="60198" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false" data-volume="0.5"></div><script>
  var titleTime, OriginTitile = document.title;
  document.addEventListener("visibilitychange", function() {
    if (document.hidden) {
      titleTime = setTimeout(function() {
        document.title = "w(ﾟДﾟ)w 不要走！再看看嘛！";
      }, 300);
    } else {
      document.title = "♪(^∇^*)欢迎回来！" + OriginTitile;
      titleTime = setTimeout(function() {
        document.title = OriginTitile;
      }, 2000);
    }
  });
</script>
<script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script>(() => {
  window.ChatraID = '5cPWcnA8HKGzg5hoc'
  window.Chatra = window.Chatra || function() {
    (window.Chatra.q = window.Chatra.q || []).push(arguments)
  }

  btf.getScript('https://call.chatra.io/chatra.js').then(() => {
    const isChatBtn = true
    const isChatHideShow = true

    if (isChatBtn) {
      const close = () => {
        Chatra('minimizeWidget')
        Chatra('hide')
      }

      const open = () => {
        Chatra('openChat', true)
        Chatra('show')
      }

      window.ChatraSetup = { startHidden: true }
    
      window.chatBtnFn = () => document.getElementById('chatra').classList.contains('chatra--expanded') ? close() : open()

      document.getElementById('chat-btn').style.display = 'block'
    } else if (isChatHideShow) {
      window.chatBtn = {
        hide: () => Chatra('hide'),
        show: () => Chatra('show')
      }
    }
  })
})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: true,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      true
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MF3J339H" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript></div><script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const heatmapChartDom = document.getElementById('heatmapChart');
                if(heatmapChartDom){
                    const heatmapChart = echarts.init(heatmapChartDom, 'dark');
                    const cellSize = [18, 18];
                    
                    const groupByYear = (data) => {
                        const result = {};
                        data.forEach(([date, value]) => {
                            const [year] = date.split('-').map(Number);
                            if (!result[year]) {
                                result[year] = [];
                            }
                            result[year].push([date, value]);
                        });
                        return result;
                    };
                    
                    const groupedData = groupByYear([["2025-10-03",392],["2025-10-04",5],["2025-10-06",9],["2025-10-07",8]]);
                    const years = Object.keys(groupedData).reverse();
                    
                    var initYear = parseInt(heatmapChartDom.getAttribute('year')) || new Date().getFullYear();
                    const minYear = years[years.length - 1];
                    const maxYear = years[0];
                    if (initYear < minYear || initYear > maxYear) {
                        initYear = maxYear;
                    }
                    console.log('[hexo-graph]generateHeatmapChart|initYear:', initYear, 'minYear:', minYear, 'maxYear:', maxYear);
                    
                    heatmapChart.setOption({
                        grid: {},
                        tooltip: { 
                            position: 'top', 
                            formatter: params => `${params.value[0]}: ${params.value[1]} Articles` 
                        },
                        calendar: { 
                            top: '10%',
                            left: 'left', 
                            right: '8%',
                            range: initYear,
                            cellSize: cellSize, 
                            splitLine: { lineStyle: { color: '#E0E0E0', width: 1 } }, 
                            itemStyle: { borderWidth: 1, borderColor: '#E0E0E0' }, 
                            dayLabel: { show: false },
                            monthLabel: { show: true },
                            yearLabel: { show: false },
                        },
                        visualMap: { 
                            show: true,
                            right: '8%',
                            bottom: '5%',
                            type: 'piecewise',
                            orient: 'horizontal',
                            text: ['More', 'Less'],
                            min: 0,
                            max: Math.max(...groupedData[initYear].map(item => item[1])),
                            inRange: { color: ["#ACE7AE","#69C16D","#549F57"] }
                        },
                        legend: {
                            type: 'scroll',
                            icon: 'none',
                            data: years,
                            orient: 'vertical',
                            top: '5%',
                            right: 'right',
                            itemWidth: 20,
                            itemHeight: 20,
                            itemGap: 10,
                            pageIconSize: 10,
                            pageTextStyle: { fontSize: 14 },
                            selectedMode: 'single',
                        },
                        series: years.map(year => ({
                            type: 'heatmap',
                            coordinateSystem: 'calendar',
                            data: groupedData[year],
                            name: year,
                            emphasis: {
                                disabled: true,
                            },
                            silent: year !== initYear,
                        })),
                    });
                    
                    // init selected year
                    heatmapChart.dispatchAction({
                        type: 'legendSelect',
                        name: initYear,
                    });
                    
                    heatmapChart.on('legendselectchanged', function(params) {
                        console.log('[hexo-graph]generateHeatmapChart|legendselectchanged:', params);
                        const selectedYear = Object.keys(params.selected).find(key => params.selected[key]);
                        if (selectedYear && groupedData[selectedYear]) {
                            heatmapChart.setOption({
                                calendar: {
                                    range: selectedYear,
                                },
                                visualMap: {
                                    max: Math.max(...groupedData[selectedYear].map(item => item[1])),
                                },
                                series: years.map(year => ({
                                    type: 'heatmap',
                                    coordinateSystem: 'calendar',
                                    data: groupedData[year],
                                    name: year,
                                    emphasis: {
                                        disabled: true,
                                    },
                                    silent: year !== selectedYear,
                                })),
                            });
                        }
                    });
                    
                    heatmapChart.on('click', function (params) {
                        if (params.componentType === 'series') {
                            const [year, month] = params.value[0].split('-');
                            window.location.href = '/archives/' + year + '/' + month;
                        }
                    });
                }
            });
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const monthlyChartDom = document.getElementById('monthlyChart');
                if(monthlyChartDom){
                    const monthlyChart = echarts.init(monthlyChartDom, 'dark');
                    monthlyChart.setOption({
                        xAxis: { 
                            type: 'category', 
                            data: ["2025-10"], 
                            axisLabel: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        },
                        yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#ccc' } } },
                        series: [{
                            name: 'Articles',
                            type: 'line',
                            data: [414],
                            smooth: true,
                            lineStyle: { color: '#5470C6', width: 2 },
                            itemStyle: { color: '#5470C6' },
                            areaStyle: { color: 'rgba(84, 112, 198, 0.4)' },
                            symbolSize: 10,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: params => params.value,
                                fontSize: 14,
                                color: '#000',
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            }
                        }]
                    });

                    monthlyChart.on('click', function (params) {
                        const [year, month] = params.name.split('-');
                        window.location.href = '/archives/' + year + '/' + month;
                    });
                }
            })
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const tagsChartDom = document.getElementById('tagsChart');
                if(tagsChartDom){
                    const tagsChart = echarts.init(tagsChartDom, 'dark');
                    tagsChart.setOption({
                        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                        series: [{
                            type: 'pie',
                            radius: '60%',
                            data: [{"name":"linux","value":227},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44},{"name":"drivers","value":39},{"name":"fs","value":37},{"name":"other","value":28}],
                            label: {
                                position: 'outside',
                                formatter: '{b} {c} ({d}%)',
                                fontSize: 14,
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            },
                            color: ["#5470C6","#91CC75","#FAC858","#EE6666","#73C0DE","#3BA272","#FC8452","#9A60B4"],
                            labelLine: { show: true }
                        }],
                        legend: {
                            bottom: '0',
                            left: 'center',
                            data: [{"name":"linux","value":227},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44},{"name":"drivers","value":39},{"name":"fs","value":37},{"name":"other","value":28}].map(tag => tag.name),
                            textStyle: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        }
                    });

                    tagsChart.on('click', function (params) {
                        window.location.href = '/tags/' + params.name;
                    });
                }
            })
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const categoriesChartDom = document.getElementById('categoriesChart');
                if(categoriesChartDom){
                    const categoriesChart = echarts.init(categoriesChartDom, 'dark');
                    categoriesChart.setOption({
                        xAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#ccc' } } },
                        yAxis: { 
                            type: 'category', 
                            data: [{"name":"linux","value":227},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44}].map(category => category.name).reverse(), 
                            axisLabel: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        },
                        series: [{
                            name: 'Category Count',
                            type: 'bar',
                            data: [{"name":"linux","value":227},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44}].map(category => category.value).reverse(),
                            label: {
                                show: true,
                                position: 'right',
                                formatter: params => params.value,
                                fontSize: 14,
                                color: '#000',
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            },
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    { offset: 0, color: '#91CC75' },
                                    { offset: 1, color: '#73C0DE' }
                                ])
                            }
                        }]
                    });

                    categoriesChart.on('click', function (params) {
                        window.location.href = '/categories/' + params.name;
                    });
                }
            });
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const categoriesTreeChartDom = document.getElementById('categoriesTreeChart');
                if(categoriesTreeChartDom){
                    const treeChart = echarts.init(categoriesTreeChartDom, 'dark');
                    treeChart.setOption({
                        title: {
                            text: '操作提示：单击展开分类，双击进入具体分类页面',
                            textStyle: {
                                fontSize: 12,
                                color: '#999',
                                fontWeight: 'normal'
                            },
                            bottom: 0,
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'item',
                            triggerOn: 'mousemove'
                        },
                        series: [{
                            type: 'tree',
                            data: [{"name":"Categories","children":[{"name":"uboot","children":[{"name":"other","children":[],"count":12,"path":"uboot/other"},{"name":"子目录","children":[],"count":10,"path":"uboot/子目录"},{"name":"u-boot分类","children":[{"name":"api","children":[],"count":1,"path":"uboot/u-boot分类/api"},{"name":"arch","children":[{"name":"arm","children":[],"count":2,"path":"uboot/u-boot分类/arch/arm"}],"count":3,"path":"uboot/u-boot分类/arch"},{"name":"boot","children":[],"count":4,"path":"uboot/u-boot分类/boot"},{"name":"common","children":[],"count":10,"path":"uboot/u-boot分类/common"},{"name":"cmd","children":[],"count":1,"path":"uboot/u-boot分类/cmd"},{"name":"dm","children":[],"count":15,"path":"uboot/u-boot分类/dm"},{"name":"env","children":[],"count":1,"path":"uboot/u-boot分类/env"},{"name":"fdt","children":[],"count":1,"path":"uboot/u-boot分类/fdt"},{"name":"lib","children":[],"count":4,"path":"uboot/u-boot分类/lib"},{"name":"include","children":[],"count":3,"path":"uboot/u-boot分类/include"},{"name":"test","children":[],"count":1,"path":"uboot/u-boot分类/test"}],"count":44,"path":"uboot/u-boot分类"}],"count":68,"path":"uboot"},{"name":"rt-thread","children":[{"name":"其他资料","children":[{"name":"fatfs","children":[],"count":1,"path":"rt-thread/其他资料/fatfs"}],"count":1,"path":"rt-thread/其他资料"}],"count":44,"path":"rt-thread"},{"name":"linux","children":[{"name":"fs","children":[],"count":37,"path":"linux/fs"},{"name":"lib","children":[],"count":19,"path":"linux/lib"},{"name":"mm","children":[],"count":19,"path":"linux/mm"},{"name":"kernel","children":[{"name":"time","children":[],"count":10,"path":"linux/kernel/time"},{"name":"irq","children":[],"count":5,"path":"linux/kernel/irq"},{"name":"rcu","children":[],"count":3,"path":"linux/kernel/rcu"},{"name":"lock","children":[],"count":7,"path":"linux/kernel/lock"},{"name":"sched","children":[],"count":7,"path":"linux/kernel/sched"}],"count":61,"path":"linux/kernel"},{"name":"other","children":[],"count":17,"path":"linux/other"},{"name":"scripts","children":[],"count":2,"path":"linux/scripts"},{"name":"security","children":[],"count":1,"path":"linux/security"},{"name":"include","children":[],"count":10,"path":"linux/include"},{"name":"block","children":[],"count":5,"path":"linux/block"},{"name":"drivers","children":[{"name":"clk","children":[],"count":2,"path":"linux/drivers/clk"},{"name":"base","children":[],"count":14,"path":"linux/drivers/base"},{"name":"tty","children":[],"count":2,"path":"linux/drivers/tty"}],"count":39,"path":"linux/drivers"},{"name":"arch","children":[{"name":"arm","children":[],"count":10,"path":"linux/arch/arm"}],"count":10,"path":"linux/arch"}],"count":227,"path":"linux"},{"name":"hpatch","children":[{"name":"SA-IS","children":[],"count":1,"path":"hpatch/SA-IS"},{"name":"libdivsufsort","children":[],"count":3,"path":"hpatch/libdivsufsort"}],"count":10,"path":"hpatch"},{"name":"杂谈","children":[],"count":8,"path":"杂谈"},{"name":"MCU","children":[],"count":23,"path":"MCU"},{"name":"git","children":[],"count":6,"path":"git"},{"name":"LoraWan","children":[{"name":"LoRaWAN标准","children":[{"name":"LoRaWAN-Specification_ZH_CN","children":[{"name":"LoRaWAN-Specification_ZH_CN-190102","children":[{"name":"chapter","children":[],"count":20,"path":"LoraWan/LoRaWAN标准/LoRaWAN-Specification_ZH_CN/LoRaWAN-Specification_ZH_CN-190102/chapter"}],"count":22,"path":"LoraWan/LoRaWAN标准/LoRaWAN-Specification_ZH_CN/LoRaWAN-Specification_ZH_CN-190102"}],"count":22,"path":"LoraWan/LoRaWAN标准/LoRaWAN-Specification_ZH_CN"}],"count":22,"path":"LoraWan/LoRaWAN标准"}],"count":23,"path":"LoraWan"},{"name":"freertos","children":[],"count":1,"path":"freertos"},{"name":"tmc5160","children":[],"count":1,"path":"tmc5160"}],"count":0,"path":""}],
                            initialTreeDepth: -1,
                            top: '5%',
                            bottom: '10%',
                            left: '0%',
                            right: '0%',
                            symbolSize: 15,
                            layout: 'orthogonal',
                            orient: 'TB',
                            itemStyle: {
                                color: '#91CC75',
                                borderColor: '#73C0DE'
                            },
                            label: {
                                position: 'bottom',
                                verticalAlign: 'middle',
                                align: 'center',
                                fontSize: 14,
                                distance: 28,
                                formatter: function(params) {
                                    return params.data.name + (params.data.count ? ' (' + params.data.count + ')' : '');
                                }
                            },
                            leaves: {
                                label: {
                                    position: 'top',
                                    verticalAlign: 'middle',
                                    align: 'center'
                                }
                            },
                            emphasis: {
                                focus: 'descendant'
                            },
                            expandAndCollapse: true
                        }]
                    });

                    treeChart.on('dblclick', function (params) {
                        if (params.data && params.data.path) {
                            window.location.href = '/categories/' + params.data.path;
                        }
                    });
                }
            });
        </script>
    
    <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>