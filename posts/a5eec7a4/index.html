<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>littlefs | wdfk-prog的个人博客</title><meta name="author" content="Liya Huang"><meta name="copyright" content="Liya Huang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="littlefs123456789101112131415161718192021&#x2F;&#x2F; Users can override lfs_util.h with their own configuration by defining&#x2F;&#x2F; LFS_CONFIG as a header file to include (-DLFS_CONFIG&#x3D;lfs_config.h).&#x2F;&#x2F;&#x2F;&#x2F; If LFS_CONF">
<meta property="og:type" content="article">
<meta property="og:title" content="littlefs">
<meta property="og:url" content="https://wdfk-prog.space/posts/a5eec7a4/index.html">
<meta property="og:site_name" content="wdfk-prog的个人博客">
<meta property="og:description" content="littlefs123456789101112131415161718192021&#x2F;&#x2F; Users can override lfs_util.h with their own configuration by defining&#x2F;&#x2F; LFS_CONFIG as a header file to include (-DLFS_CONFIG&#x3D;lfs_config.h).&#x2F;&#x2F;&#x2F;&#x2F; If LFS_CONF">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wdfk-prog.space/images/covers/06.jpg">
<meta property="article:published_time" content="2025-10-03T01:44:52.000Z">
<meta property="article:modified_time" content="2025-10-03T09:23:27.952Z">
<meta property="article:author" content="Liya Huang">
<meta property="article:tag" content="rt-thread">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wdfk-prog.space/images/covers/06.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "littlefs",
  "url": "https://wdfk-prog.space/posts/a5eec7a4/",
  "image": "https://wdfk-prog.space/images/covers/06.jpg",
  "datePublished": "2025-10-03T01:44:52.000Z",
  "dateModified": "2025-10-03T09:23:27.952Z",
  "author": [
    {
      "@type": "Person",
      "name": "Liya Huang",
      "url": "https://github.com/wdfk-prog"
    }
  ]
}</script><link rel="shortcut icon" href="/images/favicon.png"><link rel="canonical" href="https://wdfk-prog.space/posts/a5eec7a4/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//static.cloudflareinsights.com"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxxxxx"/><meta name="baidu-site-verification" content="xxxxxxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-3978542742563797',
  enable_page_level_ads: 'true'
});</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?3c49dd4913ab43efb1bfc8d12b1cded9";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-PF2CVP2PL4"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-PF2CVP2PL4')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-PF2CVP2PL4', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script defer="defer" data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;17ff914b5e28493597b7dc19f3356022&quot;}"></script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "tkaenn1tjv");
</script><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
"https://www.googletagmanager.com/gtm.js?id="+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MF3J339H');
btf.addGlobalFn('pjaxComplete', () => {
  dataLayer.push({'event': 'pjaxComplete', 'page_title': document.title, 'page_location': location.href, 'page_path': window.location.pathname})
}, 'google_tag_manager')</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'littlefs',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.0.0"><link rel="alternate" href="/atom.xml" title="wdfk-prog的个人博客" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (true) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/images/subtle-texture.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/avatar.png" onerror="this.onerror=null;this.src='/images/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">417</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">49</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">53</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book-open"></i><span> 页面</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-quote-left"></i><span> 说说</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 示例</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i><span> 歌曲</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/images/covers/06.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/my-logo.png" alt="Logo"><span class="site-name">wdfk-prog的个人博客</span></a><a class="nav-page-title" href="/"><span class="site-name">littlefs</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book-open"></i><span> 页面</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-quote-left"></i><span> 说说</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 示例</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i><span> 歌曲</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">littlefs<a class="post-edit-link" href="null_posts/rt-thread/littlefs.md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-10-03T01:44:52.000Z" title="发表于 2025-10-03 09:44:52">2025-10-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-10-03T09:23:27.952Z" title="更新于 2025-10-03 17:23:27">2025-10-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/rt-thread/">rt-thread</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">10.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>43分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/a5eec7a4/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;已经过了&quot;,&quot;messageNext&quot;:&quot;自上次更新以来，文章的内容可能已经过时&quot;,&quot;postUpdate&quot;:&quot;2025-10-03 17:23:27&quot;}" hidden></div><h1 id="littlefs"><a href="#littlefs" class="headerlink" title="littlefs"></a>littlefs</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Users can override lfs_util.h with their own configuration by defining</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LFS_CONFIG as a header file to include (-DLFS_CONFIG=lfs_config.h).</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// If LFS_CONFIG is used, none of the default utils will be emitted and must be</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// provided by the config file. To start, I would suggest copying lfs_util.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// and modifying as needed.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LFS_CONFIG</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LFS_STRINGIZE(x) LFS_STRINGIZE2(x)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LFS_STRINGIZE2(x) #x</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> LFS_STRINGIZE(LFS_CONFIG)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="机制"><a href="#机制" class="headerlink" title="机制"></a>机制</h2><ul>
<li>断电恢复能力:独立的原子性</li>
<li>磨损均衡</li>
<li>有限的RAM&#x2F;ROM</li>
</ul>
<ol>
<li>日志记录提供独立的原子性，但运行时性能较差。而表现良好的COW数据结构将原子性问题向上推了</li>
<li>littlefs 由小型的两个块日志构建而成，这些日志为文件系统上任何位置的元数据提供原子更新。在超级块级别，littlefs 是一个可以按需清除的 CObW 块树</li>
</ol>
<h3 id="元数据对"><a href="#元数据对" class="headerlink" title="元数据对"></a>元数据对</h3><ol>
<li>元数据对是 littlefs 的支柱。这些是小的两个块日志，允许在文件系统中的任何位置进行原子更新。</li>
<li>为了确定哪个元数据块是最新的，我们存储了一个修订计数，我们使用序列算术进行比较（对于避免整数溢出问题非常方便）。方便的是，这个修订计数还让我们大致了解了块上发生了多少次擦除。</li>
<li>原子性（一种功率损耗弹性）需要两部分：冗余和错误检测。错误检测可以通过校验和提供，在 littlefs 的情况下，我们使用 32 位 CRC。另一方面，保持冗余需要多个阶段。</li>
<li>如果我们的块没有满，并且程序大小足够小，可以让我们附加更多条目，我们可以简单地将条目附加到日志中。因为我们不会覆盖原始条目（请记住，重写 flash 需要擦除），所以如果我们在追加过程中断电，我们仍然保留原始条目。</li>
<li>将多个条目分组到一个共享单个校验和的提交中。这使我们可以更新多个不相关的元数据片段，只要它们位于同一元数据对上即可。</li>
</ol>
<h3 id="垃圾回收-压缩"><a href="#垃圾回收-压缩" class="headerlink" title="垃圾回收,压缩"></a>垃圾回收,压缩</h3><ol>
<li>如果我们的块充满了条目，我们需要以某种方式删除过时的条目，以便为新条目腾出空间。这个过程叫做垃圾回收，但是因为 littlefs 有多个垃圾回收器，所以我们也把这个特定情况称为压缩</li>
<li>littlefs 的垃圾收集器相对简单。我们希望避免 RAM 消耗，因此我们使用一种暴力解决方案，对于每个条目，我们检查是否编写了较新的条目。如果条目是最新的，我们将其附加到新块中。这就是拥有两个块变得重要的地方，如果我们失去权力，我们仍然拥有原始块中的所有东西。</li>
<li>用完了数据内容;将原始元数据对拆分为两个元数据对，每个元数据对包含一半的条目，通过尾指针连接。我们没有增加日志的大小并处理与较大日志相关的可伸缩性问题，而是形成了一个小有界日志的链接列表。这是一种权衡，因为这种方法确实使用了更多的存储空间，但有利于提高可伸缩性。</li>
<li>为了避免这种指数级增长，我们不是等待元数据对满，而是在超过 50% 的容量时拆分元数据对。我们懒惰地这样做，等到我们需要压缩时再检查是否符合 50% 的限制。这将垃圾回收的开销限制为运行时成本的 2 倍，从而为我们提供了 O（1） 的摊销运行时复杂度。</li>
</ol>
<h3 id="CTZ跳过列表"><a href="#CTZ跳过列表" class="headerlink" title="CTZ跳过列表"></a>CTZ跳过列表</h3><ol>
<li>CTZ 跳过列表为我们提供了一个 COW 数据结构，该结构在 O（n） 中易于遍历，可以在 O（1） 中追加，并且可以在 O（n log n） 中读取。所有这些操作都在有限的 RAM 量中工作，并且每个块只需要两个字的存储开销。结合元数据对，CTZ 跳过列表可提供强大的弹性和紧凑的数据存储。</li>
</ol>
<h3 id="块分配器"><a href="#块分配器" class="headerlink" title="块分配器"></a>块分配器</h3><ol>
<li>通常，块分配涉及存储在文件系统上的某种空闲列表或位图，这些空闲列表或位图会使用空闲块进行更新。然而，由于具有电力弹性，保持这些结构的一致性变得困难。更新这些结构的任何错误都可能导致无法恢复的丢失块，这无济于事。</li>
<li>littlefs 中的块分配器是磁盘大小的位图和暴力遍历之间的折衷方案。我们跟踪的不是存储大小的位图，而是一个名为 lookahead 缓冲区的小型固定大小的位图。在区块分配期间，我们从 lookahead 缓冲区中获取区块。如果 lookahead 缓冲区为空，我们将扫描文件系统以查找更多空闲块，从而填充我们的 lookahead 缓冲区。在每次扫描中，我们都使用一个递增的偏移量，在分配块时围绕存储圈。</li>
</ol>
<h3 id="检测和恢复坏块"><a href="#检测和恢复坏块" class="headerlink" title="检测和恢复坏块"></a>检测和恢复坏块</h3><ol>
<li>在 littlefs 中，在写入时检测坏块相当简单。所有写入都必须由 RAM 中的某种形式的数据源，因此在我们写入块后，我们可以立即读回数据并验证它是否被正确写入。如果我们发现磁盘上的数据与RAM中的副本不匹配，则发生了写入错误，并且很可能有一个坏块。</li>
<li>检测到坏块，我们就需要从中恢复。在写入错误的情况下，我们在RAM中有损坏数据的副本，因此我们需要做的就是逐出坏块，分配一个新的，希望是好的块，并重复以前失败的写入。</li>
<li>另一方面，读取错误要复杂得多。我们没有在RAM中徘徊的数据副本，因此我们需要一种方法来重建原始数据，即使它已被损坏。其中一种机制是纠错码 （ECC）。ECC 是校验和概念的扩展。如果校验和（如 CRC）可以检测到数据中发生了错误，则 ECC 可以检测并实际纠正一定数量的错误。但是，ECC 可以检测到的错误数量是有限制的：汉明绑定。当错误数量接近汉明边界时，我们可能仍然能够检测到错误，但无法再修复数据。如果我们达到这一点，则块是不可恢复的。littlefs 本身不提供 ECC。ECC 的块性质和相对较大的占用空间不适用于文件系统的动态大小数据，在没有 RAM 的情况下纠正错误很复杂，而 ECC 更适合块设备的几何形状。事实上，一些 NOR 闪存芯片具有用于 ECC 的额外存储，许多 NAND 芯片甚至可以在芯片本身上计算 ECC。</li>
</ol>
<h3 id="磨损均衡"><a href="#磨损均衡" class="headerlink" title="磨损均衡"></a>磨损均衡</h3><blockquote>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://en.wikipedia.org/wiki/Wear_leveling#Static_wear_leveling">https://en.wikipedia.org/wiki/Wear_leveling#Static_wear_leveling</a></p>
</blockquote>
<ol>
<li>作为对代码大小和复杂性的权衡，littlefs（目前）仅提供动态磨损均衡。这是一个尽力而为的解决方案。磨损不是完全分布的，但它分布在自由块之间，大大延长了设备的使用寿命。</li>
<li>磨损的均匀分布由块分配器决定，该分配器在两部分中创建均匀分布。简单的部分是当设备通电时，在这种情况下，我们线性分配块，围绕设备旋转。更难的部分是当设备断电时该怎么办。我们不能在存储开始时重新启动分配器，因为这会导致磨损。取而代之的是，每次挂载文件系统时，我们都会以随机偏移量的形式启动分配器。只要这种随机偏移量是均匀的，组合分配模式也是均匀分布。最初，这种磨损均衡方法看起来会对与电源无关的随机数生成器产生困难的依赖性，该随机数生成器必须在每次启动时返回不同的随机数。然而，文件系统处于一个相对独特的情况，因为它位于大量的熵之上，这些熵在功率损失期间持续存在。</li>
</ol>
<h3 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h3><ol>
<li>首先，我们可以在单个元数据对中存储多个文件，而不是为每个文件提供自己的元数据对。一种方法是直接将目录与元数据对（或元数据对的链接列表）关联。这使得多个文件可以轻松地共享目录的元数据对以进行日志记录，并减少集体存储开销。</li>
<li>对于非常小的文件，我们尝试使用 CTZ 跳过列表来压缩存储适得其反。元数据对的存储成本是 ~4 倍，因此，如果我们的文件小于块大小的 1&#x2F;4，那么在元数据对之外存储文件实际上没有任何好处。在这种情况下，我们可以将文件直接存储在目录的元数据对中。我们称之为内联文件，它允许目录非常有效地存储许多小文件。我们之前的 4 字节文件现在在磁盘上只占用理论上的 16 个字节。</li>
</ol>
<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><ol>
<li>就其本身而言，每个目录都是元数据对的链接列表。这使我们可以在每个目录中存储无限数量的文件，并且我们无需担心无界日志的运行时复杂性。我们可以在元数据对中存储其他目录指针，这为我们提供了一个目录树，就像您在其他文件系统上找到的一样。</li>
<li>不幸的是，不坚持纯粹的 COW 操作会产生一些问题。现在，每当我们想要操作目录树时，都需要更新多个指针。如果你熟悉设计原子数据结构，这应该会引发一堆危险信号。</li>
<li>为了解决这个问题，我们的线程链接列表有一点回旋余地。它不仅包含在我们的文件系统中找到的元数据对，还允许包含由于断电而没有父级的元数据对。这些称为孤立元数据对。</li>
<li>于存在孤立函数的可能性，我们可以构建具有功率损失弹性的操作，该操作维护一个文件系统树，该树与链接列表线程化，以便进行遍历。</li>
<li>查找孤儿和半孤儿需要花费大量资金，需要对每个元数据对与每个目录条目进行 O（n²） 比较。但权衡是一个具有功率弹性的文件系统，它只使用有限数量的 RAM。幸运的是，我们只需要在启动后的第一次分配中检查孤立项，只读的 littlefs 可以完全忽略线程化的链接列表。</li>
</ol>
<h3 id="文件移动"><a href="#文件移动" class="headerlink" title="文件移动"></a>文件移动</h3><ol>
<li>解决移动问题需要创建一种新的机制，用于在多个元数据对之间共享知识。在 littlefs 中，这导致了一种称为“全局状态”的机制的引入。</li>
<li>全局状态是可以从任何元数据对更新的一小组状态。将全局状态与元数据对在一次提交中更新多个条目的能力相结合，为我们提供了一个强大的工具，用于制作复杂的原子操作。</li>
<li>全局状态以一组增量的形式存在，这些增量分布在文件系统中的元数据对中。通过将文件系统中的所有增量组合在一起，可以从这些增量中构建实际的全局状态。</li>
<li>为了更新元数据对的全局状态，我们采用我们已知的全局状态，并将其与我们的更改和元数据对中的任何现有增量进行异化。将此新增量提交到元数据对会提交对文件系统全局状态的更改。</li>
<li>为了提高效率，我们始终在RAM中保留全局状态的副本。我们只需要遍历我们的元数据对，并在挂载文件系统时构建全局状态。</li>
<li>全局状态的成本非常高。我们在 RAM 中保留一个副本，在无限数量的元数据对中保留一个增量。即使我们将全局状态重置为其初始值，我们也无法轻松清理磁盘上的增量。出于这个原因，我们必须保持全局状态的大小有限且非常小，这一点非常重要。但是，即使有严格的预算，全球状态也非常有价值。</li>
</ol>
<h3 id="gdiff"><a href="#gdiff" class="headerlink" title="gdiff"></a>gdiff</h3><ol>
<li>GDIFF 跟踪当前 ID 与元数据日志历史记录中 ID 之间的相对差异。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 考虑一下如果我们创建文件 a、b、c，然后删除 a，会发生什么：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">id        0 1 2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">---------------</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">create a id=0  .</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">               |</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">create b id=1  | .</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">               | |</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">create d id=2  | | .</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">               | | |</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">delete a id=0  &#x27; / /</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                / /</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">create c id=1  | .\</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">               | | \</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">create a id=0  .\ \ \</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">               | | | |</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">delete a id=0  &#x27; / / /</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                / / /</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">               b c d</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">getslice(id=0) =&gt; file b</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">getslice(id=1) =&gt; file c</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">getslice(id=2) =&gt; file d</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//如果我们想在 b 上查找一些标签，我们将从 id=0 开始。请记住，我们会向后查找。当我们看到 “delete a” 时，我们需要增加 giff，以便 gtag+gdiff 显示当前 b 的 id（现在 id=1）。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//最终，当我们到达“create b”时，我们可以报告我们找到的标签，但我们需要报告当前的 id，而不是我们过去找到的那个。通过在单独的变量中跟踪 gdiff，我们可以跟踪过去的 id 应该是什么，同时也可以知道当前的 id 应该是什么。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>关键是元数据块是一个日志，它只追加，我们不能修改任何已经写入的数据。因此，如果我们已经写了文件 b 是 id&#x3D;0，但我们想在 id&#x3D;0 处插入一个文件 a 以保持排序顺序，我们需要假设文件 b 是 id&#x3D;1。这就是此扫描&#x2F;gdiff 的作用。</li>
</ol>
<ul>
<li>也是所有元数据访问都需要扫描日志的原因之一，我们需要查看自写入元数据以来 id 是否发生了变化。但是我们首先需要扫描日志以找到元数据，所以这并不是一个太大的惩罚。</li>
</ul>
<ol start="3">
<li>请注意：实际的 ID 仅从单个元数据块（有时在代码中称为 mdir）计算得出。文件夹实际上是这些元数据块的链接列表，每个块都是独立的。这样可以使对元数据的操作与块大小保持界限。</li>
<li>因此，要访问文件，您需要知道文件的 mdir 及其在 mdir 中的 id。由于不相关的文件系统操作，这可能会发生变化。</li>
<li>lfs_mdir与目录的单个元数据块相关，而lfs_dir - 与整个目录相关</li>
</ol>
<ul>
<li>当 mdir 空间不足并且无法再追加提交时，它将被压缩。这涉及分配一个新的 mdir ，并从原始 mdir 复制标签。此时，我们可以删除任何已删除、待处理或已提交的删除，并回收空间。</li>
<li>为了防止压缩性能失控，我们认为如果压缩没有将 mdir 减小到块大小的 1&#x2F;2，则压缩将失败。虽然我猜另一个观点是所有 mdir 都使用 1&#x2F;2 一个块，并且可以通过附加额外的提交来过度分配。</li>
<li>如果压缩失败，我们将尝试拆分 mdir。在本例中，我们分配 2 个 mdir，并将大约 1&#x2F;2 的当前标签复制到每个 mdir 中。在这里，一个目录可以扩展到多个 mdir 中。</li>
<li>请注意，由于 mdir 最多可以包含 1 个标签块，因此拆分总是会导致 mdir 大约 1&#x2F;2 满。所以分裂不能失败。</li>
<li>在尝试提交删除标签的 mdir 拆分期间，我们可能会用完块。这种罕见但可能的情况会导致文件系统无法恢复。有趣的是，这个问题在写入时复制的文件系统中很常见。为了解决这个问题，所有主要的 CoW 文件系统都为特定于文件系统的书签、ZFS、btrfs 等预留了一些空间。littlefs 目前不这样做，所以目前有可能填满文件系统并使其无法恢复。有一些计划来改善这一点，对“非紧急”提交的完全截止值为 ~88%</li>
</ul>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// variables used by the filesystem</span></span><br><span class="line"></span><br><span class="line"><span class="type">lfs_t</span> lfs;</span><br><span class="line"></span><br><span class="line"><span class="type">lfs_file_t</span> file;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// configuration of the filesystem is provided by this struct</span></span><br><span class="line"></span><br><span class="line">conststruct lfs_config cfg = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// block device operations</span></span><br><span class="line"></span><br><span class="line">    .read  = user_provided_block_device_read,</span><br><span class="line"></span><br><span class="line">    .prog  = user_provided_block_device_prog,</span><br><span class="line"></span><br><span class="line">    .erase = user_provided_block_device_erase,</span><br><span class="line"></span><br><span class="line">    .sync  = user_provided_block_device_sync,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// block device configuration</span></span><br><span class="line"></span><br><span class="line">    .read_size = <span class="number">16</span>,</span><br><span class="line"></span><br><span class="line">    .prog_size = <span class="number">16</span>,</span><br><span class="line"></span><br><span class="line">    .block_size = <span class="number">4096</span>,</span><br><span class="line"></span><br><span class="line">    .block_count = <span class="number">128</span>,</span><br><span class="line"></span><br><span class="line">    .cache_size = <span class="number">16</span>,</span><br><span class="line"></span><br><span class="line">    .lookahead_size = <span class="number">16</span>,</span><br><span class="line"></span><br><span class="line">    .block_cycles = <span class="number">500</span>,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// mount the filesystem</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> err = lfs_mount(&amp;lfs, &amp;cfg);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// reformat if we can&#x27;t mount the filesystem</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// this should only happen on the first boot</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">        lfs_format(&amp;lfs, &amp;cfg);</span><br><span class="line"></span><br><span class="line">        lfs_mount(&amp;lfs, &amp;cfg);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="文件系统操作"><a href="#文件系统操作" class="headerlink" title="文件系统操作"></a>文件系统操作</h2><h3 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticvoid_lfs_load_config(<span class="keyword">struct</span> lfs_config* lfs_cfg, <span class="keyword">struct</span> rt_mtd_nor_device* mtd_nor)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> mtd_size;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;context = (<span class="type">void</span>*)mtd_nor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;read_size = LFS_READ_SIZE;</span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;prog_size = LFS_PROG_SIZE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;block_size = mtd_nor-&gt;block_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lfs_cfg-&gt;block_size &lt; LFS_BLOCK_SIZE)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        lfs_cfg-&gt;block_size = LFS_BLOCK_SIZE;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;cache_size = LFS_CACHE_SIZE;</span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;block_cycles = LFS_BLOCK_CYCLES;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mtd_size = mtd_nor-&gt;block_end - mtd_nor-&gt;block_start;</span><br><span class="line"></span><br><span class="line">    mtd_size *= mtd_nor-&gt;block_size;</span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;block_count = mtd_size / lfs_cfg-&gt;block_size;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;lookahead_size = <span class="number">32</span> * ((lfs_cfg-&gt;block_count + <span class="number">31</span>) / <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lfs_cfg-&gt;lookahead_size &gt; LFS_LOOKAHEAD_MAX)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        lfs_cfg-&gt;lookahead_size = LFS_LOOKAHEAD_MAX;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LFS_THREADSAFE</span></span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;lock = _lfs_lock;</span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;unlock = _lfs_unlock;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;read = _lfs_flash_read;</span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;prog = _lfs_flash_prog;</span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;erase = _lfs_flash_erase;</span><br><span class="line"></span><br><span class="line">    lfs_cfg-&gt;sync = _lfs_flash_sync;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">staticint_dfs_lfs_mount(<span class="keyword">struct</span> dfs_filesystem* dfs, unsignedlongrwflag, constvoid* data)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    _lfs_load_config(&amp;dfs_lfs-&gt;cfg, (<span class="keyword">struct</span> rt_mtd_nor_device*)dfs-&gt;dev_id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* mount lfs*/</span></span><br><span class="line"></span><br><span class="line">    result = lfs_mount(&amp;dfs_lfs-&gt;lfs, &amp;dfs_lfs-&gt;cfg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* mount succeed! */</span></span><br><span class="line"></span><br><span class="line">    dfs-&gt;data = (<span class="type">void</span>*)dfs_lfs;</span><br><span class="line"></span><br><span class="line">    _lfs_mount_tbl[index] = dfs_lfs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RT_EOK;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mkfs"><a href="#mkfs" class="headerlink" title="mkfs"></a>mkfs</h3><ol>
<li>lfs_format</li>
</ol>
<h2 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h2><h2 id="module"><a href="#module" class="headerlink" title="module"></a>module</h2><h3 id="other"><a href="#other" class="headerlink" title="other"></a>other</h3><h4 id="tag"><a href="#tag" class="headerlink" title="tag"></a>tag</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">[----            32             ----]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">[1|--  11   --|--  10  --|--  10  --]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> ^.     ^     .     ^          ^- length</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> |.     |     .     &#x27;------------ id</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> |.     &#x27;-----.------------------ type (type3)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> &#x27;.-----------.------------------ valid bit</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  [-3-|-- 8 --]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ^     ^- chunk</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    &#x27;------- type (type1)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LFS_MKTAG(type, id, size) \</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line">    (((<span class="type">lfs_tag_t</span>)(type) &lt;&lt;<span class="number">20</span>) | ((<span class="type">lfs_tag_t</span>)(id) &lt;&lt;<span class="number">10</span>) | (<span class="type">lfs_tag_t</span>)(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// tag最高位为1表示无效</span></span><br><span class="line"></span><br><span class="line">staticinlineboollfs_tag_isvalid(lfs_tag_ttag) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> !(tag &amp; <span class="number">0x80000000</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断tag是不是为0x3ff;    特殊值 0x3ff 表示此标签已被删除</span></span><br><span class="line"></span><br><span class="line">staticinlineboollfs_tag_isdelete(lfs_tag_ttag) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">int32_t</span>)(tag &lt;&lt; <span class="number">22</span>) &gt;&gt; <span class="number">22</span>) == <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lfs-bd-read"><a href="#lfs-bd-read" class="headerlink" title="lfs_bd_read"></a>lfs_bd_read</h4><ul>
<li>rcache: read cache</li>
<li>pcache: program cache</li>
</ul>
<ol>
<li>当rcache没有数据时,从存储器中读取数据到rcache中,继续循环</li>
<li>当rcache有数据时,从rcache中读取数据到buffer中,判断读取大小是否满足要求,不满足则继续循环</li>
<li>当pcache有数据时,从pcache中读取数据</li>
<li>当直接读取阈值大于size时,绕过缓存,直接从存储器中读取数据到buffer中</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">bd_read:block device read</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">pcache：这是一个指向预读取缓存的指针。预读取缓存用于存储预先读取的数据，以便在需要时快速访问。如果当前块已经在预读取缓存中，那么就可以直接从缓存中获取数据，而不需要再次从存储器中读取。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rcache：这是一个指向读取缓存的指针。读取缓存用于存储最近读取的数据。如果当前块已经在读取缓存中，那么就可以直接从缓存中获取数据，而不需要再次从存储器中读取。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">hint：这是一个阈值，用于指示读取的大小。这个值用于优化读取，以便在读取大量数据时，可以绕过缓存。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">staticintlfs_bd_read(<span class="type">lfs_t</span> *lfs,</span><br><span class="line"></span><br><span class="line">        <span class="type">constlfs_cache_t</span> *pcache, <span class="type">lfs_cache_t</span> *rcache, </span><br><span class="line"></span><br><span class="line">        lfs_size_thint,</span><br><span class="line"></span><br><span class="line">        lfs_block_tblock, lfs_off_toff,</span><br><span class="line"></span><br><span class="line">        <span class="type">void</span> *buffer, lfs_size_tsize) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> *data = buffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (off+size &gt; lfs-&gt;cfg-&gt;block_size</span><br><span class="line"></span><br><span class="line">            || (lfs-&gt;block_count &amp;&amp; block &gt;= lfs-&gt;block_count)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> LFS_ERR_CORRUPT;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">lfs_size_t</span> diff = size;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pcache &amp;&amp; block == pcache-&gt;block &amp;&amp;</span><br><span class="line"></span><br><span class="line">                off &lt; pcache-&gt;off + pcache-&gt;size) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (off &gt;= pcache-&gt;off) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// is already in pcache?</span></span><br><span class="line"></span><br><span class="line">                diff = lfs_min(diff, pcache-&gt;size - (off-pcache-&gt;off));</span><br><span class="line"></span><br><span class="line">                <span class="built_in">memcpy</span>(data, &amp;pcache-&gt;buffer[off-pcache-&gt;off], diff);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                data += diff;</span><br><span class="line"></span><br><span class="line">                off += diff;</span><br><span class="line"></span><br><span class="line">                size -= diff;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// pcache takes priority</span></span><br><span class="line"></span><br><span class="line">            diff = lfs_min(diff, pcache-&gt;off-off);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (block == rcache-&gt;block &amp;&amp;</span><br><span class="line"></span><br><span class="line">                off &lt; rcache-&gt;off + rcache-&gt;size) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (off &gt;= rcache-&gt;off) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// is already in rcache?</span></span><br><span class="line"></span><br><span class="line">                diff = lfs_min(diff, rcache-&gt;size - (off-rcache-&gt;off));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//将rcache中的数据拷贝到buffer中</span></span><br><span class="line"></span><br><span class="line">                <span class="built_in">memcpy</span>(data, &amp;rcache-&gt;buffer[off-rcache-&gt;off], diff);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//将buffer指针向后移动diff个字节,以便下次拷贝数据</span></span><br><span class="line"></span><br><span class="line">                data += diff;</span><br><span class="line"></span><br><span class="line">                off += diff;</span><br><span class="line"></span><br><span class="line">                size -= diff;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// rcache takes priority</span></span><br><span class="line"></span><br><span class="line">            diff = lfs_min(diff, rcache-&gt;off-off);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size &gt;= hint &amp;&amp; off % lfs-&gt;cfg-&gt;read_size == <span class="number">0</span> &amp;&amp;</span><br><span class="line"></span><br><span class="line">                size &gt;= lfs-&gt;cfg-&gt;read_size) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// bypass cache?</span></span><br><span class="line"></span><br><span class="line">            diff = lfs_aligndown(diff, lfs-&gt;cfg-&gt;read_size);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> err = lfs-&gt;cfg-&gt;read(lfs-&gt;cfg, block, off, data, diff);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            data += diff;</span><br><span class="line"></span><br><span class="line">            off += diff;</span><br><span class="line"></span><br><span class="line">            size -= diff;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// load to cache, first condition can no longer fail</span></span><br><span class="line"></span><br><span class="line">        LFS_ASSERT(!lfs-&gt;block_count || block &lt; lfs-&gt;block_count);</span><br><span class="line"></span><br><span class="line">        rcache-&gt;block = block;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果off &lt; read_size，那么这个值是0。如果off &gt;= read_size，那么这个值是off向下对齐到read_size的最接近的倍数。</span></span><br><span class="line"></span><br><span class="line">        rcache-&gt;off = lfs_aligndown(off, lfs-&gt;cfg-&gt;read_size);</span><br><span class="line"></span><br><span class="line">        rcache-&gt;size = lfs_min(</span><br><span class="line"></span><br><span class="line">                lfs_min(</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//lfs_alignup(off+hint, lfs-&gt;cfg-&gt;read_size): 这部分是将偏移量（off）和预测值（hint）的和向上对齐到读取大小（read_size）。这意味着，如果 off+hint 不是 read_size 的整数倍，那么它会被增加到最接近的 read_size 的整数倍。</span></span><br><span class="line"></span><br><span class="line">                    lfs_alignup(off+hint, lfs-&gt;cfg-&gt;read_size),</span><br><span class="line"></span><br><span class="line">                    lfs-&gt;cfg-&gt;block_size)</span><br><span class="line"></span><br><span class="line">                - rcache-&gt;off,  <span class="comment">//这部分是从上一步得到的值中减去偏移量（off）。这意味着，我们只关心从 off 开始的数据。</span></span><br><span class="line"></span><br><span class="line">                lfs-&gt;cfg-&gt;cache_size);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> err = lfs-&gt;cfg-&gt;read(lfs-&gt;cfg, rcache-&gt;block,</span><br><span class="line"></span><br><span class="line">                rcache-&gt;off, rcache-&gt;buffer, rcache-&gt;size);</span><br><span class="line"></span><br><span class="line">        LFS_ASSERT(err &lt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lfs-bd-cmp"><a href="#lfs-bd-cmp" class="headerlink" title="lfs_bd_cmp"></a>lfs_bd_cmp</h4><ol>
<li>读取数据,比较数据</li>
<li>比较 <code>buffer</code>和读取从 <code>block</code>偏移 <code>off</code>的数据是否相等,长度为 <code>size</code></li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticintlfs_bd_cmp(<span class="type">lfs_t</span> *lfs,</span><br><span class="line"></span><br><span class="line">        <span class="type">constlfs_cache_t</span> *pcache, <span class="type">lfs_cache_t</span> *rcache, lfs_size_thint,</span><br><span class="line"></span><br><span class="line">        lfs_block_tblock, lfs_off_toff,</span><br><span class="line"></span><br><span class="line">        constvoid *buffer, lfs_size_tsize) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lfs-dir-find-match"><a href="#lfs-dir-find-match" class="headerlink" title="lfs_dir_find_match"></a>lfs_dir_find_match</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticintlfs_dir_find_match(</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *data, <span class="comment">//struct lfs_dir_find_match *name = data; 将name-&gt;name与buffer进行比较</span></span><br><span class="line"></span><br><span class="line">    lfs_tag_ttag, <span class="comment">//根据标签大小读取数据</span></span><br><span class="line"></span><br><span class="line">    constvoid *buffer);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lfs-gstate-hasmovehere"><a href="#lfs-gstate-hasmovehere" class="headerlink" title="lfs_gstate_hasmovehere"></a>lfs_gstate_hasmovehere</h4><p>&#x2F;&#x2F; 参考:<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/littlefs-project/littlefs/issues/920">https://github.com/littlefs-project/littlefs/issues/920</a>;</p>
<p>&#x2F;&#x2F; 指明 <code>如果 gtag 和 lfs-&gt;gdisk.tag 的 id 都可以为 0，那么从 gtag （id == 0） 中减去 gdiff （id == 1） 时，我们似乎可以得到一个下溢。</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// synthetic move</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (lfs_gstate_hasmovehere(&amp;lfs-&gt;gdisk, dir-&gt;<span class="built_in">pair</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lfs_tag_id(lfs-&gt;gdisk.tag) == lfs_tag_id(besttag)) &#123;</span><br><span class="line"></span><br><span class="line">        besttag |= <span class="number">0x80000000</span>;</span><br><span class="line"></span><br><span class="line">    &#125; elseif (besttag != <span class="number">-1</span> &amp;&amp;</span><br><span class="line"></span><br><span class="line">            lfs_tag_id(lfs-&gt;gdisk.tag) &lt; lfs_tag_id(besttag)) &#123;</span><br><span class="line"></span><br><span class="line">        besttag -= LFS_MKTAG(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// synthetic moves</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (lfs_gstate_hasmovehere(&amp;lfs-&gt;gdisk, dir-&gt;<span class="built_in">pair</span>) &amp;&amp;</span><br><span class="line"></span><br><span class="line">        lfs_tag_id(gmask) != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lfs_tag_id(lfs-&gt;gdisk.tag) == lfs_tag_id(gtag)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> LFS_ERR_NOENT;</span><br><span class="line"></span><br><span class="line">    &#125; elseif (lfs_tag_id(lfs-&gt;gdisk.tag) &lt; lfs_tag_id(gtag)) &#123;</span><br><span class="line"></span><br><span class="line">        gdiff -= LFS_MKTAG(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>检查元数据对是否包含正在移动的条目，如果是，则将其视为已删除。</li>
<li>只有当 gtag 的 id 大于或等于 lfs-&gt;gdisk.tag 的 id 时才会调用它</li>
</ul>
<h4 id="fetchmatch"><a href="#fetchmatch" class="headerlink" title="fetchmatch"></a>fetchmatch</h4><ol>
<li>读取指定块 <code>pair</code>的元数据对的修订计数,比较两个块的修订计数,找出修订计数最大的块;对dir-&gt;pair进行重新赋值,将版本更高的块赋值给dir-&gt;pair[0]</li>
<li>从第一个元数据开始扫描,要是读取不到有效信息,则换另一个元数据继续扫描</li>
<li>扫描时while读取一个block的所有标签,直到超出范围或者没有有效tag</li>
<li>扫描要是读到一个CRC标签,然后校验CRC标签,如果校验通过,则将CRC标签的数据更新到dir中</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">dir-&gt;off = off + lfs_tag_dsize(tag);</span><br><span class="line"></span><br><span class="line">dir-&gt;etag = ptag;</span><br><span class="line"></span><br><span class="line">dir-&gt;count = tempcount;</span><br><span class="line"></span><br><span class="line">dir-&gt;tail[<span class="number">0</span>] = temptail[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">dir-&gt;tail[<span class="number">1</span>] = temptail[<span class="number">1</span>];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>扫描时要是读到FCRC标签</li>
<li>每次扫描会把 <code>fmask</code>和 <code>ftag</code>进行匹配;匹配成功传入 <code>data</code>执行 <code>cb</code>函数;返回是否匹配;会遍历一个块的数据看看是否有更加匹配的标签</li>
<li>扫描结束后,判断这个元数据是否被擦过,进而执行标记 <code>dir-&gt;erased = 1;</code></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">我们的闪存模型需要两个步骤：</span><br><span class="line"></span><br><span class="line">1. 非常大的擦除操作 （block_size）。</span><br><span class="line"></span><br><span class="line">2. 小得多的 prog 操作 （prog_size）。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">元数据日志通过增量写入大型擦除块内的较小 prog 块来使用此模型。但是，仅仅因为我们有一个有效的日志，它只使用擦除块的一部分，并不意味着块的其余部分一定会被擦除。</span><br><span class="line"></span><br><span class="line">主要问题是提交失败。如果我们尝试提交日志，但中途失去电源，由于提交中的校验和，我们将回退到之前的有效状态。但这会留下日志的其余部分部分写入。尝试附加新的提交可能会导致数据损坏/保留问题。</span><br><span class="line"></span><br><span class="line">因此，在lfs_dir_fetch期间，littlefs 需要证明日志的其余部分已被擦除，然后才能使用它。这就是 FCRC 标签的用武之地，继续写入日志是否安全存储在 dir-&gt;egone 中。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>synthetic move 检查元数据对是否包含正在移动的条目，如果是，则将其视为已删除。</li>
<li>返回tag值代表有匹配的标签</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">fmask: 过滤器掩码，用于过滤标签</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">ftag: 标签，用于与标签进行比较</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">staticlfs_stag_tlfs_dir_fetchmatch(<span class="type">lfs_t</span> *lfs,</span><br><span class="line"></span><br><span class="line">        <span class="type">lfs_mdir_t</span> *dir, constlfs_block_tpair[<span class="number">2</span>],</span><br><span class="line"></span><br><span class="line">        lfs_tag_tfmask, lfs_tag_tftag, <span class="type">uint16_t</span> *id,</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> (*cb)(<span class="type">void</span> *data, <span class="type">lfs_tag_t</span> tag, constvoid *buffer), <span class="type">void</span> *data) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取指定块的元数据对的修订计数,比较两个块的修订计数,找出修订计数最大的块</span></span><br><span class="line"></span><br><span class="line">    uint32_trevs[<span class="number">2</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> r = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> err = lfs_bd_read(lfs,</span><br><span class="line"></span><br><span class="line">                <span class="literal">NULL</span>, &amp;lfs-&gt;rcache, <span class="keyword">sizeof</span>(revs[i]),</span><br><span class="line"></span><br><span class="line">                <span class="built_in">pair</span>[i], <span class="number">0</span>, &amp;revs[i], <span class="keyword">sizeof</span>(revs[i]));</span><br><span class="line"></span><br><span class="line">        revs[i] = lfs_fromle32(revs[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err &amp;&amp; err != LFS_ERR_CORRUPT) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//比较修订计数，找出更大的修订计数</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err != LFS_ERR_CORRUPT &amp;&amp;</span><br><span class="line"></span><br><span class="line">                lfs_scmp(revs[i], revs[(i+<span class="number">1</span>)%<span class="number">2</span>]) &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            r = i;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 现在扫描标签以获取实际目录并找到可能的匹配,要是扫描完找不到匹配的标签,则返回错误</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CRC（32 位） - 检测因断电或其他写入问题而导致的损坏。使用多项式为 0x04c11db7 的 CRC-32，初始化为 0xffffffff。</span></span><br><span class="line"></span><br><span class="line">        <span class="type">uint32_t</span> crc = lfs_crc(<span class="number">0xffffffff</span>, &amp;dir-&gt;rev, <span class="keyword">sizeof</span>(dir-&gt;rev));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  <span class="comment">//循环读取标签 当读取的标签不合法时或者读取的标签超出范围时，退出循环</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// extract next tag</span></span><br><span class="line"></span><br><span class="line">            <span class="type">lfs_tag_t</span> tag;</span><br><span class="line"></span><br><span class="line">            off += lfs_tag_dsize(ptag);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> err = lfs_bd_read(lfs,</span><br><span class="line"></span><br><span class="line">                    <span class="literal">NULL</span>, &amp;lfs-&gt;rcache, lfs-&gt;cfg-&gt;block_size,</span><br><span class="line"></span><br><span class="line">                    dir-&gt;<span class="built_in">pair</span>[<span class="number">0</span>], off, &amp;tag, <span class="keyword">sizeof</span>(tag));</span><br><span class="line"></span><br><span class="line">            crc = lfs_crc(crc, &amp;tag, <span class="keyword">sizeof</span>(tag));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//元数据块支持前向迭代和后向迭代。为了在不重复每个标签的空间的情况下执行此操作，相邻条目将其标签异运算在一起，从 0xffffffff 开始。</span></span><br><span class="line"></span><br><span class="line">            tag = lfs_frombe32(tag) ^ ptag;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//CRC 标签标记了提交的结束，并为元数据块的任何提交提供校验和。</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lfs_tag_type2(tag) == LFS_TYPE_CCRC) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// check the crc attr</span></span><br><span class="line"></span><br><span class="line">                <span class="type">uint32_t</span> dcrc;</span><br><span class="line"></span><br><span class="line">                err = lfs_bd_read(lfs,</span><br><span class="line"></span><br><span class="line">                        <span class="literal">NULL</span>, &amp;lfs-&gt;rcache, lfs-&gt;cfg-&gt;block_size,</span><br><span class="line"></span><br><span class="line">                        dir-&gt;<span class="built_in">pair</span>[<span class="number">0</span>], off+<span class="keyword">sizeof</span>(tag), &amp;dcrc, <span class="keyword">sizeof</span>(dcrc));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (err == LFS_ERR_CORRUPT) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                dcrc = lfs_fromle32(dcrc);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (crc != dcrc) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// reset the next bit if we need to</span></span><br><span class="line"></span><br><span class="line">                ptag ^= (<span class="type">lfs_tag_t</span>)(lfs_tag_chunk(tag) &amp; <span class="number">1U</span>) &lt;&lt; <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// toss our crc into the filesystem seed for</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// pseudorandom numbers, note we use another crc here</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// as a collection function because it is sufficiently</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// random and convenient</span></span><br><span class="line"></span><br><span class="line">                lfs-&gt;seed = lfs_crc(lfs-&gt;seed, &amp;crc, <span class="keyword">sizeof</span>(crc));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// update with what&#x27;s found so far</span></span><br><span class="line"></span><br><span class="line">                besttag = tempbesttag;</span><br><span class="line"></span><br><span class="line">                dir-&gt;off = off + lfs_tag_dsize(tag);</span><br><span class="line"></span><br><span class="line">                dir-&gt;etag = ptag;</span><br><span class="line"></span><br><span class="line">                dir-&gt;count = tempcount;</span><br><span class="line"></span><br><span class="line">                dir-&gt;tail[<span class="number">0</span>] = temptail[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">                dir-&gt;tail[<span class="number">1</span>] = temptail[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                dir-&gt;split = tempsplit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// reset crc, hasfcrc</span></span><br><span class="line"></span><br><span class="line">                crc = <span class="number">0xffffffff</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//对条目进行校验</span></span><br><span class="line"></span><br><span class="line">            err = lfs_bd_crc(lfs,</span><br><span class="line"></span><br><span class="line">                    <span class="literal">NULL</span>, &amp;lfs-&gt;rcache, lfs-&gt;cfg-&gt;block_size,</span><br><span class="line"></span><br><span class="line">                    dir-&gt;<span class="built_in">pair</span>[<span class="number">0</span>], off+<span class="keyword">sizeof</span>(tag),</span><br><span class="line"></span><br><span class="line">                    lfs_tag_dsize(tag)-<span class="keyword">sizeof</span>(tag), &amp;crc);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err == LFS_ERR_CORRUPT) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// directory modification tags?</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lfs_tag_type1(tag) == LFS_TYPE_NAME) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// increase count of files if necessary</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                关键是LFS_TYPE_CREATE是可选的。如果标记的 id 恰好超出了 mdir 的当前大小，则 mdir 会隐式扩展。 这样做的目的是简化 mdir 压缩。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                MDIR 压缩 （lfs_dir_compact） 按照它们在日志中找到的顺序写出标签，这是任意的。使用 CREATE/DELETE 标签对此进行建模会很困难，因为您需要知道已经写出哪些 id，这需要无限内存。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (lfs_tag_id(tag) &gt;= tempcount) &#123;</span><br><span class="line"></span><br><span class="line">                    tempcount = lfs_tag_id(tag) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// next commit not yet programmed?</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!lfs_tag_isvalid(tag)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// we only might be erased if the last tag was a crc</span></span><br><span class="line"></span><br><span class="line">                maybeerased = (lfs_tag_type2(ptag) == LFS_TYPE_CCRC);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// out of range?</span></span><br><span class="line"></span><br><span class="line">            &#125; elseif (off + lfs_tag_dsize(tag) &gt; lfs-&gt;cfg-&gt;block_size) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//fmask 掩码进行过滤, ftag与tag进行比较</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((fmask &amp; tag) == (fmask &amp; ftag)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> res = cb(data, tag, &amp;(<span class="keyword">struct</span> lfs_diskoff)&#123;</span><br><span class="line"></span><br><span class="line">                        dir-&gt;<span class="built_in">pair</span>[<span class="number">0</span>], off+<span class="keyword">sizeof</span>(tag)&#125;);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (res == LFS_CMP_EQ) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// found a match</span></span><br><span class="line"></span><br><span class="line">                    tempbesttag = tag;</span><br><span class="line"></span><br><span class="line">                &#125; elseif ((LFS_MKTAG(<span class="number">0x7ff</span>, <span class="number">0x3ff</span>, <span class="number">0</span>) &amp; tag) ==</span><br><span class="line"></span><br><span class="line">                        (LFS_MKTAG(<span class="number">0x7ff</span>, <span class="number">0x3ff</span>, <span class="number">0</span>) &amp; tempbesttag)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// found an identical tag, but contents didn&#x27;t match</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// this must mean that our besttag has been overwritten</span></span><br><span class="line"></span><br><span class="line">                    tempbesttag = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">                &#125; elseif (res == LFS_CMP_GT &amp;&amp;</span><br><span class="line"></span><br><span class="line">                        lfs_tag_id(tag) &lt;= lfs_tag_id(tempbesttag)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// found a greater match, keep track to keep things sorted</span></span><br><span class="line"></span><br><span class="line">                    tempbesttag = tag | <span class="number">0x80000000</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 没有有效提交记录,换另一个块执行操作</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dir-&gt;off == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// try the other block?</span></span><br><span class="line"></span><br><span class="line">            lfs_pair_swap(dir-&gt;<span class="built_in">pair</span>);</span><br><span class="line"></span><br><span class="line">            dir-&gt;rev = revs[(r+<span class="number">1</span>)%<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查是否被擦除</span></span><br><span class="line"></span><br><span class="line">        dir-&gt;erased = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (maybeerased &amp;&amp; dir-&gt;off % lfs-&gt;cfg-&gt;prog_size == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">ifdef</span> LFS_MULTIVERSION</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// note versions &lt; lfs2.1 did not have fcrc tags, if</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// we&#x27;re &lt; lfs2.1 treat missing fcrc as erased data</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// we don&#x27;t strictly need to do this, but otherwise writing</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// to lfs2.0 disks becomes very inefficient</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lfs_fs_disk_version(lfs) &lt;<span class="number">0x00020001</span>) &#123;</span><br><span class="line"></span><br><span class="line">                dir-&gt;erased = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (hasfcrc) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//在 lfs2.1 中添加的可选 FCRC 标签包含了在下次提交中被擦除时一定数量的字节的校验和。这使我们能够确保我们只对擦除的字节进行编程，即使之前的提交由于断电而失败。</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//如果缺少 FCRC 或校验和不匹配，我们必须假设尝试提交但由于断电而失败。</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// check for an fcrc matching the next prog&#x27;s erased state, if</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// this failed most likely a previous prog was interrupted, we</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// need a new erase</span></span><br><span class="line"></span><br><span class="line">                <span class="type">uint32_t</span> fcrc_ = <span class="number">0xffffffff</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//计算的crc</span></span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> err = lfs_bd_crc(lfs,</span><br><span class="line"></span><br><span class="line">                        <span class="literal">NULL</span>, &amp;lfs-&gt;rcache, lfs-&gt;cfg-&gt;block_size,</span><br><span class="line"></span><br><span class="line">                        dir-&gt;<span class="built_in">pair</span>[<span class="number">0</span>], dir-&gt;off, fcrc.size, &amp;fcrc_);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err &amp;&amp; err != LFS_ERR_CORRUPT) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// found beginning of erased part?</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 指示是否擦除 MDIR 的其余部分。</span></span><br><span class="line"></span><br><span class="line">                dir-&gt;erased = (fcrc_ == fcrc.crc);<span class="comment">//比较计算与存储的crc</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// synthetic move</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查元数据对是否包含正在移动的条目，如果是，则将其视为已删除。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lfs_gstate_hasmovehere(&amp;lfs-&gt;gdisk, dir-&gt;<span class="built_in">pair</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lfs_tag_id(lfs-&gt;gdisk.tag) == lfs_tag_id(besttag)) &#123;</span><br><span class="line"></span><br><span class="line">                besttag |= <span class="number">0x80000000</span>;</span><br><span class="line"></span><br><span class="line">            &#125; elseif (besttag != <span class="number">-1</span> &amp;&amp;</span><br><span class="line"></span><br><span class="line">                    lfs_tag_id(lfs-&gt;gdisk.tag) &lt; lfs_tag_id(besttag)) &#123;</span><br><span class="line"></span><br><span class="line">                besttag -= LFS_MKTAG(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// found tag? or found best id?</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果我们找不到 ids &gt;= 请求的标签,将默认 id 映射到一个合理的值(0x3ff)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 此处用于将所有位设置为 1，lfs_tag_id（-1） =&gt; 0x3ff因为所有位都已设置，如果未找到其他 id，则为 lfs_min（0x3ff， dir-&gt;count） =&gt; dir-&gt;count。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line"></span><br><span class="line">            *id = lfs_min(lfs_tag_id(besttag), dir-&gt;count);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果扫描两个块都找不到任何信息，则返回错误</span></span><br><span class="line"></span><br><span class="line">    LFS_ERROR(<span class="string">&quot;Corrupted dir pair at &#123;0x%&quot;</span>PRIx32<span class="string">&quot;, 0x%&quot;</span>PRIx32<span class="string">&quot;&#125;&quot;</span>,</span><br><span class="line"></span><br><span class="line">            dir-&gt;<span class="built_in">pair</span>[<span class="number">0</span>], dir-&gt;<span class="built_in">pair</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> LFS_ERR_CORRUPT;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lfs-dir-get-lfs-dir-getslice"><a href="#lfs-dir-get-lfs-dir-getslice" class="headerlink" title="lfs_dir_get &amp;&amp; lfs_dir_getslice"></a>lfs_dir_get &amp;&amp; lfs_dir_getslice</h4><ol>
<li>找到了一个匹配的标签，我们就读取与之关联的数据，并将其存储在gbuffer中。如果标签标记为已删除，或者我们没有找到匹配的标签，那么我们就返回一个错误。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/// Metadata pair and directory operations ///</span></span><br><span class="line"></span><br><span class="line">staticlfs_stag_tlfs_dir_getslice(<span class="type">lfs_t</span> *lfs, <span class="type">constlfs_mdir_t</span> *dir,</span><br><span class="line"></span><br><span class="line">        lfs_tag_tgmask, lfs_tag_tgtag,</span><br><span class="line"></span><br><span class="line">        lfs_off_tgoff, <span class="type">void</span> *gbuffer, lfs_size_tgsize) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">lfs_off_t</span> off = dir-&gt;off;</span><br><span class="line"></span><br><span class="line">    <span class="type">lfs_tag_t</span> ntag = dir-&gt;etag;</span><br><span class="line"></span><br><span class="line">    <span class="type">lfs_stag_t</span> gdiff = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// synthetic moves</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// iterate over dir block backwards (for faster lookups)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (off &gt;= <span class="keyword">sizeof</span>(<span class="type">lfs_tag_t</span>) + lfs_tag_dsize(ntag)) &#123;</span><br><span class="line"></span><br><span class="line">        off -= lfs_tag_dsize(ntag);</span><br><span class="line"></span><br><span class="line">        <span class="type">lfs_tag_t</span> tag = ntag;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> err = lfs_bd_read(lfs,</span><br><span class="line"></span><br><span class="line">                <span class="literal">NULL</span>, &amp;lfs-&gt;rcache, <span class="keyword">sizeof</span>(ntag),</span><br><span class="line"></span><br><span class="line">                dir-&gt;<span class="built_in">pair</span>[<span class="number">0</span>], off, &amp;ntag, <span class="keyword">sizeof</span>(ntag));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ntag = (lfs_frombe32(ntag) ^ tag) &amp; <span class="number">0x7fffffff</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lfs_tag_id(gmask) != <span class="number">0</span> &amp;&amp; lfs_tag_type1(tag) == LFS_TYPE_SPLICE &amp;&amp; lfs_tag_id(tag) &lt;= lfs_tag_id(gtag - gdiff)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tag == (LFS_MKTAG(LFS_TYPE_CREATE, <span class="number">0</span>, <span class="number">0</span>) | (LFS_MKTAG(<span class="number">0</span>, <span class="number">0x3ff</span>, <span class="number">0</span>) &amp; (gtag - gdiff)))) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// found where we were created</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> LFS_ERR_NOENT;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// move around splices</span></span><br><span class="line"></span><br><span class="line">            gdiff += LFS_MKTAG(<span class="number">0</span>, lfs_tag_splice(tag), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((gmask &amp; tag) == (gmask &amp; (gtag - gdiff))) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lfs_tag_isdelete(tag)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> LFS_ERR_NOENT;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="type">lfs_size_t</span> diff = lfs_min(lfs_tag_size(tag), gsize);</span><br><span class="line"></span><br><span class="line">            err = lfs_bd_read(lfs,</span><br><span class="line"></span><br><span class="line">                    <span class="literal">NULL</span>, &amp;lfs-&gt;rcache, diff,</span><br><span class="line"></span><br><span class="line">                    dir-&gt;<span class="built_in">pair</span>[<span class="number">0</span>], off+<span class="keyword">sizeof</span>(tag)+goff, gbuffer, diff);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="built_in">memset</span>((<span class="type">uint8_t</span>*)gbuffer + diff, <span class="number">0</span>, gsize - diff);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> tag + gdiff;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> LFS_ERR_NOENT;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lfs-fs-prepsuperblock"><a href="#lfs-fs-prepsuperblock" class="headerlink" title="lfs_fs_prepsuperblock"></a>lfs_fs_prepsuperblock</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">为了跟踪在lfs_mount期间发现的任何过时的次要版本，我们</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">可以从我们的gstate中保留的部分中切出一点。这些都是</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">目前用于计数器中跟踪孤儿的数量</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">In-device gstate tag:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  [--       32      --]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  [1|- 11 -| 10 |1| 9 ]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   ^----^-----^--^--^-- 1-bit has orphans</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        &#x27;-----|--|--|-- 11-bit move type</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">              &#x27;--|--|-- 10-bit move id</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                 &#x27;--|-- 1-bit needs superblock</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    &#x27;-- 9-bit orphan count</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">staticvoidlfs_fs_prepsuperblock(<span class="type">lfs_t</span> *lfs, boolneedssuperblock) &#123;</span><br><span class="line"></span><br><span class="line">    lfs-&gt;gstate.tag = (lfs-&gt;gstate.tag &amp; ~LFS_MKTAG(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0x200</span>))</span><br><span class="line"></span><br><span class="line">            | (<span class="type">uint32_t</span>)needssuperblock &lt;&lt; <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lfs-dir-getgstate"><a href="#lfs-dir-getgstate" class="headerlink" title="lfs_dir_getgstate"></a>lfs_dir_getgstate</h4><ol>
<li>读取dir数据中是否具有 <code>MOVESTATE</code>标签,获取数据,将 <code>gstate</code>的数据更新到 <code>lfs</code>中</li>
</ol>
<h4 id="lfs-fs-traverse"><a href="#lfs-fs-traverse" class="headerlink" title="lfs_fs_traverse_"></a>lfs_fs_traverse_</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">intlfs_fs_traverse_(<span class="type">lfs_t</span> *lfs,</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> (*cb)(<span class="type">void</span> *data, <span class="type">lfs_block_t</span> block), <span class="type">void</span> *data,</span><br><span class="line"></span><br><span class="line">        boolincludeorphans) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// iterate over metadata pairs</span></span><br><span class="line"></span><br><span class="line">    <span class="type">lfs_mdir_t</span> dir = &#123;.tail = &#123;<span class="number">0</span>, <span class="number">1</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!lfs_pair_isnull(dir.tail)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用布伦特算法检测尾部是否有环</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> err = cb(data, dir.tail[i]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历目录中的 ids</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> err = lfs_dir_fetch(lfs, &amp;dir, dir.tail);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">uint16_t</span> id = <span class="number">0</span>; id &lt; dir.count; id++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">lfs_ctz</span> <span class="title">ctz</span>;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取CTZ指针</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lfs_tag_type3(tag) == LFS_TYPE_CTZSTRUCT) &#123;</span><br><span class="line"></span><br><span class="line">                err = lfs_ctz_traverse(lfs, <span class="literal">NULL</span>, &amp;lfs-&gt;rcache,</span><br><span class="line"></span><br><span class="line">                        ctz.head, ctz.size, cb, data);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; elseif (includeorphans &amp;&amp;</span><br><span class="line"></span><br><span class="line">                    lfs_tag_type3(tag) == LFS_TYPE_DIRSTRUCT) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//孤立节点执行操作</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">                    err = cb(data, (&amp;ctz.head)[i]);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lfs-alloc"><a href="#lfs-alloc" class="headerlink" title="lfs_alloc"></a>lfs_alloc</h4><ol>
<li>从 <code>lookahead</code>缓冲区中查找空闲块</li>
<li>如果 <code>lookahead</code>缓冲区中没有空闲块,则扫描文件系统以查找下一个 <code>lookahead</code>窗口中的未使用块</li>
<li>如果 <code>lookahead</code>缓冲区中有空闲块,则返回空闲块;并且寻找下一个空闲块</li>
<li>littlefs 中的块分配器是磁盘大小的位图和暴力遍历之间的折衷方案。我们跟踪的不是存储大小的位图，而是一个名为 lookahead 缓冲区的小型固定大小的位图。在区块分配期间，我们从 lookahead 缓冲区中获取区块。如果 lookahead 缓冲区为空，我们将扫描文件系统以查找更多空闲块，从而填充我们的 lookahead 缓冲区。在每次扫描中，我们都使用一个递增的偏移量，在分配块时围绕存储圈。</li>
<li>这种前瞻方法的运行时复杂度为 O（n²），用于完全扫描存储;但是，位图非常紧凑，实际上通常只需要一到两次通道即可找到空闲块。此外，可以通过调整块大小或 lookahead 缓冲区的大小来优化分配器的性能，以写入粒度或 RAM 来交换分配器性能。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticintlfs_alloc(<span class="type">lfs_t</span> *lfs, <span class="type">lfs_block_t</span> *block) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// scan our lookahead buffer for free blocks</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (lfs-&gt;lookahead.next &lt; lfs-&gt;lookahead.size) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!(lfs-&gt;lookahead.buffer[lfs-&gt;lookahead.next / <span class="number">8</span>]    <span class="comment">//是获取位图中对应的字节</span></span><br><span class="line"></span><br><span class="line">                    &amp; (<span class="number">1U</span> &lt;&lt; (lfs-&gt;lookahead.next % <span class="number">8</span>)))) &#123;         <span class="comment">// 创建一个只有特定位置为1的掩码</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// found a free block</span></span><br><span class="line"></span><br><span class="line">                *block = (lfs-&gt;lookahead.start + lfs-&gt;lookahead.next)</span><br><span class="line"></span><br><span class="line">                        % lfs-&gt;block_count;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// eagerly find next free block to maximize how many blocks</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// lfs_alloc_ckpoint makes available for scanning</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    lfs-&gt;lookahead.next += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    lfs-&gt;lookahead.ckpoint -= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (lfs-&gt;lookahead.next &gt;= lfs-&gt;lookahead.size</span><br><span class="line"></span><br><span class="line">                            || !(lfs-&gt;lookahead.buffer[lfs-&gt;lookahead.next / <span class="number">8</span>]</span><br><span class="line"></span><br><span class="line">                                &amp; (<span class="number">1U</span> &lt;&lt; (lfs-&gt;lookahead.next % <span class="number">8</span>)))) &#123;</span><br><span class="line"></span><br><span class="line">                        return0;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            lfs-&gt;lookahead.next += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            lfs-&gt;lookahead.ckpoint -= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// In order to keep our block allocator from spinning forever when our</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// filesystem is full, we mark points where there are no in-flight</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// allocations with a checkpoint before starting a set of allocations.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we&#x27;ve looked at all blocks since the last checkpoint, we report</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// the filesystem as out of storage.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lfs-&gt;lookahead.ckpoint &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            LFS_ERROR(<span class="string">&quot;No more free space 0x%&quot;</span>PRIx32,</span><br><span class="line"></span><br><span class="line">                    (lfs-&gt;lookahead.start + lfs-&gt;lookahead.next)</span><br><span class="line"></span><br><span class="line">                        % lfs-&gt;block_count);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> LFS_ERR_NOSPC;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// No blocks in our lookahead buffer, we need to scan the filesystem for</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// unused blocks in the next lookahead window.</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> err = lfs_alloc_scan(lfs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(err) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对位图进行填充</span></span><br><span class="line"></span><br><span class="line">staticintlfs_alloc_lookahead(<span class="type">void</span> *p, lfs_block_tblock) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">lfs_t</span> *lfs = (<span class="type">lfs_t</span>*)p;</span><br><span class="line"></span><br><span class="line">    <span class="type">lfs_block_t</span> off = ((block - lfs-&gt;lookahead.start)</span><br><span class="line"></span><br><span class="line">            + lfs-&gt;block_count) % lfs-&gt;block_count;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (off &lt; lfs-&gt;lookahead.size) &#123;</span><br><span class="line"></span><br><span class="line">        lfs-&gt;lookahead.buffer[off / <span class="number">8</span>] |= <span class="number">1U</span> &lt;&lt; (off % <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">staticintlfs_alloc_scan(<span class="type">lfs_t</span> *lfs) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// move lookahead buffer to the first unused block</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// note we limit the lookahead buffer to at most the amount of blocks</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// checkpointed, this prevents the math in lfs_alloc from underflowing</span></span><br><span class="line"></span><br><span class="line">    lfs-&gt;lookahead.start = (lfs-&gt;lookahead.start + lfs-&gt;lookahead.next) </span><br><span class="line"></span><br><span class="line">            % lfs-&gt;block_count;</span><br><span class="line"></span><br><span class="line">    lfs-&gt;lookahead.next = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    lfs-&gt;lookahead.size = lfs_min(</span><br><span class="line"></span><br><span class="line">            <span class="number">8</span>*lfs-&gt;cfg-&gt;lookahead_size,</span><br><span class="line"></span><br><span class="line">            lfs-&gt;lookahead.ckpoint);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// find mask of free blocks from tree</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(lfs-&gt;lookahead.buffer, <span class="number">0</span>, lfs-&gt;cfg-&gt;lookahead_size);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> err = lfs_fs_traverse_(lfs, lfs_alloc_lookahead, lfs, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">        lfs_alloc_drop(lfs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="lfs-bd-flush"><a href="#lfs-bd-flush" class="headerlink" title="lfs_bd_flush"></a>lfs_bd_flush</h4><ul>
<li>执行 <code>prog</code>写入,根据 <code>validate</code>的值,决定是否需要校验写入的数据</li>
</ul>
<h4 id="lfs-bd-prog"><a href="#lfs-bd-prog" class="headerlink" title="lfs_bd_prog"></a>lfs_bd_prog</h4><ul>
<li>通过pcache缓存写入数据</li>
</ul>
<ol>
<li>搬运数据至 <code>pcache</code>缓存</li>
</ol>
<p>2.<code>pcache</code>缓存大小等于 <code>cache_size</code>时,将 <code>pcache</code>缓存通过 <code>flush</code>写入 <code>block</code>块</p>
<ol start="3">
<li>重新设置 <code>pcache</code>缓存</li>
</ol>
<h4 id="int-lfs-file-relocate-lfs-t-lfs-lfs-file-t-file"><a href="#int-lfs-file-relocate-lfs-t-lfs-lfs-file-t-file" class="headerlink" title="int lfs_file_relocate(lfs_t *lfs, lfs_file_t *file)"></a>int lfs_file_relocate(lfs_t *lfs, lfs_file_t *file)</h4><ul>
<li>重新对 <code>file</code>进行定位,并且重新分配 <code>block</code>块</li>
</ul>
<ol>
<li>通过 <code>lfs_alloc</code>重新分配 <code>block</code>块</li>
<li>通过 <code>lfs_bd_erase</code>擦除 <code>block</code>块</li>
<li>通过 <code>lfs_bd_read</code>或 <code>lfs_dir_getread</code>读取 <code>file</code>块的数据</li>
<li>通过 <code>lfs_bd_prog</code>写入 <code>block</code>块的数据</li>
</ol>
<h4 id="lfs-file-outline"><a href="#lfs-file-outline" class="headerlink" title="lfs_file_outline"></a>lfs_file_outline</h4><ul>
<li>将文件从目录中移出</li>
</ul>
<ol>
<li>重新分配该文件所在的块</li>
<li>将文件 <code>flag</code>取消在目录中的标记</li>
</ol>
<h4 id="lfs-file-flush"><a href="#lfs-file-flush" class="headerlink" title="lfs_file_flush"></a>lfs_file_flush</h4><ol>
<li>在单个元数据对中存储多个文件，而不是为每个文件提供自己的元数据对。一种方法是直接将目录与元数据对（或元数据对的链接列表）关联。这使得多个文件可以轻松地共享目录的元数据对以进行日志记录，并减少集体存储开销。</li>
<li>第二个改进是注意到，对于非常小的文件，我们尝试使用 CTZ 跳过列表来压缩存储适得其反。元数据对的存储成本是 ~4 倍，因此，如果我们的文件小于块大小的 1&#x2F;4，那么在元数据对之外存储文件实际上没有任何好处。</li>
<li>在这种情况下，我们可以将文件直接存储在目录的元数据对中。我们称之为内联文件，它允许目录非常有效地存储许多小文件。我们之前的 4 字节文件现在在磁盘上只占用理论上的 16 个字节。</li>
<li>一旦文件超过块大小的 1&#x2F;4，我们就会切换到 CTZ 跳过列表。这意味着我们的文件使用的存储开销永远不会超过 4 倍，并且随着文件大小的增长而减少。</li>
<li>如果 <code>file-&gt;pos &lt; file-&gt;ctz.size</code>, 通过 <code>lfs_file_flushedread(lfs, &amp;orig, &amp;data, 1);</code>寻找 <code>ctz</code>,在通过 <code>lfs_file_flushedwrite(lfs, file, &amp;data, 1)</code>写入</li>
<li>否则直接进行 <code>lfs_bd_flush(lfs, &amp;file-&gt;cache, &amp;lfs-&gt;rcache, true);</code></li>
</ol>
<p>3.<code>lfs_bd_flush</code>失败为 <code>LFS_ERR_CORRUPT</code>,则进行 <code>lfs_file_relocate</code>再次尝试写入</p>
<h4 id="lfs-dir-orphaningcommit"><a href="#lfs-dir-orphaningcommit" class="headerlink" title="lfs_dir_orphaningcommit"></a>lfs_dir_orphaningcommit</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticintlfs_dir_orphaningcommit(<span class="type">lfs_t</span> *lfs, <span class="type">lfs_mdir_t</span> *dir,</span><br><span class="line"></span><br><span class="line">        conststruct lfs_mattr *attrs, intattrcount) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check for any inline files that aren&#x27;t RAM backed and</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// forcefully evict them, needed for filesystem consistency</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">lfs_file_t</span> *f = (<span class="type">lfs_file_t</span>*)lfs-&gt;mlist; f; f = f-&gt;next) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dir != &amp;f-&gt;m                            <span class="comment">//目录不是文件的当前目录</span></span><br><span class="line"></span><br><span class="line">        &amp;&amp; lfs_pair_cmp(f-&gt;m.<span class="built_in">pair</span>, dir-&gt;<span class="built_in">pair</span>) == <span class="number">0</span>  <span class="comment">//文件目录和当前目录的元数据对相同</span></span><br><span class="line"></span><br><span class="line">        &amp;&amp; f-&gt;type == LFS_TYPE_REG &amp;&amp; (f-&gt;flags &amp; LFS_F_INLINE) <span class="comment">//文件是正常文件并且是内联文件</span></span><br><span class="line"></span><br><span class="line">        &amp;&amp; f-&gt;ctz.size &gt; lfs-&gt;cfg-&gt;cache_size) &#123;    <span class="comment">//文件的大小超过缓存大小</span></span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> err = lfs_file_outline(lfs, f);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            err = lfs_file_flush(lfs, f);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="lfs-init"><a href="#lfs-init" class="headerlink" title="lfs_init"></a>lfs_init</h3><ul>
<li>2<em>4 不理解 ??? 2</em>4是块元数据的大小，这些元数据在块的开始和结束处有两个副本</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// common filesystem initialization</span></span><br><span class="line"></span><br><span class="line">staticintlfs_init(<span class="type">lfs_t</span> *lfs, conststruct lfs_config *cfg)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check that the block size is large enough to fit all ctz pointers</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Littlefs 使用 32 位的字宽，因此只有当指针小于 104 个字节时，我们的块才能溢出指针。</span></span><br><span class="line"></span><br><span class="line">    LFS_ASSERT(lfs-&gt;cfg-&gt;block_size &gt;= <span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this is the exact calculation for all ctz pointers, if this fails</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// and the simpler assert above does not, math must be broken</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// lfs-&gt;cfg-&gt;block_size-2*4：这是计算每个块的有效大小，其中2*4是块元数据的大小，这些元数据在块的开始和结束处有两个副本</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xffffffff / (lfs-&gt;cfg-&gt;block_size-2*4)：这是计算在给定的块大小下，一个块可以容纳的最大文件大小。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//lfs_npw2(0xffffffff / (lfs-&gt;cfg-&gt;block_size-2*4))：lfs_npw2函数计算最接近给定数值的2的幂次方。这是因为在许多文件系统中，文件大小通常是2的幂次方。</span></span><br><span class="line"></span><br><span class="line">    LFS_ASSERT(<span class="number">4</span>*lfs_npw2(<span class="number">0xffffffff</span> / (lfs-&gt;cfg-&gt;block_size<span class="number">-2</span>*<span class="number">4</span>)) &lt;= lfs-&gt;cfg-&gt;block_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 元数据不能压缩到 block_size/2 以下，并且元数据不能超过 block_size</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//block_size/2是划分元数据块的阈值，因此合并后所有元数据块都应该放入block_size/2。使用该值作为lfs_fs_gc的下限，意味着如果尝试合并，总是可以保证有进展。</span></span><br><span class="line"></span><br><span class="line">    LFS_ASSERT(lfs-&gt;cfg-&gt;compact_thresh == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            || lfs-&gt;cfg-&gt;compact_thresh &gt;= lfs-&gt;cfg-&gt;block_size/<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    LFS_ASSERT(lfs-&gt;cfg-&gt;compact_thresh == (<span class="type">lfs_size_t</span>)<span class="number">-1</span></span><br><span class="line"></span><br><span class="line">            || lfs-&gt;cfg-&gt;compact_thresh &lt;= lfs-&gt;cfg-&gt;block_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup default state</span></span><br><span class="line"></span><br><span class="line">    lfs-&gt;root[<span class="number">0</span>] = LFS_BLOCK_NULL;</span><br><span class="line"></span><br><span class="line">    lfs-&gt;root[<span class="number">1</span>] = LFS_BLOCK_NULL;</span><br><span class="line"></span><br><span class="line">    lfs-&gt;mlist = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    lfs-&gt;seed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    lfs-&gt;gdisk = (<span class="type">lfs_gstate_t</span>)&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    lfs-&gt;gstate = (<span class="type">lfs_gstate_t</span>)&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    lfs-&gt;gdelta = (<span class="type">lfs_gstate_t</span>)&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mount-1"><a href="#mount-1" class="headerlink" title="mount"></a>mount</h3><ol>
<li>初始化lfs加载的驱动配置</li>
<li>扫描目录块,找到超级块,并且名称是”littlefs”的目录的tag</li>
<li>获取超级块的版本与配置信息,进行检查与赋值</li>
<li>更新 <code>lfs</code>的 <code>gstate</code>,<code>gdisk</code>,<code>lookahead.start</code></li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticintlfs_mount_(<span class="type">lfs_t</span> *lfs, conststruct lfs_config *cfg) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> err = lfs_init(lfs, cfg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// scan directory blocks for superblock and any global updates</span></span><br><span class="line"></span><br><span class="line">    <span class="type">lfs_mdir_t</span> dir = &#123;.tail = &#123;<span class="number">0</span>, <span class="number">1</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">    lfs_block_ttortoise[<span class="number">2</span>] = &#123;LFS_BLOCK_NULL, LFS_BLOCK_NULL&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">lfs_size_t</span> tortoise_i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">lfs_size_t</span> tortoise_period = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!lfs_pair_isnull(dir.tail)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用布伦特算法检测 尾部数据是否存在循环</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lfs_pair_issync(dir.tail, tortoise)) &#123;</span><br><span class="line"></span><br><span class="line">            LFS_WARN(<span class="string">&quot;Cycle detected in tail list&quot;</span>);</span><br><span class="line"></span><br><span class="line">            err = LFS_ERR_CORRUPT;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tortoise_i == tortoise_period) &#123;</span><br><span class="line"></span><br><span class="line">            tortoise[<span class="number">0</span>] = dir.tail[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">            tortoise[<span class="number">1</span>] = dir.tail[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            tortoise_i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            tortoise_period *= <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tortoise_i += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// fetch next block in tail list</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//找到超级块并且名称是&quot;littlefs&quot;的目录的tag</span></span><br><span class="line"></span><br><span class="line">        <span class="type">lfs_stag_t</span> tag = lfs_dir_fetchmatch(lfs, &amp;dir, dir.tail,</span><br><span class="line"></span><br><span class="line">                LFS_MKTAG(<span class="number">0x7ff</span>, <span class="number">0x3ff</span>, <span class="number">0</span>),             <span class="comment">//过滤器掩码 所有type+id都可以,忽略长度</span></span><br><span class="line"></span><br><span class="line">                LFS_MKTAG(LFS_TYPE_SUPERBLOCK, <span class="number">0</span>, <span class="number">8</span>),   <span class="comment">//超级块标签</span></span><br><span class="line"></span><br><span class="line">                <span class="literal">NULL</span>,</span><br><span class="line"></span><br><span class="line">                lfs_dir_find_match,                     <span class="comment">//目录查找匹配</span></span><br><span class="line"></span><br><span class="line">                &amp;(<span class="keyword">struct</span> lfs_dir_find_match)&#123;</span><br><span class="line"></span><br><span class="line">                    lfs, </span><br><span class="line"></span><br><span class="line">                    <span class="string">&quot;littlefs&quot;</span>,                         <span class="comment">//查找名称为littlefs的目录</span></span><br><span class="line"></span><br><span class="line">                    <span class="number">8</span></span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tag &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            err = tag;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到超级块且未被擦除</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tag &amp;&amp; !lfs_tag_isdelete(tag)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// update root</span></span><br><span class="line"></span><br><span class="line">            lfs-&gt;root[<span class="number">0</span>] = dir.<span class="built_in">pair</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">            lfs-&gt;root[<span class="number">1</span>] = dir.<span class="built_in">pair</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// grab superblock</span></span><br><span class="line"></span><br><span class="line">            <span class="type">lfs_superblock_t</span> superblock;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取超级块的版本与配置信息</span></span><br><span class="line"></span><br><span class="line">            tag = lfs_dir_get(lfs, &amp;dir, LFS_MKTAG(<span class="number">0x7ff</span>, <span class="number">0x3ff</span>, <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">            <span class="comment">// superblock 条目的内容存储在具有 superblock 类型和 inline-struct 标签的名称标签中。name 标签包含魔术字符串 “littlefs”，而 inline-struct 标签包含版本和配置信息。</span></span><br><span class="line"></span><br><span class="line">                    LFS_MKTAG(LFS_TYPE_INLINESTRUCT, <span class="number">0</span>, <span class="keyword">sizeof</span>(superblock)),</span><br><span class="line"></span><br><span class="line">                    &amp;superblock);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// check version</span></span><br><span class="line"></span><br><span class="line">          </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// found older minor version? set an in-device only bit in the</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// gstate so we know we need to rewrite the superblock before</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// the first write</span></span><br><span class="line"></span><br><span class="line">            <span class="type">bool</span> needssuperblock = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (minor_version &lt; lfs_fs_disk_version_minor(lfs)) &#123;</span><br><span class="line"></span><br><span class="line">                LFS_DEBUG(<span class="string">&quot;Found older minor version &quot;</span>);</span><br><span class="line"></span><br><span class="line">                needssuperblock = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// note this bit is reserved on disk, so fetching more gstate</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// will not interfere here</span></span><br><span class="line"></span><br><span class="line">            lfs_fs_prepsuperblock(lfs, needssuperblock);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// has gstate?</span></span><br><span class="line"></span><br><span class="line">        err = lfs_dir_getgstate(lfs, &amp;dir, &amp;lfs-&gt;gstate);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// update littlefs with gstate</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!lfs_gstate_iszero(&amp;lfs-&gt;gstate)) &#123;</span><br><span class="line"></span><br><span class="line">        LFS_DEBUG(<span class="string">&quot;Found pending gstate 0x%08&quot;</span>PRIx32<span class="string">&quot;%08&quot;</span>PRIx32<span class="string">&quot;%08&quot;</span>PRIx32,</span><br><span class="line"></span><br><span class="line">                lfs-&gt;gstate.tag,</span><br><span class="line"></span><br><span class="line">                lfs-&gt;gstate.<span class="built_in">pair</span>[<span class="number">0</span>],</span><br><span class="line"></span><br><span class="line">                lfs-&gt;gstate.<span class="built_in">pair</span>[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lfs-&gt;gstate.tag += !lfs_tag_isvalid(lfs-&gt;gstate.tag);</span><br><span class="line"></span><br><span class="line">    lfs-&gt;gdisk = lfs-&gt;gstate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup free lookahead, to distribute allocations uniformly across</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// boots, we start the allocator at a random location</span></span><br><span class="line"></span><br><span class="line">    lfs-&gt;lookahead.start = lfs-&gt;seed % lfs-&gt;block_count;</span><br><span class="line"></span><br><span class="line">    lfs_alloc_drop(lfs);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="format"><a href="#format" class="headerlink" title="format"></a>format</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">staticintlfs_format_(<span class="type">lfs_t</span> *lfs, conststruct lfs_config *cfg) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// create root dir</span></span><br><span class="line"></span><br><span class="line">        <span class="type">lfs_mdir_t</span> root;</span><br><span class="line"></span><br><span class="line">        err = lfs_dir_alloc(lfs, &amp;root);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        err = lfs_dir_commit(lfs, &amp;root, LFS_MKATTRS(</span><br><span class="line"></span><br><span class="line">                &#123;LFS_MKTAG(LFS_TYPE_CREATE, <span class="number">0</span>, <span class="number">0</span>), <span class="literal">NULL</span>&#125;,</span><br><span class="line"></span><br><span class="line">                &#123;LFS_MKTAG(LFS_TYPE_SUPERBLOCK, <span class="number">0</span>, <span class="number">8</span>), <span class="string">&quot;littlefs&quot;</span>&#125;,</span><br><span class="line"></span><br><span class="line">                &#123;LFS_MKTAG(LFS_TYPE_INLINESTRUCT, <span class="number">0</span>, <span class="keyword">sizeof</span>(superblock)),</span><br><span class="line"></span><br><span class="line">                    &amp;superblock&#125;));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wdfk-prog">Liya Huang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wdfk-prog.space/posts/a5eec7a4/">https://wdfk-prog.space/posts/a5eec7a4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://wdfk-prog.space" target="_blank">wdfk-prog的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/rt-thread/">rt-thread</a></div><div class="post-share"><div class="social-share" data-image="/images/covers/06.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/images/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/images/alipay.png" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/alipay.png" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/fa82c01a/" title="RT-Thread 学习笔记"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/03.jpg" onerror="onerror=null;src='/images/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">RT-Thread 学习笔记</div></div><div class="info-2"><div class="info-item-1">RT-Thread 学习笔记  其他资料   1.1. fatfs 1.1.1. fatfs.md     2. ARM指针寄存器.md 3. CAN驱动.md 4. completion.md 5. condvar.md 6. dataqueue.md 7. DFS.md 8. fal.md 9. fatfs.md 10. FINSH模块.md 11. I2C驱动.md 12. IDLE线程.md 13. IPC.md 14. littlefs.md 15. map文件分析.md 16. pipe.md 17. PM电源管理.md 18. readme.md 19. ringblock.md 20. ringbuffer.md 21. romfs.md 22. RTC.md 23. RT-LINK.md 24. RTT系统初始化.md 25. SDMMC.md 26. SIGNAL.md 27. SPI驱动.md 28. tmpfs.md 29. ULOG.md 30. USB.md 31. waitqueue.md 32. 串口驱动.md 33. 调度.md 34. 工作队列...</div></div></div></a><a class="pagination-related" href="/posts/59c8d408/" title="waitqueue"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/02.jpg" onerror="onerror=null;src='/images/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">waitqueue</div></div><div class="info-2"><div class="info-item-1">waitqueue初始化12345678910111213rt_inline voidrt_wqueue_init(rt_wqueue_t *queue)&#123;    RT_ASSERT(queue != RT_NULL);    queue-&gt;flag = RT_WQ_FLAG_CLEAN;                // 将队列设置为可插入状态    rt_list_init(&amp;(queue-&gt;waiting_list));        // 初始化链表节点&#125;  加入队列线程加入队列有两种方式：  阻塞式加入：这种方式类似于信号量的用法，当参数condition为 0 时，线程会被阻塞，并将含有线程信息的等待节点加入到等待队列中。  123intrt_wqueue_wait(rt_wqueue_t *queue, intcondition, intmsec)  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/fa99c9bd/" title="fatfs"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/04.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">fatfs</div></div><div class="info-2"><div class="info-item-1">fatfs 因此应用程序应尽可能以大块的形式写入数据。理想的写入块大小和对齐方式是扇区大小，簇大小最好。当然，应用程序和存储设备之间的所有层都必须考虑多扇区写入，但大多数开源存储卡驱动程序都缺乏这一点。不要将多扇区写入请求拆分为单扇区写入事务，否则写入吞吐量会变差。 努力实现扇区对齐的读&#x2F;写访问可以消除缓冲数据传输，从而提高读&#x2F;写性能。除此之外，在 tiny 配置下，缓存的 FAT 数据不会被文件数据传输刷新，因此它可以以较小的内存占用实现与非 tiny 配置相同的性能。 如果由于意外故障（例如突然断电、错误移除介质和不可恢复的磁盘错误）而中断对 FAT 卷的写入操作，则卷上的 FAT 结构可能会被破坏。为了最大限度地降低数据丢失的风险，可以通过最小化以写入模式打开文件的时间或使用f_sync函数来最小化临界区 FatFs 模块不支持对文件的重复打开的读写冲突控制。仅当对文件的每种打开方式都是读取模式时才允许重复打开。始终禁止对文件进行一次或多次写入模式的重复打开，并且打开的文件不得重命名或删除。违反这些规则可能会导致数据冲突。  文件系统操作mkfs 格式化...</div></div></div></a><a class="pagination-related" href="/posts/afef3039/" title="CAN驱动"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/06.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">CAN驱动</div></div><div class="info-2"><div class="info-item-1">CAN驱动CAN驱动框架CAN初始化-rt_hw_can_register注册CAN设备,并初始化互斥量 -rt_timer_init初始化CAN定时器,注册定时器回调函数 cantimeout 初始化&amp;&amp;配置 RT_CAN_CMD_SET_PRIV  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960if (can-&gt;config.privmode)            &#123;                for (i = 0;  i &lt; can-&gt;config.sndboxnumber; i++)                &#123;                    level = rt_hw_interrupt_disable();                    if(rt_list_isempty(&amp;tx_fifo-&gt;buff...</div></div></div></a><a class="pagination-related" href="/posts/386931f6/" title="PM电源管理"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/05.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">PM电源管理</div></div><div class="info-2"><div class="info-item-1">PM电源管理初始化drv_pm_hw_init -&gt; rt_system_pm_init 1234567891011121314/* initialize timer mask */timer_mask = 1UL &lt;&lt; PM_SLEEP_MODE_DEEP;/* when system power on, set default sleep modes */pm-&gt;modes[pm-&gt;sleep_mode] = 1;pm-&gt;module_status[PM_POWER_ID].req_status = 1;pm-&gt;run_mode   = RT_PM_DEFAULT_RUN_MODE;  pm设备注册12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182/** * Register a...</div></div></div></a><a class="pagination-related" href="/posts/fdf8ebd7/" title="FINSH模块"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/04.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">FINSH模块</div></div><div class="info-2"><div class="info-item-1">FINSH模块MSH初始化 根据链接脚本指明FINSH使用内存空间 _syscall_table_begin _syscall_table_end的地址  FSymtab段1234. = ALIGN(4);__fsymtab_start = .;KEEP(*(FSymTab))__fsymtab_end = .;   __fsymtab_start和 __fsymtab_end用于指明finsh使用内存 FSymTab用于存放所有注册命令的结构体 struct finsh_syscall,包括命令名称,命令选项,命令描述,命令函数执行地址信息  宏12345678910111213141516171819202122232425262728293031/** * @ingroup msh * * This macro exports a command to module shell. * * @param command is the name of the command. * @param desc is the description of the command, wh...</div></div></div></a><a class="pagination-related" href="/posts/dc9314c3/" title="DFS"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/09.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">DFS</div></div><div class="info-2"><div class="info-item-1">DFS 虚拟文件系统https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/programming-manual/filesystem/filesystem 123456789101112131415161718FatFS 是专为小型嵌入式设备开发的一个兼容微软 FAT 格式的文件系统，采用 ANSI C 编写，具有良好的硬件无关性以及可移植性，是 RT-Thread 中最常用的文件系统类型。传统型的 RomFS 文件系统是一种简单的、紧凑的、只读的文件系统，不支持动态擦写保存，按顺序存放数据，因而支持应用程序以 XIP(execute In Place，片内运行) 方式运行，在系统运行时, 节省 RAM 空间。Jffs2 文件系统是一种日志闪存文件系统。主要用于 NOR 型闪存，基于 MTD 驱动层，特点是：可读写的、支持数据压缩的、基于哈希表的日志型文件系统，并提供了崩溃 / 掉电安全保护，提供写平衡支持等。DevFS 即设备文件系统，在 RT-Thread 操作系统中开启该...</div></div></div></a><a class="pagination-related" href="/posts/6e6a3ae8/" title="ARM指针寄存器"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/07.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-03</div><div class="info-item-2">ARM指针寄存器</div></div><div class="info-2"><div class="info-item-1">ARM指针寄存器 https://blog.csdn.net/zhuguanlin121/article/details/120883025  -堆栈指针r13 SP：每一种异常模式都有其自己独立的r13，它通常指向异常模式所专用的堆栈，也就是说五种异常模式、非异常模式（用户模式和系统模式），都有各自独立的堆栈，用不同的堆栈指针来索引。这样当ARM进入异常模式的时候，程序就可以把一般通用寄存器压入堆栈，返回时再出栈，保证了各种模式下程序的状态的完整性。 栈顶指针（Stack Pointer）是寄存器页的核心，用以指向系统栈的栈顶位置，某些情况下也可以作为通用寄存器来使用，例如，在 ARM Cortex M 内核中，SP 可以作为 R13 来使用。由于栈是函数式语言的核心，在操作系统中 SP 的地位举足轻重，以 RT-Thread 为例，每个用户任务都有独享的栈，任务的切换几乎就是栈的切换，也就是栈顶指针的切换，我们可以毫不夸张的说：栈顶指针就是每个任务的生命线。 -连接寄存器r14 LR：每种模式下r14都有自身版组，它有两个特殊功能。 （1）保存子程序返回地址。使用BL或BLX...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/avatar.png" onerror="this.onerror=null;this.src='/images/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Liya Huang</div><div class="author-info-description">WORK-LIFE BALANCE</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">417</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">49</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">53</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wdfk-prog"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/wdfk-prog" rel="external nofollow noreferrer" target="_blank" title="GitHub"><i class="fab fa-github" style="color: #181717;"></i></a><a class="social-icon" href="https://wdfk-prog.blog.csdn.net/" rel="external nofollow noreferrer" target="_blank" title="CSDN"><i class="fas fa-blog" style="color: #FC5531;"></i></a><a class="social-icon" href="mailto:1425075683@qq.com" rel="external nofollow noreferrer" target="_blank" title="E-mail"><i class="fas fa-envelope" style="color: #4A4A4A;"></i></a><a class="social-icon" href="/images/wechat-qrcode.jpg" target="_blank" title="微信公众号"><i class="fab fa-weixin" style="color: #07C160;"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #EE802F;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎光临！有任何问题或想法，欢迎在文章下留言交流，或者通过 <a href='/about/'>关于页面</a> 联系我。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#littlefs"><span class="toc-number">1.</span> <span class="toc-text">littlefs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%BA%E5%88%B6"><span class="toc-number">1.1.</span> <span class="toc-text">机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E5%AF%B9"><span class="toc-number">1.1.1.</span> <span class="toc-text">元数据对</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6-%E5%8E%8B%E7%BC%A9"><span class="toc-number">1.1.2.</span> <span class="toc-text">垃圾回收,压缩</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CTZ%E8%B7%B3%E8%BF%87%E5%88%97%E8%A1%A8"><span class="toc-number">1.1.3.</span> <span class="toc-text">CTZ跳过列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%97%E5%88%86%E9%85%8D%E5%99%A8"><span class="toc-number">1.1.4.</span> <span class="toc-text">块分配器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E5%92%8C%E6%81%A2%E5%A4%8D%E5%9D%8F%E5%9D%97"><span class="toc-number">1.1.5.</span> <span class="toc-text">检测和恢复坏块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A3%A8%E6%8D%9F%E5%9D%87%E8%A1%A1"><span class="toc-number">1.1.6.</span> <span class="toc-text">磨损均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.7.</span> <span class="toc-text">文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.1.8.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%A7%BB%E5%8A%A8"><span class="toc-number">1.1.9.</span> <span class="toc-text">文件移动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gdiff"><span class="toc-number">1.1.10.</span> <span class="toc-text">gdiff</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.1.11.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C"><span class="toc-number">1.2.</span> <span class="toc-text">文件系统操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mount"><span class="toc-number">1.2.1.</span> <span class="toc-text">mount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mkfs"><span class="toc-number">1.2.2.</span> <span class="toc-text">mkfs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.</span> <span class="toc-text">文件操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#module"><span class="toc-number">1.4.</span> <span class="toc-text">module</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#other"><span class="toc-number">1.4.1.</span> <span class="toc-text">other</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tag"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">tag</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-bd-read"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">lfs_bd_read</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-bd-cmp"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">lfs_bd_cmp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-dir-find-match"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">lfs_dir_find_match</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-gstate-hasmovehere"><span class="toc-number">1.4.1.5.</span> <span class="toc-text">lfs_gstate_hasmovehere</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fetchmatch"><span class="toc-number">1.4.1.6.</span> <span class="toc-text">fetchmatch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-dir-get-lfs-dir-getslice"><span class="toc-number">1.4.1.7.</span> <span class="toc-text">lfs_dir_get &amp;&amp; lfs_dir_getslice</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-fs-prepsuperblock"><span class="toc-number">1.4.1.8.</span> <span class="toc-text">lfs_fs_prepsuperblock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-dir-getgstate"><span class="toc-number">1.4.1.9.</span> <span class="toc-text">lfs_dir_getgstate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-fs-traverse"><span class="toc-number">1.4.1.10.</span> <span class="toc-text">lfs_fs_traverse_</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-alloc"><span class="toc-number">1.4.1.11.</span> <span class="toc-text">lfs_alloc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-bd-flush"><span class="toc-number">1.4.1.12.</span> <span class="toc-text">lfs_bd_flush</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-bd-prog"><span class="toc-number">1.4.1.13.</span> <span class="toc-text">lfs_bd_prog</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#int-lfs-file-relocate-lfs-t-lfs-lfs-file-t-file"><span class="toc-number">1.4.1.14.</span> <span class="toc-text">int lfs_file_relocate(lfs_t *lfs, lfs_file_t *file)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-file-outline"><span class="toc-number">1.4.1.15.</span> <span class="toc-text">lfs_file_outline</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-file-flush"><span class="toc-number">1.4.1.16.</span> <span class="toc-text">lfs_file_flush</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lfs-dir-orphaningcommit"><span class="toc-number">1.4.1.17.</span> <span class="toc-text">lfs_dir_orphaningcommit</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lfs-init"><span class="toc-number">1.4.2.</span> <span class="toc-text">lfs_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mount-1"><span class="toc-number">1.4.3.</span> <span class="toc-text">mount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#format"><span class="toc-number">1.4.4.</span> <span class="toc-text">format</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/48974a1a/" title="mq-deadline"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/08.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="mq-deadline"/></a><div class="content"><a class="title" href="/posts/48974a1a/" title="mq-deadline">mq-deadline</a><time datetime="2025-10-10T09:35:34.893Z" title="更新于 2025-10-10 17:35:34">2025-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/44c8f818/" title="list"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/10.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="list"/></a><div class="content"><a class="title" href="/posts/44c8f818/" title="list">list</a><time datetime="2025-10-10T08:51:23.325Z" title="更新于 2025-10-10 16:51:23">2025-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/447af9b5/" title="genhd"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/09.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="genhd"/></a><div class="content"><a class="title" href="/posts/447af9b5/" title="genhd">genhd</a><time datetime="2025-10-10T08:50:59.612Z" title="更新于 2025-10-10 16:50:59">2025-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ed4b199f/" title="class"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/01.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="class"/></a><div class="content"><a class="title" href="/posts/ed4b199f/" title="class">class</a><time datetime="2025-10-10T08:38:03.324Z" title="更新于 2025-10-10 16:38:03">2025-10-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/aa511041/" title="blk-core"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/07.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="blk-core"/></a><div class="content"><a class="title" href="/posts/aa511041/" title="blk-core">blk-core</a><time datetime="2025-10-10T08:15:30.737Z" title="更新于 2025-10-10 16:15:30">2025-10-10</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/images/covers/06.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">文档</div><div class="footer-flex-content"><a href="/categories/linux/" target="_blank" title="🚀 linux">🚀 linux</a><a href="/categories/rt-thread/" target="_blank" title="📑 rt-thread">📑 rt-thread</a><a href="/categories/uboot/" target="_blank" title="📌 uboot">📌 uboot</a><a href="/categories/LoraWan/" target="_blank" title="⚔️ LoraWan">⚔️ LoraWan</a><a href="/categories/hpatch/" target="_blank" title="❓ hpatch">❓ hpatch</a><a href="/categories/git/" target="_blank" title="⚡️ git">⚡️ git</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/gallery/" target="_blank" title="图库">图库</a><a href="/messageboard/" target="_blank" title="留言板">留言板</a><a href="/shuoshuo/" target="_blank" title="说说">说说</a><a href="/link/" target="_blank" title="示例">示例</a><a href="/link/" target="_blank" title="友链">友链</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">框架</div><div class="footer-flex-content"><a href="https://hexo.io/zh-cn/" rel="external nofollow noreferrer" target="_blank" title="Hexo">Hexo</a><a href="https://butterfly.js.org/" rel="external nofollow noreferrer" target="_blank" title="Butterfly">Butterfly</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">贊助</div><div class="footer-flex-content"><div><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/alipay.png" alt='wdfk_prog' width='100px' height='100px'></div></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Liya Huang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 8.0.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.1</a></span></div><div class="footer_custom_text">你好，欢迎来到我的 <a href="/about/">数字花园</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天" style="display:none"><i class="fas fa-message"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script><script>(() => {
  const abcjsInit = () => {
    const abcjsFn = () => {
      setTimeout(() => {
        const sheets = document.querySelectorAll(".abc-music-sheet")
        for (let i = 0; i < sheets.length; i++) {
          const ele = sheets[i]
          if (ele.children.length > 0) continue

          // Parse parameters from data-params attribute
          let params = {}
          const dp = ele.getAttribute("data-params")
          if (dp) {
            try {
              params = JSON.parse(dp)
            } catch (e) {
              console.error("Failed to parse data-params:", e)
            }
          }

          // Merge parsed parameters with the responsive option
          // Ensures params content appears before responsive
          const options = { ...params, responsive: "resize" }

          // Render the music score using ABCJS.renderAbc
          ABCJS.renderAbc(ele, ele.innerHTML, options)
        }
      }, 100)
    }

    if (typeof ABCJS === "object") {
      abcjsFn()
    } else {
      btf.getScript("https://cdn.jsdelivr.net/npm/abcjs/dist/abcjs-basic-min.min.js").then(abcjsFn)
    }
  }

  if (window.pjax) {
    abcjsInit()
  } else {
    window.addEventListener("load", abcjsInit)
  }

  btf.addGlobalFn("encrypt", abcjsInit, "abcjs")
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: 'Ov23livBmwx65h3XIdfT',
      clientSecret: '9f23bdaa2ea11322f9f405d77bcdc27166077a7d',
      repo: 'wdfk-prog.github.io',
      owner: 'wdfk-prog',
      admin: ['wdfk-prog'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || '75851446435777ddaa47f3882bcb719a'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script>window.newestComments = {
  changeContent: content => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<code>.*?<\/code>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g, "") // remove html tag

    if (content.length > 150) {
      content = content.substring(0, 150) + '...'
    }
    return content
  },

  generateHtml: (array, ele) => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class="aside-list-item">'

        if (true && array[i].avatar) {
          const imgAttr = 'data-lazy-src'
          const lazyloadNative = ''
          result += `<a href="${array[i].url}" class="thumbnail"><img ${imgAttr}="${array[i].avatar}" alt="${array[i].nick}" ${lazyloadNative}></a>`
        }

        result += `<div class="content">
        <a class="comment" href="${array[i].url}" title="${array[i].content}">${array[i].content}</a>
        <div class="name"><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '暂无评论'
    }

    ele.innerHTML = result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh(ele)
  },

  newestCommentInit: (name, getComment) => {
    const $dom = document.querySelector('#card-newest-comments .aside-list')
    if ($dom) {
      const data = btf.saveToLocal.get(name)
      if (data) {
        newestComments.generateHtml(JSON.parse(data), $dom)
      } else {
        getComment($dom)
      }
    }
  },

  run: (name, getComment) => {
    newestComments.newestCommentInit(name, getComment)
    btf.addGlobalFn('pjaxComplete', () => newestComments.newestCommentInit(name, getComment), name)
  }
}</script><script>window.addEventListener('load', () => {
  const keyName = 'github-newest-comments'
  const { changeContent, generateHtml, run } = window.newestComments

  const findTrueUrl = (array, ele) => {
    Promise.all(array.map(item =>
      fetch(item.url).then(resp => resp.json()).then(data => {
        let urlArray = data.body ? data.body.match(/(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?/ig) : []
        if (!Array.isArray(urlArray) || urlArray.length === 0) {
          urlArray = [`${data.html_url}`]
        }
        if (data.user.login === 'utterances-bot') {
          return urlArray.pop()
        } else {
          return urlArray.shift()
        }
      })
    )).then(res => {
        array = array.map((i,index)=> {
          return {
            ...i,
            url: res[index]
          }
        })

        btf.saveToLocal.set(keyName, JSON.stringify(array), 10/(60*24))
        generateHtml(array, ele)
    });
  }

  const getComment = ele => {
    fetch('https://api.github.com/repos/wdfk-prog/wdfk-prog.github.io/issues/comments?sort=updated&direction=desc&per_page=6&page=1',{
      "headers": {
        Accept: 'application/vnd.github.v3.html+json'
      }
    })
      .then(response => response.json())
      .then(data => {
        const githubArray = data.map(item => {
          return {
            'avatar': item.user.avatar_url,
            'content': changeContent(item.body_html || item.body),
            'nick': item.user.login,
            'url': item.issue_url,
            'date': item.updated_at
          }
        })
        findTrueUrl(githubArray, ele)
      }).catch(e => {
        console.error(e)
        ele.textContent= "无法获取评论，请确认相关配置是否正确"
      })
  }
  run(keyName, getComment)
})</script><div class="aplayer no-destroy" data-id="60198" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false" data-volume="0.5"></div><script>
  var titleTime, OriginTitile = document.title;
  document.addEventListener("visibilitychange", function() {
    if (document.hidden) {
      titleTime = setTimeout(function() {
        document.title = "w(ﾟДﾟ)w 不要走！再看看嘛！";
      }, 300);
    } else {
      document.title = "♪(^∇^*)欢迎回来！" + OriginTitile;
      titleTime = setTimeout(function() {
        document.title = OriginTitile;
      }, 2000);
    }
  });
</script>
<script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script>(() => {
  window.ChatraID = '5cPWcnA8HKGzg5hoc'
  window.Chatra = window.Chatra || function() {
    (window.Chatra.q = window.Chatra.q || []).push(arguments)
  }

  btf.getScript('https://call.chatra.io/chatra.js').then(() => {
    const isChatBtn = true
    const isChatHideShow = true

    if (isChatBtn) {
      const close = () => {
        Chatra('minimizeWidget')
        Chatra('hide')
      }

      const open = () => {
        Chatra('openChat', true)
        Chatra('show')
      }

      window.ChatraSetup = { startHidden: true }
    
      window.chatBtnFn = () => document.getElementById('chatra').classList.contains('chatra--expanded') ? close() : open()

      document.getElementById('chat-btn').style.display = 'block'
    } else if (isChatHideShow) {
      window.chatBtn = {
        hide: () => Chatra('hide'),
        show: () => Chatra('show')
      }
    }
  })
})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: true,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      true
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MF3J339H" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript></div><script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const heatmapChartDom = document.getElementById('heatmapChart');
                if(heatmapChartDom){
                    const heatmapChart = echarts.init(heatmapChartDom, 'dark');
                    const cellSize = [18, 18];
                    
                    const groupByYear = (data) => {
                        const result = {};
                        data.forEach(([date, value]) => {
                            const [year] = date.split('-').map(Number);
                            if (!result[year]) {
                                result[year] = [];
                            }
                            result[year].push([date, value]);
                        });
                        return result;
                    };
                    
                    const groupedData = groupByYear([["2025-10-03",392],["2025-10-04",5],["2025-10-06",9],["2025-10-07",8],["2025-10-10",3]]);
                    const years = Object.keys(groupedData).reverse();
                    
                    var initYear = parseInt(heatmapChartDom.getAttribute('year')) || new Date().getFullYear();
                    const minYear = years[years.length - 1];
                    const maxYear = years[0];
                    if (initYear < minYear || initYear > maxYear) {
                        initYear = maxYear;
                    }
                    console.log('[hexo-graph]generateHeatmapChart|initYear:', initYear, 'minYear:', minYear, 'maxYear:', maxYear);
                    
                    heatmapChart.setOption({
                        grid: {},
                        tooltip: { 
                            position: 'top', 
                            formatter: params => `${params.value[0]}: ${params.value[1]} Articles` 
                        },
                        calendar: { 
                            top: '10%',
                            left: 'left', 
                            right: '8%',
                            range: initYear,
                            cellSize: cellSize, 
                            splitLine: { lineStyle: { color: '#E0E0E0', width: 1 } }, 
                            itemStyle: { borderWidth: 1, borderColor: '#E0E0E0' }, 
                            dayLabel: { show: false },
                            monthLabel: { show: true },
                            yearLabel: { show: false },
                        },
                        visualMap: { 
                            show: true,
                            right: '8%',
                            bottom: '5%',
                            type: 'piecewise',
                            orient: 'horizontal',
                            text: ['More', 'Less'],
                            min: 0,
                            max: Math.max(...groupedData[initYear].map(item => item[1])),
                            inRange: { color: ["#ACE7AE","#69C16D","#549F57"] }
                        },
                        legend: {
                            type: 'scroll',
                            icon: 'none',
                            data: years,
                            orient: 'vertical',
                            top: '5%',
                            right: 'right',
                            itemWidth: 20,
                            itemHeight: 20,
                            itemGap: 10,
                            pageIconSize: 10,
                            pageTextStyle: { fontSize: 14 },
                            selectedMode: 'single',
                        },
                        series: years.map(year => ({
                            type: 'heatmap',
                            coordinateSystem: 'calendar',
                            data: groupedData[year],
                            name: year,
                            emphasis: {
                                disabled: true,
                            },
                            silent: year !== initYear,
                        })),
                    });
                    
                    // init selected year
                    heatmapChart.dispatchAction({
                        type: 'legendSelect',
                        name: initYear,
                    });
                    
                    heatmapChart.on('legendselectchanged', function(params) {
                        console.log('[hexo-graph]generateHeatmapChart|legendselectchanged:', params);
                        const selectedYear = Object.keys(params.selected).find(key => params.selected[key]);
                        if (selectedYear && groupedData[selectedYear]) {
                            heatmapChart.setOption({
                                calendar: {
                                    range: selectedYear,
                                },
                                visualMap: {
                                    max: Math.max(...groupedData[selectedYear].map(item => item[1])),
                                },
                                series: years.map(year => ({
                                    type: 'heatmap',
                                    coordinateSystem: 'calendar',
                                    data: groupedData[year],
                                    name: year,
                                    emphasis: {
                                        disabled: true,
                                    },
                                    silent: year !== selectedYear,
                                })),
                            });
                        }
                    });
                    
                    heatmapChart.on('click', function (params) {
                        if (params.componentType === 'series') {
                            const [year, month] = params.value[0].split('-');
                            window.location.href = '/archives/' + year + '/' + month;
                        }
                    });
                }
            });
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const monthlyChartDom = document.getElementById('monthlyChart');
                if(monthlyChartDom){
                    const monthlyChart = echarts.init(monthlyChartDom, 'dark');
                    monthlyChart.setOption({
                        xAxis: { 
                            type: 'category', 
                            data: ["2025-10"], 
                            axisLabel: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        },
                        yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#ccc' } } },
                        series: [{
                            name: 'Articles',
                            type: 'line',
                            data: [417],
                            smooth: true,
                            lineStyle: { color: '#5470C6', width: 2 },
                            itemStyle: { color: '#5470C6' },
                            areaStyle: { color: 'rgba(84, 112, 198, 0.4)' },
                            symbolSize: 10,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: params => params.value,
                                fontSize: 14,
                                color: '#000',
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            }
                        }]
                    });

                    monthlyChart.on('click', function (params) {
                        const [year, month] = params.name.split('-');
                        window.location.href = '/archives/' + year + '/' + month;
                    });
                }
            })
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const tagsChartDom = document.getElementById('tagsChart');
                if(tagsChartDom){
                    const tagsChart = echarts.init(tagsChartDom, 'dark');
                    tagsChart.setOption({
                        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                        series: [{
                            type: 'pie',
                            radius: '60%',
                            data: [{"name":"linux","value":230},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44},{"name":"drivers","value":39},{"name":"fs","value":37},{"name":"other","value":28}],
                            label: {
                                position: 'outside',
                                formatter: '{b} {c} ({d}%)',
                                fontSize: 14,
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            },
                            color: ["#5470C6","#91CC75","#FAC858","#EE6666","#73C0DE","#3BA272","#FC8452","#9A60B4"],
                            labelLine: { show: true }
                        }],
                        legend: {
                            bottom: '0',
                            left: 'center',
                            data: [{"name":"linux","value":230},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44},{"name":"drivers","value":39},{"name":"fs","value":37},{"name":"other","value":28}].map(tag => tag.name),
                            textStyle: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        }
                    });

                    tagsChart.on('click', function (params) {
                        window.location.href = '/tags/' + params.name;
                    });
                }
            })
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const categoriesChartDom = document.getElementById('categoriesChart');
                if(categoriesChartDom){
                    const categoriesChart = echarts.init(categoriesChartDom, 'dark');
                    categoriesChart.setOption({
                        xAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#ccc' } } },
                        yAxis: { 
                            type: 'category', 
                            data: [{"name":"linux","value":230},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44}].map(category => category.name).reverse(), 
                            axisLabel: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        },
                        series: [{
                            name: 'Category Count',
                            type: 'bar',
                            data: [{"name":"linux","value":230},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44}].map(category => category.value).reverse(),
                            label: {
                                show: true,
                                position: 'right',
                                formatter: params => params.value,
                                fontSize: 14,
                                color: '#000',
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            },
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    { offset: 0, color: '#91CC75' },
                                    { offset: 1, color: '#73C0DE' }
                                ])
                            }
                        }]
                    });

                    categoriesChart.on('click', function (params) {
                        window.location.href = '/categories/' + params.name;
                    });
                }
            });
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const categoriesTreeChartDom = document.getElementById('categoriesTreeChart');
                if(categoriesTreeChartDom){
                    const treeChart = echarts.init(categoriesTreeChartDom, 'dark');
                    treeChart.setOption({
                        title: {
                            text: '操作提示：单击展开分类，双击进入具体分类页面',
                            textStyle: {
                                fontSize: 12,
                                color: '#999',
                                fontWeight: 'normal'
                            },
                            bottom: 0,
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'item',
                            triggerOn: 'mousemove'
                        },
                        series: [{
                            type: 'tree',
                            data: [{"name":"Categories","children":[{"name":"git","children":[],"count":6,"path":"git"},{"name":"hpatch","children":[{"name":"libdivsufsort","children":[],"count":3,"path":"hpatch/libdivsufsort"},{"name":"SA-IS","children":[],"count":1,"path":"hpatch/SA-IS"}],"count":10,"path":"hpatch"},{"name":"LoraWan","children":[{"name":"LoRaWAN标准","children":[{"name":"LoRaWAN-Specification_ZH_CN","children":[{"name":"LoRaWAN-Specification_ZH_CN-190102","children":[{"name":"chapter","children":[],"count":20,"path":"LoraWan/LoRaWAN标准/LoRaWAN-Specification_ZH_CN/LoRaWAN-Specification_ZH_CN-190102/chapter"}],"count":22,"path":"LoraWan/LoRaWAN标准/LoRaWAN-Specification_ZH_CN/LoRaWAN-Specification_ZH_CN-190102"}],"count":22,"path":"LoraWan/LoRaWAN标准/LoRaWAN-Specification_ZH_CN"}],"count":22,"path":"LoraWan/LoRaWAN标准"}],"count":23,"path":"LoraWan"},{"name":"MCU","children":[],"count":23,"path":"MCU"},{"name":"linux","children":[{"name":"block","children":[],"count":8,"path":"linux/block"},{"name":"include","children":[],"count":10,"path":"linux/include"},{"name":"fs","children":[],"count":37,"path":"linux/fs"},{"name":"drivers","children":[{"name":"base","children":[],"count":14,"path":"linux/drivers/base"},{"name":"tty","children":[],"count":2,"path":"linux/drivers/tty"},{"name":"clk","children":[],"count":2,"path":"linux/drivers/clk"}],"count":39,"path":"linux/drivers"},{"name":"kernel","children":[{"name":"rcu","children":[],"count":3,"path":"linux/kernel/rcu"},{"name":"lock","children":[],"count":7,"path":"linux/kernel/lock"},{"name":"irq","children":[],"count":5,"path":"linux/kernel/irq"},{"name":"sched","children":[],"count":7,"path":"linux/kernel/sched"},{"name":"time","children":[],"count":10,"path":"linux/kernel/time"}],"count":61,"path":"linux/kernel"},{"name":"lib","children":[],"count":19,"path":"linux/lib"},{"name":"security","children":[],"count":1,"path":"linux/security"},{"name":"scripts","children":[],"count":2,"path":"linux/scripts"},{"name":"other","children":[],"count":17,"path":"linux/other"},{"name":"mm","children":[],"count":19,"path":"linux/mm"},{"name":"arch","children":[{"name":"arm","children":[],"count":10,"path":"linux/arch/arm"}],"count":10,"path":"linux/arch"}],"count":230,"path":"linux"},{"name":"tmc5160","children":[],"count":1,"path":"tmc5160"},{"name":"rt-thread","children":[{"name":"其他资料","children":[{"name":"fatfs","children":[],"count":1,"path":"rt-thread/其他资料/fatfs"}],"count":1,"path":"rt-thread/其他资料"}],"count":44,"path":"rt-thread"},{"name":"uboot","children":[{"name":"other","children":[],"count":12,"path":"uboot/other"},{"name":"子目录","children":[],"count":10,"path":"uboot/子目录"},{"name":"u-boot分类","children":[{"name":"arch","children":[{"name":"arm","children":[],"count":2,"path":"uboot/u-boot分类/arch/arm"}],"count":3,"path":"uboot/u-boot分类/arch"},{"name":"boot","children":[],"count":4,"path":"uboot/u-boot分类/boot"},{"name":"api","children":[],"count":1,"path":"uboot/u-boot分类/api"},{"name":"common","children":[],"count":10,"path":"uboot/u-boot分类/common"},{"name":"cmd","children":[],"count":1,"path":"uboot/u-boot分类/cmd"},{"name":"dm","children":[],"count":15,"path":"uboot/u-boot分类/dm"},{"name":"env","children":[],"count":1,"path":"uboot/u-boot分类/env"},{"name":"lib","children":[],"count":4,"path":"uboot/u-boot分类/lib"},{"name":"include","children":[],"count":3,"path":"uboot/u-boot分类/include"},{"name":"fdt","children":[],"count":1,"path":"uboot/u-boot分类/fdt"},{"name":"test","children":[],"count":1,"path":"uboot/u-boot分类/test"}],"count":44,"path":"uboot/u-boot分类"}],"count":68,"path":"uboot"},{"name":"杂谈","children":[],"count":8,"path":"杂谈"},{"name":"freertos","children":[],"count":1,"path":"freertos"}],"count":0,"path":""}],
                            initialTreeDepth: -1,
                            top: '5%',
                            bottom: '10%',
                            left: '0%',
                            right: '0%',
                            symbolSize: 15,
                            layout: 'orthogonal',
                            orient: 'TB',
                            itemStyle: {
                                color: '#91CC75',
                                borderColor: '#73C0DE'
                            },
                            label: {
                                position: 'bottom',
                                verticalAlign: 'middle',
                                align: 'center',
                                fontSize: 14,
                                distance: 28,
                                formatter: function(params) {
                                    return params.data.name + (params.data.count ? ' (' + params.data.count + ')' : '');
                                }
                            },
                            leaves: {
                                label: {
                                    position: 'top',
                                    verticalAlign: 'middle',
                                    align: 'center'
                                }
                            },
                            emphasis: {
                                focus: 'descendant'
                            },
                            expandAndCollapse: true
                        }]
                    });

                    treeChart.on('dblclick', function (params) {
                        if (params.data && params.data.path) {
                            window.location.href = '/categories/' + params.data.path;
                        }
                    });
                }
            });
        </script>
    
    <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>