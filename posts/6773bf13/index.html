<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>tmc_study | wdfk-prog的个人博客</title><meta name="author" content="Liya Huang"><meta name="copyright" content="Liya Huang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="grblconfig Inc\my_machine.h中取消注释进行配置开启如下配置进行学习  12345678910111213141516171819202122#define BOARD_BTT_SKR_20          &#x2F;&#x2F; F407 based 3D Printer board#define TRINAMIC_ENABLE   5160 &#x2F;&#x2F; Trinamic TMC5160 st">
<meta property="og:type" content="article">
<meta property="og:title" content="tmc_study">
<meta property="og:url" content="https://wdfk-prog.space/posts/6773bf13/index.html">
<meta property="og:site_name" content="wdfk-prog的个人博客">
<meta property="og:description" content="grblconfig Inc\my_machine.h中取消注释进行配置开启如下配置进行学习  12345678910111213141516171819202122#define BOARD_BTT_SKR_20          &#x2F;&#x2F; F407 based 3D Printer board#define TRINAMIC_ENABLE   5160 &#x2F;&#x2F; Trinamic TMC5160 st">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wdfk-prog.space/images/covers/03.jpg">
<meta property="article:published_time" content="2025-10-03T00:37:35.000Z">
<meta property="article:modified_time" content="2025-10-03T09:23:27.589Z">
<meta property="article:author" content="Liya Huang">
<meta property="article:tag" content="wdfk-prog, 个人博客, 技术博客, 嵌入式, 编程, 学习笔记, 个人成长.">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wdfk-prog.space/images/covers/03.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "tmc_study",
  "url": "https://wdfk-prog.space/posts/6773bf13/",
  "image": "https://wdfk-prog.space/images/covers/03.jpg",
  "datePublished": "2025-10-03T00:37:35.000Z",
  "dateModified": "2025-10-03T09:23:27.589Z",
  "author": [
    {
      "@type": "Person",
      "name": "Liya Huang",
      "url": "https://github.com/wdfk-prog"
    }
  ]
}</script><link rel="shortcut icon" href="/images/favicon.png"><link rel="canonical" href="https://wdfk-prog.space/posts/6773bf13/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//static.cloudflareinsights.com"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxxxxx"/><meta name="baidu-site-verification" content="xxxxxxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-3978542742563797',
  enable_page_level_ads: 'true'
});</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?3c49dd4913ab43efb1bfc8d12b1cded9";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-PF2CVP2PL4"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-PF2CVP2PL4')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-PF2CVP2PL4', {'page_path': window.location.pathname})
}, 'google_analytics')
</script><script defer="defer" data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;17ff914b5e28493597b7dc19f3356022&quot;}"></script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "tkaenn1tjv");
</script><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
"https://www.googletagmanager.com/gtm.js?id="+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MF3J339H');
btf.addGlobalFn('pjaxComplete', () => {
  dataLayer.push({'event': 'pjaxComplete', 'page_title': document.title, 'page_location': location.href, 'page_path': window.location.pathname})
}, 'google_tag_manager')</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'tmc_study',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.0.0"><link rel="alternate" href="/atom.xml" title="wdfk-prog的个人博客" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (true) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/images/subtle-texture.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/avatar.png" onerror="this.onerror=null;this.src='/images/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">414</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">49</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">53</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book-open"></i><span> 页面</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-quote-left"></i><span> 说说</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 示例</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i><span> 歌曲</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/images/covers/03.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/my-logo.png" alt="Logo"><span class="site-name">wdfk-prog的个人博客</span></a><a class="nav-page-title" href="/"><span class="site-name">tmc_study</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book-open"></i><span> 页面</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/shuoshuo/"><i class="fa-fw fas fa-quote-left"></i><span> 说说</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 示例</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/songs/"><i class="fa-fw fas fa-music"></i><span> 歌曲</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">tmc_study<a class="post-edit-link" href="null_posts/tmc_study.md" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-10-03T00:37:35.000Z" title="发表于 2025-10-03 08:37:35">2025-10-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-10-03T09:23:27.589Z" title="更新于 2025-10-03 17:23:27">2025-10-03</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">3.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/6773bf13/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:365,&quot;messagePrev&quot;:&quot;已经过了&quot;,&quot;messageNext&quot;:&quot;自上次更新以来，文章的内容可能已经过时&quot;,&quot;postUpdate&quot;:&quot;2025-10-03 17:23:27&quot;}" hidden></div><h1 id="grbl"><a href="#grbl" class="headerlink" title="grbl"></a>grbl</h1><h2 id="config"><a href="#config" class="headerlink" title="config"></a>config</h2><ol>
<li>Inc\my_machine.h中取消注释进行配置<br>开启如下配置进行学习</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BOARD_BTT_SKR_20          <span class="comment">// F407 based 3D Printer board</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRINAMIC_ENABLE   5160 <span class="comment">// Trinamic TMC5160 stepper driver support.</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_AXIS 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRINAMIC_DYNAMIC_CURRENT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRINAMIC_EXTENDED_SETTINGS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRINAMIC_POLL_STATUS</span></span><br><span class="line"><span class="comment">// 这些选项需要自行配置,不配做使用默认值</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_DRVCONF</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_COOLCONF_SEMIN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_COOLCONF_SEMAX</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_COOLCONF_SEDN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_COOLCONF_SEUP</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_COOLCONF_SEIMIN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_CHOPCONF_HSTRT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_CHOPCONF_HEND</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_CHOPCONF_TBL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_CHOPCONF_TOFF</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_CHOPCONF_RDNTF</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_CHOPCONF_CHM</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_CHOPCONF_HDEC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_CHOPCONF_TFD</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TMC_CHOPCONF_INTPOL</span></span><br></pre></td></tr></table></figure>
<h2 id="driver-init-驱动初始化"><a href="#driver-init-驱动初始化" class="headerlink" title="driver_init 驱动初始化"></a>driver_init 驱动初始化</h2><p>执行各种初始化操作与注册</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">driver_init</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;grbl/plugins_init.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRINAMIC_ENABLE</span></span><br><span class="line">    <span class="keyword">extern</span> <span class="type">bool</span> <span class="title function_">trinamic_init</span> <span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">    trinamic_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="grbl-enter-主入口"><a href="#grbl-enter-主入口" class="headerlink" title="grbl_enter 主入口"></a>grbl_enter 主入口</h2><ol>
<li>grbl_enter是main函数的主入口</li>
<li>执行driver_init()进行初始化</li>
<li>进入protocol_main_loop()主循环</li>
<li>执行protocol_execute_realtime()实时执行</li>
<li>执行protocol_exec_rt_system()系统实时执行</li>
<li>执行grbl.on_execute_realtime(state_get());函数,在grbl_enter中进行注册;即task_execute</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main entry point</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">grbl_enter</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    grbl.on_execute_realtime = grbl.on_execute_delay = task_execute;</span><br><span class="line">    driver.init = driver_init();</span><br><span class="line">    <span class="keyword">while</span>(looping) &#123;</span><br><span class="line">        <span class="comment">//开始主循环。处理程序输入并执行它们</span></span><br><span class="line">        <span class="keyword">if</span>(!(looping = protocol_main_loop()))</span><br><span class="line">            looping = hal.driver_release == <span class="literal">NULL</span> || hal.driver_release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  GRBL PRIMARY LOOP:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">protocol_main_loop</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ---------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 主循环！在系统中止时，这将退出回到 main() 以重置系统。</span></span><br><span class="line">    <span class="comment">// 这也是 grblHAL 在等待任务时空闲的地方。</span></span><br><span class="line">    <span class="comment">// ---------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span>(!protocol_execute_realtime() &amp;&amp; sys.<span class="built_in">abort</span>)</span><br><span class="line">            <span class="keyword">return</span> !sys.flags.<span class="built_in">exit</span>;</span><br><span class="line">        <span class="keyword">if</span>(settings.flags.sleep_enable)</span><br><span class="line">            sleep_check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">protocol_execute_realtime</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(protocol_exec_rt_system()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">sys_state_t</span> state = state_get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(sys.suspend)</span><br><span class="line">            protocol_exec_rt_suspend(state);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> NVSDATA_BUFFER_ENABLE</span></span><br><span class="line">        <span class="keyword">if</span>((state == STATE_IDLE || (state &amp; (STATE_ALARM|STATE_ESTOP))) &amp;&amp; settings_dirty.is_dirty &amp;&amp; !gc_state.file_run)</span><br><span class="line">            nvs_buffer_sync_physical();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> !ABORTED;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">protocol_exec_rt_system</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    grbl.on_execute_realtime(state_get());</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">task_execute</span> <span class="params">(<span class="type">sys_state_t</span> state)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">uint32_t</span> last_ms = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">core_task_t</span> *task;</span><br><span class="line">    <span class="comment">//紧急任务执行</span></span><br><span class="line">    <span class="keyword">if</span>(immediate_task &amp;&amp; sys.driver_started) &#123;</span><br><span class="line"></span><br><span class="line">        hal.irq_disable();</span><br><span class="line">        task = immediate_task;</span><br><span class="line">        immediate_task = <span class="literal">NULL</span>;</span><br><span class="line">        hal.irq_enable();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="type">void</span> *data = task-&gt;data;</span><br><span class="line">            foreground_task_ptr fn = task-&gt;fn;</span><br><span class="line">            task_free(task);</span><br><span class="line">            fn(data);</span><br><span class="line">        &#125; <span class="keyword">while</span>((task = task-&gt;next));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> now = hal.get_elapsed_ticks();</span><br><span class="line">    <span class="keyword">if</span>(now == last_ms || next_task == systick_task)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    last_ms = now;</span><br><span class="line">    <span class="comment">//系统任务执行</span></span><br><span class="line">    <span class="keyword">if</span>((task = systick_task)) <span class="keyword">do</span> &#123;</span><br><span class="line">        task-&gt;fn(task-&gt;data);</span><br><span class="line">    &#125; <span class="keyword">while</span>((task = task-&gt;next));</span><br><span class="line">    <span class="comment">//已超时任务执行</span></span><br><span class="line">    <span class="keyword">while</span>(next_task &amp;&amp; (<span class="type">int32_t</span>)(next_task-&gt;time - now) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">void</span> *data = next_task-&gt;data;</span><br><span class="line">        foreground_task_ptr fn = next_task-&gt;fn;</span><br><span class="line">        task_free(next_task);</span><br><span class="line">        next_task = next_task-&gt;next;</span><br><span class="line"></span><br><span class="line">        fn(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="task-API"><a href="#task-API" class="headerlink" title="task API"></a>task API</h2><ul>
<li>这些任务是循环执行的,通过task_execute()函数执行</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">task_add_immediate</span> <span class="params">(foreground_task_ptr fn, <span class="type">void</span> *data)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">task_add_delayed</span> <span class="params">(foreground_task_ptr fn, <span class="type">void</span> *data, <span class="type">uint32_t</span> delay_ms)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">task_delete</span> <span class="params">(foreground_task_ptr fn, <span class="type">void</span> *data)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">task_add_systick</span> <span class="params">(foreground_task_ptr fn, <span class="type">void</span> *data)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">task_delete_systick</span> <span class="params">(foreground_task_ptr fn, <span class="type">void</span> *data)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="task-add-systick-添加系统任务"><a href="#task-add-systick-添加系统任务" class="headerlink" title="task_add_systick 添加系统任务"></a>task_add_systick 添加系统任务</h3><ol>
<li>进入中断屏蔽</li>
<li>通过task_alloc()分配任务,静态数组中分配</li>
<li>注册执行函数和数据</li>
<li>任务链表为空则直接添加,否则遍历到链表尾部添加</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ISR_CODE <span class="type">bool</span> <span class="title function_">ISR_FUNC</span><span class="params">(task_add_systick)</span><span class="params">(foreground_task_ptr fn, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">core_task_t</span> *task = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    hal.irq_disable();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fn &amp;&amp; (task = task_alloc())) &#123;</span><br><span class="line"></span><br><span class="line">        task-&gt;fn = fn;</span><br><span class="line">        task-&gt;data = data;</span><br><span class="line">        task-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(systick_task == <span class="literal">NULL</span>)</span><br><span class="line">            systick_task = task;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">core_task_t</span> *t = systick_task;</span><br><span class="line">            <span class="keyword">while</span>(t-&gt;next)</span><br><span class="line">                t = t-&gt;next;</span><br><span class="line">            t-&gt;next = task;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hal.irq_enable();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> task != <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="gcode-G代码解析"><a href="#gcode-G代码解析" class="headerlink" title="gcode G代码解析"></a>gcode G代码解析</h2><h3 id="gc-execute-block-执行G代码块"><a href="#gc-execute-block-执行G代码块" class="headerlink" title="gc_execute_block 执行G代码块"></a>gc_execute_block 执行G代码块</h3><ol>
<li>grbl.user_mcode.execute(state_get(), &amp;gc_block);执行用户自定义M代码<ul>
<li>该部分是TMC注册的mcode_execute执行的地方</li>
</ul>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">status_code_t</span> <span class="title function_">gc_execute_block</span> <span class="params">(<span class="type">char</span> *block)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// [9a. User defined M commands ]:</span></span><br><span class="line">    <span class="keyword">if</span>(gc_block.user_mcode &amp;&amp; !check_mode) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(gc_block.user_mcode_sync)</span><br><span class="line">            protocol_buffer_synchronize(); <span class="comment">// Ensure user defined mcode is executed when specified in program.</span></span><br><span class="line"></span><br><span class="line">        gc_block.words.mask = user_words.mask;</span><br><span class="line">        gc_block.values.f = single_meaning_value.f;</span><br><span class="line">        gc_block.values.o = single_meaning_value.o;</span><br><span class="line">        gc_block.values.s = single_meaning_value.s;</span><br><span class="line">        gc_block.values.t = single_meaning_value.t;</span><br><span class="line">        grbl.user_mcode.execute(state_get(), &amp;gc_block);</span><br><span class="line">        gc_block.words.mask = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="stepper-驱动"><a href="#stepper-驱动" class="headerlink" title="stepper 驱动"></a>stepper 驱动</h1><ul>
<li>使用TMC芯片进行驱动,SPI用于通信配置;运动控制使用step&#x2F;dir信号</li>
</ul>
<h2 id="st-prep-buffer"><a href="#st-prep-buffer" class="headerlink" title="st_prep_buffer"></a>st_prep_buffer</h2><h1 id="trinamic"><a href="#trinamic" class="headerlink" title="trinamic"></a>trinamic</h1><h2 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h2><ol>
<li>StealthChop 2™ 无噪声、高精度斩波算法，用于电机的静止和运动状态下的静音控制。StealthChop2在 StealthChop 的基础上，加快了电机运动加减速特性，降低了所需的电流最小值。</li>
<li>spreadCycle™ 高精度斩波算法，用于高动态电机运动和产生绝对干净的电流波。低噪音、低共振和低振动斩波器。</li>
<li>DcStep™ 与负载相关的速度控制。电机尽可能快地移动，不失步</li>
<li>StallGuard2™ 无传感器的堵转检测和机械负载测量。</li>
<li>CoolStep™ 根据负载自适应电流，可将能耗降低 75 %。</li>
<li>MicroPlyer™ 细分内插器，用于从全步开始，以较低细分输入获得 256 微步的平滑度</li>
<li>StealthChop 2 &amp; SpreadCycle 驱动<br>StealthChop 是电压斩波器的原理。除了电机机械滚轮轴承产生的噪音，它特别保证了电机在静止和慢速运行时能绝对安静。不同于其他电压模式斩波器, StealthChop 2 不需要任何配置。通电后，它会在第一次运动中自动学习最佳设置，并进一步优化后续运动中的设置。初始的归零过程足以使系统完成StealthChop 最佳配置。也可以配置初始参数加快自学习过程。StealthChop 2 通过对电机速度的变化立即做出反应，允许高的电机动态</li>
</ol>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构 *"></a>数据结构 *</h2><ol>
<li>TMC5160的寄存器地址和数据结构</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> value;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">uint8_t</span></span><br><span class="line">        idx   :<span class="number">7</span>,</span><br><span class="line">        write :<span class="number">1</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; TMC_addr_t;</span><br><span class="line"><span class="comment">//数据载荷</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> value;</span><br><span class="line">    <span class="type">uint8_t</span> data[<span class="number">4</span>];</span><br><span class="line">&#125; TMC_payload_t;</span><br><span class="line"><span class="comment">//将地址和数据结构合并传输</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    TMC_addr_t addr;</span><br><span class="line">    TMC_payload_t payload;</span><br><span class="line">&#125; TMC_spi_datagram_t;</span><br><span class="line"><span class="comment">//将寄存器地址和数据结构读取后,不需要手动解析</span></span><br><span class="line">tmc_spi_read(driver-&gt;config.motor, (TMC_spi_datagram_t *)&amp;driver-&gt;drv_status);</span><br></pre></td></tr></table></figure>
<h2 id="TMC-SPI"><a href="#TMC-SPI" class="headerlink" title="TMC SPI"></a>TMC SPI</h2><h3 id="TMC-SPI-Read-读取TMC寄存器"><a href="#TMC-SPI-Read-读取TMC寄存器" class="headerlink" title="TMC_SPI_Read 读取TMC寄存器"></a>TMC_SPI_Read 读取TMC寄存器</h3><ol>
<li>常规的SPI读取操作;片选拉低，读取数据，片选拉高</li>
<li>需注意的是，TMC5160的SPI读取是先写入地址读取一次数据;是空数据;第二次读取才是真实数据</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">TMC_spi_status_t <span class="title function_">tmc_spi_read</span> <span class="params">(<span class="type">trinamic_motor_t</span> driver, TMC_spi_datagram_t *datagram)</span></span><br><span class="line">&#123;</span><br><span class="line">  TMC_spi_status_t status;</span><br><span class="line"></span><br><span class="line">  DIGITAL_OUT(cs[driver.id].port, cs[driver.id].pin, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//第一次读取是空数据</span></span><br><span class="line">  datagram-&gt;payload.value = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  datagram-&gt;addr.write = <span class="number">0</span>;</span><br><span class="line">  spi_put_byte(datagram-&gt;addr.value);</span><br><span class="line">  spi_put_byte(<span class="number">0</span>);</span><br><span class="line">  spi_put_byte(<span class="number">0</span>);</span><br><span class="line">  spi_put_byte(<span class="number">0</span>);</span><br><span class="line">  spi_put_byte(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  DIGITAL_OUT(cs[driver.id].port, cs[driver.id].pin, <span class="number">1</span>);</span><br><span class="line">  delay();</span><br><span class="line">  DIGITAL_OUT(cs[driver.id].port, cs[driver.id].pin, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//第二次读取是真实数据</span></span><br><span class="line">  status = spi_put_byte(datagram-&gt;addr.value);</span><br><span class="line">  datagram-&gt;payload.data[<span class="number">3</span>] = spi_get_byte();</span><br><span class="line">  datagram-&gt;payload.data[<span class="number">2</span>] = spi_get_byte();</span><br><span class="line">  datagram-&gt;payload.data[<span class="number">1</span>] = spi_get_byte();</span><br><span class="line">  datagram-&gt;payload.data[<span class="number">0</span>] = spi_get_byte();</span><br><span class="line"></span><br><span class="line">  DIGITAL_OUT(cs[driver.id].port, cs[driver.id].pin, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h3><ul>
<li>spi传入数据结构,包含地址和数据</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> id;         <span class="comment">// motor id</span></span><br><span class="line">    <span class="type">uint8_t</span> axis;       <span class="comment">// axis index</span></span><br><span class="line">    <span class="type">uint8_t</span> address;    <span class="comment">// UART address</span></span><br><span class="line">    <span class="type">uint8_t</span> seq;        <span class="comment">// optional motor sequence number (for chained SPI drivers)</span></span><br><span class="line">    <span class="type">void</span> *cs_pin;       <span class="comment">// optional CS pin data for the stepper driver</span></span><br><span class="line">&#125; <span class="type">trinamic_motor_t</span>;</span><br></pre></td></tr></table></figure>
<h2 id="TMC5160-c"><a href="#TMC5160-c" class="headerlink" title="TMC5160.c"></a>TMC5160.c</h2><h3 id="TMC5160-文件结构"><a href="#TMC5160-文件结构" class="headerlink" title="TMC5160 文件结构"></a>TMC5160 文件结构</h3><ol>
<li>TMC5160.c中包含了TMC5160的所有操作函数</li>
<li>TMC5160_hal.c中包含了TMC5160的所有操作函数,对TMC5160.c进行了封装,与tmchal_t结构体进行了绑定</li>
</ol>
<h3 id="TMC5160-Init-初始化TMC5160"><a href="#TMC5160-Init-初始化TMC5160" class="headerlink" title="TMC5160_Init 初始化TMC5160"></a>TMC5160_Init 初始化TMC5160</h3><ol>
<li>通过SPI读取<code>drv_status</code>寄存器，检查是否读取到值,判断SPI是否正常</li>
<li>执行状态寄存器读取以清除重置标志</li>
<li>写入配置寄存器</li>
</ol>
<h3 id="tmc-microsteps-to-mres-微步转分辨率"><a href="#tmc-microsteps-to-mres-微步转分辨率" class="headerlink" title="tmc_microsteps_to_mres 微步转分辨率"></a>tmc_microsteps_to_mres 微步转分辨率</h3><h3 id="TMC5160-SetDefaults-设置TMC5160默认值"><a href="#TMC5160-SetDefaults-设置TMC5160默认值" class="headerlink" title="TMC5160_SetDefaults 设置TMC5160默认值"></a>TMC5160_SetDefaults 设置TMC5160默认值</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> TMC5160_t tmc5160_defaults ;</span><br><span class="line"><span class="comment">//通过默认的结构体传入默认值</span></span><br></pre></td></tr></table></figure>
<h3 id="TMC5160-AddMotor-添加TMC5160电机"><a href="#TMC5160-AddMotor-添加TMC5160电机" class="headerlink" title="TMC5160_AddMotor 添加TMC5160电机"></a>TMC5160_AddMotor 添加TMC5160电机</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">tmchal_t</span> *<span class="title function_">TMC5160_AddMotor</span> <span class="params">(<span class="type">motor_map_t</span> motor, <span class="type">uint16_t</span> current, <span class="type">uint8_t</span> microsteps, <span class="type">uint8_t</span> r_sense)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="stealthChop-斩波器配置"><a href="#stealthChop-斩波器配置" class="headerlink" title="stealthChop 斩波器配置"></a>stealthChop 斩波器配置</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">stealthChop</span> <span class="params">(<span class="type">uint8_t</span> motor, <span class="type">bool</span> on)</span></span><br><span class="line">&#123;</span><br><span class="line">    tmcdriver[motor]-&gt;config.mode = on ? TMCMode_StealthChop : TMCMode_CoolStep;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(on)</span><br><span class="line">        stealthChopEnable(motor);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        coolStepEnable(motor);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">stealthChopEnable</span> <span class="params">(<span class="type">uint8_t</span> motor)</span></span><br><span class="line">&#123;</span><br><span class="line">    TMC5160_t *driver = tmcdriver[motor];</span><br><span class="line"></span><br><span class="line">    driver-&gt;gconf.reg.diag1_stall = <span class="literal">false</span>;</span><br><span class="line">    driver-&gt;gconf.reg.en_pwm_mode = <span class="literal">true</span>; <span class="comment">// stealthChop</span></span><br><span class="line">    tmc_spi_write(driver-&gt;config.motor, (TMC_spi_datagram_t *)&amp;driver-&gt;gconf);</span><br><span class="line"></span><br><span class="line">    driver-&gt;pwmconf.reg.pwm_autoscale = <span class="literal">true</span>;</span><br><span class="line">    tmc_spi_write(driver-&gt;config.motor, (TMC_spi_datagram_t *)&amp;driver-&gt;pwmconf);</span><br><span class="line"></span><br><span class="line">    setTCoolThrsRaw(motor, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">coolStepEnable</span> <span class="params">(<span class="type">uint8_t</span> motor)</span></span><br><span class="line">&#123;</span><br><span class="line">    TMC5160_t *driver = tmcdriver[motor];</span><br><span class="line"></span><br><span class="line">    driver-&gt;gconf.reg.en_pwm_mode = <span class="literal">false</span>; <span class="comment">// stealthChop</span></span><br><span class="line">    tmc_spi_write(driver-&gt;config.motor, (TMC_spi_datagram_t *)&amp;driver-&gt;gconf);</span><br><span class="line"></span><br><span class="line">    driver-&gt;pwmconf.reg.pwm_autoscale = <span class="literal">false</span>;</span><br><span class="line">    tmc_spi_write(driver-&gt;config.motor, (TMC_spi_datagram_t *)&amp;driver-&gt;pwmconf);</span><br><span class="line"></span><br><span class="line">    setTCoolThrsRaw(motor, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="trinamic-c"><a href="#trinamic-c" class="headerlink" title="trinamic.c"></a>trinamic.c</h2><h3 id="trinamic-drivers-init-驱动初始化"><a href="#trinamic-drivers-init-驱动初始化" class="headerlink" title="trinamic_drivers_init 驱动初始化"></a>trinamic_drivers_init 驱动初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">trinamic_drivers_init</span> <span class="params">(<span class="type">axes_signals_t</span> axes)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bool</span> ok = axes.value != <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint_fast8_t</span> motor = n_motors, n_enabled = <span class="number">0</span>, seq = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(stepper, <span class="number">0</span>, <span class="keyword">sizeof</span>(stepper));</span><br><span class="line">    <span class="comment">// 获取电机的数量与使能掩码</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(bit_istrue(axes.mask, bit(motor_map[--motor].axis)))</span><br><span class="line">            seq++;</span><br><span class="line">    &#125; <span class="keyword">while</span>(motor);</span><br><span class="line"></span><br><span class="line">    motor = n_motors;</span><br><span class="line">    *min_current = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="comment">// 配置电机</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(bit_istrue(axes.mask, bit(motor_map[--motor].axis))) &#123;</span><br><span class="line">            <span class="keyword">if</span>((ok = trinamic_driver_config(motor_map[motor], --seq))) &#123;</span><br><span class="line">                n_enabled++;</span><br><span class="line">                <span class="keyword">if</span>(*min_current == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">                    <span class="built_in">strcpy</span>(min_current, uitoa(stepper[motor_map[motor].id]-&gt;get_current(motor_map[motor].id, TMCCurrent_Min)));</span><br><span class="line">                    <span class="built_in">strcpy</span>(max_current, uitoa(stepper[motor_map[motor].id]-&gt;get_current(motor_map[motor].id, TMCCurrent_Max)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span>(ok &amp;&amp; motor);</span><br><span class="line">    <span class="comment">//如果 ok 为真，则传递 n_enabled；否则传递 0</span></span><br><span class="line">    tmc_motors_set(ok ? n_enabled : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!ok) &#123;</span><br><span class="line">        driver_enabled.mask = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">memset</span>(stepper, <span class="number">0</span>, <span class="keyword">sizeof</span>(stepper));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRINAMIC_POLL_STATUS || TRINAMIC_DYNAMIC_CURRENT</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRINAMIC_POLL_STATUS</span></span><br><span class="line">        <span class="comment">//添加轮询状态任务</span></span><br><span class="line">        task_add_delayed(trinamic_poll_status, <span class="literal">NULL</span>, TRINAMIC_POLL_INTERVAL);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRINAMIC_DYNAMIC_CURRENT</span></span><br><span class="line">        <span class="comment">//先调用dynamic_current_pulse_start中判断电流并设置后再去调用stepper_block_start</span></span><br><span class="line">        <span class="keyword">if</span>(stepper_block_start == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            stepper_block_start = hal.stepper.pulse_start;</span><br><span class="line">            hal.stepper.pulse_start = dynamic_current_pulse_start;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="set-axis-setting-轴设置"><a href="#set-axis-setting-轴设置" class="headerlink" title="set_axis_setting 轴设置"></a>set_axis_setting 轴设置</h3><ol>
<li>可以通过此配置函数设置电机的电流、保持电流、微步数</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Parse and set driver specific parameters</span></span><br><span class="line"><span class="type">static</span> <span class="type">status_code_t</span> <span class="title function_">set_axis_setting</span> <span class="params">(<span class="type">setting_id_t</span> setting, <span class="type">uint_fast16_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint_fast8_t</span> axis, motor = n_motors;</span><br><span class="line">    <span class="type">status_code_t</span> status = Status_OK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(settings_get_axis_base(setting, &amp;axis)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> Setting_AxisStepperCurrent:</span><br><span class="line">            trinamic.driver[axis].current = (<span class="type">uint16_t</span>)value;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                motor--;</span><br><span class="line">                <span class="keyword">if</span>(stepper[motor] &amp;&amp; stepper[motor]-&gt;get_config(motor)-&gt;motor.axis == axis) &#123;</span><br><span class="line">                    stepper[motor]-&gt;set_current(motor, trinamic.driver[axis].current, trinamic.driver[axis].hold_current_pct);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRINAMIC_DYNAMIC_CURRENT</span></span><br><span class="line">                    reduced_current[motor] = trinamic.driver[axis].current * trinamic.driver[axis].hold_current_pct / <span class="number">100</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span>(motor);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> TMCsetting_HoldCurrentPct: <span class="comment">// Hold current percentage</span></span><br><span class="line">            <span class="keyword">if</span>(value &gt; <span class="number">100</span>)</span><br><span class="line">                value = <span class="number">100</span>;</span><br><span class="line">            trinamic.driver[axis].hold_current_pct = (<span class="type">uint16_t</span>)value;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                motor--;</span><br><span class="line">                <span class="keyword">if</span>(stepper[motor] &amp;&amp; stepper[motor]-&gt;get_config(motor)-&gt;motor.axis == axis) &#123;</span><br><span class="line">                    stepper[motor]-&gt;set_current(motor, trinamic.driver[axis].current, trinamic.driver[axis].hold_current_pct);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRINAMIC_DYNAMIC_CURRENT</span></span><br><span class="line">                    reduced_current[motor] = trinamic.driver[axis].current * trinamic.driver[axis].hold_current_pct / <span class="number">100</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span>(motor);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> Setting_AxisMicroSteps:</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                motor--;</span><br><span class="line">                <span class="keyword">if</span>(stepper[motor] &amp;&amp; stepper[motor]-&gt;get_config(motor)-&gt;motor.axis == axis) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(stepper[motor]-&gt;microsteps_isvalid(motor, (<span class="type">uint16_t</span>)value)) &#123;</span><br><span class="line">                        trinamic.driver[axis].microsteps = value;</span><br><span class="line">                        stepper[motor]-&gt;set_microsteps(motor, trinamic.driver[axis].microsteps);</span><br><span class="line">                        <span class="keyword">if</span>(report.sg_status_motormask.mask &amp; bit(axis))</span><br><span class="line">                            report.msteps = trinamic.driver[axis].microsteps;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        status = Status_InvalidStatement;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span>(motor);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            status = Status_Unhandled;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="trinamic-settings-get-defaults-获取默认设置"><a href="#trinamic-settings-get-defaults-获取默认设置" class="headerlink" title="trinamic_settings_get_defaults 获取默认设置"></a>trinamic_settings_get_defaults 获取默认设置</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">trinamic_settings_get_defaults</span> <span class="params">(<span class="type">bool</span> cap_only)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">trinamic_cfg_params_t</span> *params;</span><br><span class="line"></span><br><span class="line">    params = TMC5160_GetConfigDefaults();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;cfg_cap, &amp;params-&gt;cap, <span class="keyword">sizeof</span>(<span class="type">trinamic_cfg_t</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!cap_only)</span><br><span class="line">        <span class="built_in">memcpy</span>(cfg_params, &amp;params-&gt;dflt, <span class="keyword">sizeof</span>(<span class="type">trinamic_cfg_t</span>));</span><br><span class="line">    <span class="comment">//这些选项允许在编译时覆盖默认设置</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_DRVCONF</span></span><br><span class="line">    cfg_params-&gt;drvconf = TMC_DRVCONF;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_COOLCONF_SEMIN</span></span><br><span class="line">    cfg_params-&gt;coolconf.semin = TMC_COOLCONF_SEMIN &amp; cfg_cap.coolconf.semin;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_COOLCONF_SEMAX</span></span><br><span class="line">    cfg_params-&gt;coolconf.semax = TMC_COOLCONF_SEMAX &amp; cfg_cap.coolconf.semax;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_COOLCONF_SEDN</span></span><br><span class="line">    cfg_params-&gt;coolconf.sedn = TMC_COOLCONF_SEDN &amp; cfg_cap.coolconf.sedn;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_COOLCONF_SEUP</span></span><br><span class="line">    cfg_params-&gt;coolconf.seup = TMC_COOLCONF_SEUP &amp; cfg_cap.coolconf.seup;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_COOLCONF_SEIMIN</span></span><br><span class="line">    cfg_params-&gt;coolconf.seimin = TMC_COOLCONF_SEIMIN &amp; cfg_cap.coolconf.seimin;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_CHOPCONF_HSTRT</span></span><br><span class="line">    cfg_params-&gt;chopconf.hstrt = (TMC_CHOPCONF_HSTRT - <span class="number">1</span>) &amp; cfg_cap.chopconf.hstrt;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_CHOPCONF_HEND</span></span><br><span class="line">    cfg_params-&gt;chopconf.hend = (TMC_CHOPCONF_HEND + <span class="number">3</span>) &amp; cfg_cap.chopconf.hend;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_CHOPCONF_TBL</span></span><br><span class="line">    cfg_params-&gt;chopconf.tbl = TMC_CHOPCONF_TBL &amp; cfg_cap.chopconf.tbl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_CHOPCONF_TOFF</span></span><br><span class="line">    cfg_params-&gt;chopconf.toff = TMC_CHOPCONF_TOFF &amp; cfg_cap.chopconf.toff;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_CHOPCONF_RDNTF</span></span><br><span class="line">    cfg_params-&gt;chopconf.rndtf = TMC_CHOPCONF_RDNTF &amp; cfg_cap.chopconf.rndtf;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_CHOPCONF_CHM</span></span><br><span class="line">    cfg_params-&gt;chopconf.chm = TMC_CHOPCONF_CHM &amp; cfg_cap.chopconf.chm;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_CHOPCONF_HDEC</span></span><br><span class="line">    cfg_params-&gt;chopconf.hdec = TMC_CHOPCONF_HDEC &amp; cfg_cap.chopconf.hdec;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_CHOPCONF_TFD</span></span><br><span class="line">    cfg_params-&gt;chopconf.tfd = TMC_CHOPCONF_TFD &amp; cfg_cap.chopconf.tfd;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TMC_CHOPCONF_INTPOL</span></span><br><span class="line">    cfg_params-&gt;chopconf.intpol = TMC_CHOPCONF_INTPOL &amp; cfg_cap.chopconf.intpol;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    vsense[<span class="number">0</span>] = params-&gt;vsense[<span class="number">0</span>] / <span class="number">1000.0f</span>;</span><br><span class="line">    vsense[<span class="number">1</span>] = params-&gt;vsense[<span class="number">1</span>] / <span class="number">1000.0f</span>;</span><br><span class="line">    custom_drvconf = cfg_params-&gt;drvconf != params-&gt;dflt.drvconf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="trinamic-driver-config-驱动器配置"><a href="#trinamic-driver-config-驱动器配置" class="headerlink" title="trinamic_driver_config 驱动器配置"></a>trinamic_driver_config 驱动器配置</h3><ol>
<li>cfg.settings &#x3D; &amp;trinamic.driver[motor.axis];trinamic从<code>set_axis_setting</code>函数中配置</li>
<li>cfg_params参数通过<code>trinamic_settings_get_defaults</code>配置为默认值</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">trinamic_driver_config</span> <span class="params">(<span class="type">motor_map_t</span> motor, <span class="type">uint8_t</span> seq)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bool</span> ok = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">trinamic_driver_config_t</span> cfg = &#123;</span><br><span class="line">        .address = motor.id,</span><br><span class="line">        .settings = &amp;trinamic.driver[motor.axis]</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 驱动程序需要进行读取的预配置,则进行进去操作</span></span><br><span class="line">    <span class="keyword">if</span>(driver_if.on_driver_preinit)</span><br><span class="line">        driver_if.on_driver_preinit(motor, &amp;cfg);</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> TRINAMIC_ENABLE == 5160</span></span><br><span class="line">        <span class="comment">//通过TMC5160_AddMotor添加电机,将电机的操作指针保存到stepper[motor.id]中</span></span><br><span class="line">        ok = (stepper[motor.id] = TMC5160_AddMotor(motor, cfg.settings-&gt;current, cfg.settings-&gt;microsteps, cfg.settings-&gt;r_sense)) != <span class="literal">NULL</span>;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!ok) &#123;</span><br><span class="line">        <span class="comment">//流数据打印信息</span></span><br><span class="line">        protocol_enqueue_foreground_task(report_warning, <span class="string">&quot;Could not communicate with stepper driver!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置电机的序列号</span></span><br><span class="line">    stepper[motor.id]-&gt;get_config(motor.id)-&gt;motor.seq = seq;</span><br><span class="line">    <span class="comment">//设置使能掩码</span></span><br><span class="line">    driver_enabled.mask |= bit(motor.axis);</span><br><span class="line">    <span class="comment">//启用扩展设置,并且用户配置了drvconf,则执行写入drvconf寄存器</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRINAMIC_EXTENDED_SETTINGS</span></span><br><span class="line">    <span class="keyword">if</span>(cfg_cap.drvconf &amp;&amp; custom_drvconf)</span><br><span class="line">        stepper[motor.id]-&gt;write_register(motor.id, stepper[motor.id]-&gt;drvconf_address, cfg_params-&gt;drvconf);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">//设置StallGuard2 滤波器使能,写入coolconf寄存器中</span></span><br><span class="line">    <span class="comment">//! 注意开启后,无法更快的响应,就是速度会变慢</span></span><br><span class="line">    stepper[motor.id]-&gt;sg_filter(motor.id, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    stepper[motor.id]-&gt;coolconf(motor.id, cfg_params-&gt;coolconf);</span><br><span class="line">    <span class="comment">// 斩波器配置</span></span><br><span class="line">    stepper[motor.id]-&gt;chopper_timing(motor.id, cfg_params-&gt;chopconf);</span><br><span class="line">    <span class="comment">// stealthChop 和 coolStep配置;二选一</span></span><br><span class="line">    <span class="keyword">if</span>(stepper[motor.id]-&gt;stealthChop)</span><br><span class="line">        stepper[motor.id]-&gt;stealthChop(motor.id, cfg.settings-&gt;mode == TMCMode_StealthChop);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(cfg.settings-&gt;mode == TMCMode_StealthChop)</span><br><span class="line">        cfg.settings-&gt;mode = TMCMode_CoolStep;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PWM_THRESHOLD_VELOCITY &gt; 0</span></span><br><span class="line">    <span class="comment">//spreadCycle 高动态设置</span></span><br><span class="line">    stepper[motor.id]-&gt;set_tpwmthrs(motor.id, (<span class="type">float</span>)PWM_THRESHOLD_VELOCITY / <span class="number">60.0f</span>, settings.axis[motor.axis].steps_per_mm);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    stepper[motor.id]-&gt;set_current(motor.id, cfg.settings-&gt;current, cfg.settings-&gt;hold_current_pct);</span><br><span class="line">    stepper[motor.id]-&gt;set_microsteps(motor.id, cfg.settings-&gt;microsteps);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRINAMIC_DYNAMIC_CURRENT</span></span><br><span class="line">    <span class="comment">//动态电流设置</span></span><br><span class="line">    reduced_current[motor.id] = cfg.settings-&gt;current * cfg.settings-&gt;hold_current_pct / <span class="number">100</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(driver_if.on_driver_postinit)</span><br><span class="line">        driver_if.on_driver_postinit(motor, stepper[motor.id]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="trinamic-poll-status-轮询状态"><a href="#trinamic-poll-status-轮询状态" class="headerlink" title="trinamic_poll_status 轮询状态 ???"></a>trinamic_poll_status 轮询状态 ???</h3><p>??? st_wake_up 和 st_go_idle是什么<br>??? CMD_FEED_HOLD</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">trinamic_poll_status</span> <span class="params">(<span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">bool</span> error_active = <span class="literal">false</span>, error_hold = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">uint32_t</span> error_count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">hold_state_t</span> holding_state = Hold_NotHolding;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint_fast8_t</span> motor = n_motors;</span><br><span class="line">    <span class="type">uint8_t</span> stall_fault = <span class="number">0</span>, otpw_fault = <span class="number">0</span>;</span><br><span class="line">    <span class="type">sys_state_t</span> current_state = state_get(); <span class="comment">// 获取当前系统状态</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调度下一次轮询</span></span><br><span class="line">    task_add_delayed(trinamic_poll_status, <span class="literal">NULL</span>, TRINAMIC_POLL_INTERVAL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(stepper[--motor]) &#123; <span class="comment">// 检查电机是否存在</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果系统处于空闲状态，检查驱动器状态</span></span><br><span class="line">            <span class="keyword">if</span>(current_state == STATE_IDLE)</span><br><span class="line">                status[motor] = stepper[motor]-&gt;get_drv_status(motor);</span><br><span class="line">            <span class="comment">// 处理保持状态</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(current_state == STATE_HOLD &amp;&amp; holding_state == Hold_Pending &amp;&amp; sys.holding_state == Hold_Complete) &#123;</span><br><span class="line">                holding_state == Hold_Complete; <span class="comment">// 如果主轴正在运行并由于重力下拉而降低自己，这可能是危险的，所以暂时禁用。</span></span><br><span class="line">                st_go_idle();                   <span class="comment">// 进入空闲状态</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查是否有过温警告</span></span><br><span class="line">            <span class="keyword">if</span>(status[motor].otpw)</span><br><span class="line">                otpw_fault |= (<span class="number">1</span> &lt;&lt; motor);</span><br><span class="line"><span class="comment">/*            if(status[motor].stallguard) // 检查是否卡住</span></span><br><span class="line"><span class="comment">                stall_fault |= (1 &lt;&lt; motor); */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRINAMIC_DYNAMIC_CURRENT</span></span><br><span class="line">            <span class="type">uint_fast8_t</span> axis = motor_map[motor].axis;</span><br><span class="line">            <span class="comment">// 如果系统处于空闲或报警/保持状态，调整电流</span></span><br><span class="line">            <span class="keyword">if</span>((current_state == STATE_IDLE || (current_state &amp; (STATE_ALARM|STATE_HOLD))) &amp;&amp; dynamic_current[motor] == trinamic.driver[axis].current)</span><br><span class="line">                stepper[motor]-&gt;set_current(motor, (dynamic_current[motor] = reduced_current[motor]), trinamic.driver[axis].hold_current_pct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span>(motor); <span class="comment">// 遍历所有电机</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理故障</span></span><br><span class="line">    <span class="keyword">if</span>(stall_fault || otpw_fault) &#123;</span><br><span class="line">        <span class="keyword">if</span>(++error_count &gt; <span class="number">2</span> &amp;&amp; !error_active) &#123; <span class="comment">// 如果错误计数超过2且错误未激活</span></span><br><span class="line">            error_active = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span>(current_state &amp; (STATE_CYCLE|STATE_HOMING|STATE_JOG)) &#123;</span><br><span class="line">                <span class="comment">// holding_state == Hold_Pending;</span></span><br><span class="line">                grbl.enqueue_realtime_command(CMD_FEED_HOLD); <span class="comment">// 发送实时命令以暂停进给</span></span><br><span class="line">            &#125;</span><br><span class="line">            task_add_immediate(trinamic_status_report, <span class="literal">NULL</span>); <span class="comment">// 立即添加任务以报告状态,流数据打印信息</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(error_active) &#123; <span class="comment">// 如果错误已激活</span></span><br><span class="line">        error_active = <span class="literal">false</span>;</span><br><span class="line">        error_count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(holding_state != Hold_NotHolding) &#123;</span><br><span class="line">            holding_state = Hold_NotHolding;</span><br><span class="line">            st_wake_up(); <span class="comment">// 唤醒系统</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="trinamic-init-初始化"><a href="#trinamic-init-初始化" class="headerlink" title="trinamic_init 初始化"></a>trinamic_init 初始化</h3><p>&#x2F;&#x2F; motor_iterator通过<code>driver_init</code>中注册</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">trinamic_init</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注册电机配置</span></span><br><span class="line">    <span class="type">static</span> <span class="type">setting_details_t</span> settings_details = &#123;</span><br><span class="line">        <span class="comment">// 电机配置</span></span><br><span class="line">        .settings = trinamic_settings,</span><br><span class="line">        <span class="comment">// 电机配置数量</span></span><br><span class="line">        .n_settings = <span class="keyword">sizeof</span>(trinamic_settings) / <span class="keyword">sizeof</span>(<span class="type">setting_detail_t</span>),</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NO_SETTINGS_DESCRIPTIONS    <span class="comment">//不需要描述信息</span></span></span><br><span class="line">        .descriptions = trinamic_settings_descr,    <span class="comment">// 电机配置描述</span></span><br><span class="line">        .n_descriptions = <span class="keyword">sizeof</span>(trinamic_settings_descr) / <span class="keyword">sizeof</span>(<span class="type">setting_descr_t</span>),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        .load = trinamic_settings_load,         <span class="comment">// 电机配置加载</span></span><br><span class="line">        .save = trinamic_settings_save,         <span class="comment">// 电机配置保存</span></span><br><span class="line">        .restore = trinamic_settings_restore    <span class="comment">// 电机配置恢复</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 几个电机需要配置,通过此逻辑进行配置</span></span><br><span class="line">    <span class="keyword">if</span>(hal.stepper.motor_iterator) &#123;    <span class="comment">//动态配置电机,依靠motor_iterator传递</span></span><br><span class="line">        hal.stepper.motor_iterator(count_motors);</span><br><span class="line">        <span class="keyword">if</span>((motor_map = <span class="built_in">malloc</span>(n_motors * <span class="keyword">sizeof</span>(<span class="type">motor_map_t</span>)))) &#123;</span><br><span class="line">            n_motors = <span class="number">0</span>;</span><br><span class="line">            hal.stepper.motor_iterator(assign_motors);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">//静态配置电机 依靠Inc\my_machine.h中的配置</span></span><br><span class="line">        motor_map = <span class="built_in">malloc</span>(N_AXIS * <span class="keyword">sizeof</span>(<span class="type">motor_map_t</span>));</span><br><span class="line">        <span class="keyword">if</span>(motor_map) &#123;</span><br><span class="line">            <span class="type">uint_fast8_t</span> idx;</span><br><span class="line">    <span class="comment">//        n_motors = N_AXIS;</span></span><br><span class="line">            <span class="keyword">for</span>(idx = <span class="number">0</span>; idx &lt; N_AXIS; idx++) &#123;</span><br><span class="line">                motor_map[idx].id = idx;</span><br><span class="line">                motor_map[idx].axis = idx;</span><br><span class="line">            &#125;</span><br><span class="line">            n_motors = idx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 注册一堆函数</span></span><br><span class="line">    <span class="keyword">if</span>(motor_map &amp;&amp; (nvs_address = nvs_alloc(<span class="keyword">sizeof</span>(<span class="type">trinamic_settings_t</span>)))) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;user_mcode, &amp;grbl.user_mcode, <span class="keyword">sizeof</span>(<span class="type">user_mcode_ptrs_t</span>));</span><br><span class="line"></span><br><span class="line">        grbl.user_mcode.check = mcode_check;</span><br><span class="line">        grbl.user_mcode.validate = mcode_validate;</span><br><span class="line">        grbl.user_mcode.execute = mcode_execute;</span><br><span class="line"></span><br><span class="line">        on_realtime_report = grbl.on_realtime_report;</span><br><span class="line">        grbl.on_realtime_report = onRealtimeReport;</span><br><span class="line"></span><br><span class="line">        on_report_options = grbl.on_report_options;</span><br><span class="line">        grbl.on_report_options = onReportOptions;</span><br><span class="line"></span><br><span class="line">        driver_setup = hal.driver_setup;</span><br><span class="line">        hal.driver_setup = onDriverSetup;</span><br><span class="line"></span><br><span class="line">        settings_changed = hal.settings_changed;</span><br><span class="line">        hal.settings_changed = onSettingsChanged;</span><br><span class="line"></span><br><span class="line">        limits_enable = hal.limits.enable;</span><br><span class="line">        hal.limits.enable = limitsEnable;</span><br><span class="line"></span><br><span class="line">        hal.homing.get_feedrate = homingGetFeedrate;</span><br><span class="line"></span><br><span class="line">        settings_register(&amp;settings_details);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRINAMIC_I2C</span></span><br><span class="line">        stepper_enable = hal.stepper.enable;</span><br><span class="line">        hal.stepper.enable = stepperEnable;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mcode-execute-M代码执行"><a href="#mcode-execute-M代码执行" class="headerlink" title="mcode_execute M代码执行"></a>mcode_execute M代码执行</h3><pre><code class="language-c">
</code></pre>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wdfk-prog">Liya Huang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wdfk-prog.space/posts/6773bf13/">https://wdfk-prog.space/posts/6773bf13/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://wdfk-prog.space" target="_blank">wdfk-prog的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/images/covers/03.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/images/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/images/alipay.png" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/alipay.png" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/be154ebb/" title="GCC"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/04.jpg" onerror="onerror=null;src='/images/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">GCC</div></div><div class="info-2"><div class="info-item-1">[TOC] 属性__cleanup__attribute_malloc__ 用于标记函数返回一个新分配的内存块 这有助于编译器进行优化，例如避免不必要的内存检查。  __attribute_alloc_size__ 用于指定分配的内存大小 attribute_alloc_size__ ((1)) 是另一个 GCC 特定的扩展，用于指定分配的内存大小。参数 (1) 表示第一个参数 __size 是分配的内存大小。这有助于编译器进行优化和静态分析  attribute((const)) 标记为纯函数(pure function)纯函数具有以下特性：  无副作用：纯函数不依赖于任何可变的全局状态，也不会修改任何全局状态。这意味着函数的输出仅依赖于其输入参数，不会对程序的其他部分产生影响。 可优化：由于纯函数的输出仅依赖于输入参数，编译器可以进行更激进的优化。例如，编译器可以将纯函数的多次调用合并为一次调用，或者在调用纯函数时进行常量传播和代码移动等优化。  attribute((externally_visible)) 使其在编译器优化过程中保持对外部模块的可见性 用于标记函数或变量，...</div></div></div></a><a class="pagination-related" href="/posts/4a17b156/" title="Hello World"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/07.jpg" onerror="onerror=null;src='/images/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Hello World</div></div><div class="info-2"><div class="info-item-1">Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot;  More info: Writing Run server1$ hexo server  More info: Server Generate static files1$ hexo generate  More info: Generating Deploy to remote sites1$ hexo deploy  More info: Deployment </div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/avatar.png" onerror="this.onerror=null;this.src='/images/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Liya Huang</div><div class="author-info-description">WORK-LIFE BALANCE</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">414</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">49</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">53</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wdfk-prog"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/wdfk-prog" rel="external nofollow noreferrer" target="_blank" title="GitHub"><i class="fab fa-github" style="color: #181717;"></i></a><a class="social-icon" href="https://wdfk-prog.blog.csdn.net/" rel="external nofollow noreferrer" target="_blank" title="CSDN"><i class="fas fa-blog" style="color: #FC5531;"></i></a><a class="social-icon" href="mailto:1425075683@qq.com" rel="external nofollow noreferrer" target="_blank" title="E-mail"><i class="fas fa-envelope" style="color: #4A4A4A;"></i></a><a class="social-icon" href="/images/wechat-qrcode.jpg" target="_blank" title="微信公众号"><i class="fab fa-weixin" style="color: #07C160;"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss" style="color: #EE802F;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎光临！有任何问题或想法，欢迎在文章下留言交流，或者通过 <a href='/about/'>关于页面</a> 联系我。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#grbl"><span class="toc-number">1.</span> <span class="toc-text">grbl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#config"><span class="toc-number">1.1.</span> <span class="toc-text">config</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#driver-init-%E9%A9%B1%E5%8A%A8%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">driver_init 驱动初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#grbl-enter-%E4%B8%BB%E5%85%A5%E5%8F%A3"><span class="toc-number">1.3.</span> <span class="toc-text">grbl_enter 主入口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#task-API"><span class="toc-number">1.4.</span> <span class="toc-text">task API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#task-add-systick-%E6%B7%BB%E5%8A%A0%E7%B3%BB%E7%BB%9F%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.4.1.</span> <span class="toc-text">task_add_systick 添加系统任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gcode-G%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">1.5.</span> <span class="toc-text">gcode G代码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gc-execute-block-%E6%89%A7%E8%A1%8CG%E4%BB%A3%E7%A0%81%E5%9D%97"><span class="toc-number">1.5.1.</span> <span class="toc-text">gc_execute_block 执行G代码块</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#stepper-%E9%A9%B1%E5%8A%A8"><span class="toc-number">2.</span> <span class="toc-text">stepper 驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#st-prep-buffer"><span class="toc-number">2.1.</span> <span class="toc-text">st_prep_buffer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#trinamic"><span class="toc-number">3.</span> <span class="toc-text">trinamic</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.</span> <span class="toc-text">工作模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">3.2.</span> <span class="toc-text">数据结构 *</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TMC-SPI"><span class="toc-number">3.3.</span> <span class="toc-text">TMC SPI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TMC-SPI-Read-%E8%AF%BB%E5%8F%96TMC%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">3.3.1.</span> <span class="toc-text">TMC_SPI_Read 读取TMC寄存器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1"><span class="toc-number">3.3.2.</span> <span class="toc-text">数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TMC5160-c"><span class="toc-number">3.4.</span> <span class="toc-text">TMC5160.c</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TMC5160-%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">3.4.1.</span> <span class="toc-text">TMC5160 文件结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TMC5160-Init-%E5%88%9D%E5%A7%8B%E5%8C%96TMC5160"><span class="toc-number">3.4.2.</span> <span class="toc-text">TMC5160_Init 初始化TMC5160</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tmc-microsteps-to-mres-%E5%BE%AE%E6%AD%A5%E8%BD%AC%E5%88%86%E8%BE%A8%E7%8E%87"><span class="toc-number">3.4.3.</span> <span class="toc-text">tmc_microsteps_to_mres 微步转分辨率</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TMC5160-SetDefaults-%E8%AE%BE%E7%BD%AETMC5160%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-number">3.4.4.</span> <span class="toc-text">TMC5160_SetDefaults 设置TMC5160默认值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TMC5160-AddMotor-%E6%B7%BB%E5%8A%A0TMC5160%E7%94%B5%E6%9C%BA"><span class="toc-number">3.4.5.</span> <span class="toc-text">TMC5160_AddMotor 添加TMC5160电机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stealthChop-%E6%96%A9%E6%B3%A2%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">3.4.6.</span> <span class="toc-text">stealthChop 斩波器配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#trinamic-c"><span class="toc-number">3.5.</span> <span class="toc-text">trinamic.c</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#trinamic-drivers-init-%E9%A9%B1%E5%8A%A8%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.5.1.</span> <span class="toc-text">trinamic_drivers_init 驱动初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-axis-setting-%E8%BD%B4%E8%AE%BE%E7%BD%AE"><span class="toc-number">3.5.2.</span> <span class="toc-text">set_axis_setting 轴设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#trinamic-settings-get-defaults-%E8%8E%B7%E5%8F%96%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE"><span class="toc-number">3.5.3.</span> <span class="toc-text">trinamic_settings_get_defaults 获取默认设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#trinamic-driver-config-%E9%A9%B1%E5%8A%A8%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">3.5.4.</span> <span class="toc-text">trinamic_driver_config 驱动器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#trinamic-poll-status-%E8%BD%AE%E8%AF%A2%E7%8A%B6%E6%80%81"><span class="toc-number">3.5.5.</span> <span class="toc-text">trinamic_poll_status 轮询状态 ???</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#trinamic-init-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.5.6.</span> <span class="toc-text">trinamic_init 初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mcode-execute-M%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="toc-number">3.5.7.</span> <span class="toc-text">mcode_execute M代码执行</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/1db9a982/" title="ext4"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/04.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="ext4"/></a><div class="content"><a class="title" href="/posts/1db9a982/" title="ext4">ext4</a><time datetime="2025-10-07T03:18:15.310Z" title="更新于 2025-10-07 11:18:15">2025-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b554c0f0/" title="mbcache"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/03.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="mbcache"/></a><div class="content"><a class="title" href="/posts/b554c0f0/" title="mbcache">mbcache</a><time datetime="2025-10-07T03:16:04.099Z" title="更新于 2025-10-07 11:16:04">2025-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/88ab2b13/" title="fs-writeback"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/08.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="fs-writeback"/></a><div class="content"><a class="title" href="/posts/88ab2b13/" title="fs-writeback">fs-writeback</a><time datetime="2025-10-07T03:08:29.811Z" title="更新于 2025-10-07 11:08:29">2025-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2089198e/" title="filesystems"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/03.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="filesystems"/></a><div class="content"><a class="title" href="/posts/2089198e/" title="filesystems">filesystems</a><time datetime="2025-10-07T02:52:10.933Z" title="更新于 2025-10-07 10:52:10">2025-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/933a291e/" title="hweight"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/covers/10.jpg" onerror="this.onerror=null;this.src='/images/404.jpg'" alt="hweight"/></a><div class="content"><a class="title" href="/posts/933a291e/" title="hweight">hweight</a><time datetime="2025-10-07T02:49:48.378Z" title="更新于 2025-10-07 10:49:48">2025-10-07</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/images/covers/03.jpg);"><div class="footer-flex"><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">文档</div><div class="footer-flex-content"><a href="/categories/linux/" target="_blank" title="🚀 linux">🚀 linux</a><a href="/categories/rt-thread/" target="_blank" title="📑 rt-thread">📑 rt-thread</a><a href="/categories/uboot/" target="_blank" title="📌 uboot">📌 uboot</a><a href="/categories/LoraWan/" target="_blank" title="⚔️ LoraWan">⚔️ LoraWan</a><a href="/categories/hpatch/" target="_blank" title="❓ hpatch">❓ hpatch</a><a href="/categories/git/" target="_blank" title="⚡️ git">⚡️ git</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">其他</div><div class="footer-flex-content"><a href="/gallery/" target="_blank" title="图库">图库</a><a href="/messageboard/" target="_blank" title="留言板">留言板</a><a href="/shuoshuo/" target="_blank" title="说说">说说</a><a href="/link/" target="_blank" title="示例">示例</a><a href="/link/" target="_blank" title="友链">友链</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">框架</div><div class="footer-flex-content"><a href="https://hexo.io/zh-cn/" rel="external nofollow noreferrer" target="_blank" title="Hexo">Hexo</a><a href="https://butterfly.js.org/" rel="external nofollow noreferrer" target="_blank" title="Butterfly">Butterfly</a></div></div></div><div class="footer-flex-items"><div class="footer-flex-item"><div class="footer-flex-title">贊助</div><div class="footer-flex-content"><div><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/alipay.png" alt='wdfk_prog' width='100px' height='100px'></div></div></div></div></div><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Liya Huang</span><span class="framework-info"><span class="footer-separator">|</span><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo 8.0.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.1</a></span></div><div class="footer_custom_text">你好，欢迎来到我的 <a href="/about/">数字花园</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天" style="display:none"><i class="fas fa-message"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const applyThemeDefaultsConfig = theme => {
    if (theme === 'dark-mode') {
      Chart.defaults.color = "rgba(255, 255, 255, 0.8)"
      Chart.defaults.borderColor = "rgba(255, 255, 255, 0.2)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    } else {
      Chart.defaults.color = "rgba(0, 0, 0, 0.8)"
      Chart.defaults.borderColor = "rgba(0, 0, 0, 0.1)"
      Chart.defaults.scale.ticks.backdropColor = "transparent"
    }
  }

  // Recursively traverse the config object and automatically apply theme-specific color schemes
  const applyThemeConfig = (obj, theme) => {
    if (typeof obj !== 'object' || obj === null) return

    Object.keys(obj).forEach(key => {
      const value = obj[key]
      // If the property is an object and has theme-specific options, apply them
      if (typeof value === 'object' && value !== null) {
        if (value[theme]) {
          obj[key] = value[theme] // Apply the value for the current theme
        } else {
          // Recursively process child objects
          applyThemeConfig(value, theme)
        }
      }
    })
  }

  const runChartJS = ele => {
    window.loadChartJS = true

    Array.from(ele).forEach((item, index) => {
      const chartSrc = item.firstElementChild
      const chartID = item.getAttribute('data-chartjs-id') || ('chartjs-' + index) // Use custom ID or default ID
      const width = item.getAttribute('data-width')
      const existingCanvas = document.getElementById(chartID)

      // If a canvas already exists, remove it to avoid rendering duplicates
      if (existingCanvas) {
          existingCanvas.parentNode.remove()
      }

      const chartDefinition = chartSrc.textContent
      const canvas = document.createElement('canvas')
      canvas.id = chartID

      const div = document.createElement('div')
      div.className = 'chartjs-wrap'

      if (width) {
        div.style.width = width
      }

      div.appendChild(canvas)
      chartSrc.insertAdjacentElement('afterend', div)

      const ctx = document.getElementById(chartID).getContext('2d')

      const config = JSON.parse(chartDefinition)

      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark-mode' : 'light-mode'

      // Set default styles (initial setup)
      applyThemeDefaultsConfig(theme)

      // Automatically traverse the config and apply dual-mode color schemes
      applyThemeConfig(config, theme)

      new Chart(ctx, config)
    })
  }

  const loadChartJS = () => {
    const chartJSEle = document.querySelectorAll('#article-container .chartjs-container')
    if (chartJSEle.length === 0) return

    window.loadChartJS ? runChartJS(chartJSEle) : btf.getScript('https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js').then(() => runChartJS(chartJSEle))
  }

  // Listen for theme change events
  btf.addGlobalFn('themeChange', loadChartJS, 'chartjs')
  btf.addGlobalFn('encrypt', loadChartJS, 'chartjs')

  window.pjax ? loadChartJS() : document.addEventListener('DOMContentLoaded', loadChartJS)
})()</script><script>(() => {
  const abcjsInit = () => {
    const abcjsFn = () => {
      setTimeout(() => {
        const sheets = document.querySelectorAll(".abc-music-sheet")
        for (let i = 0; i < sheets.length; i++) {
          const ele = sheets[i]
          if (ele.children.length > 0) continue

          // Parse parameters from data-params attribute
          let params = {}
          const dp = ele.getAttribute("data-params")
          if (dp) {
            try {
              params = JSON.parse(dp)
            } catch (e) {
              console.error("Failed to parse data-params:", e)
            }
          }

          // Merge parsed parameters with the responsive option
          // Ensures params content appears before responsive
          const options = { ...params, responsive: "resize" }

          // Render the music score using ABCJS.renderAbc
          ABCJS.renderAbc(ele, ele.innerHTML, options)
        }
      }, 100)
    }

    if (typeof ABCJS === "object") {
      abcjsFn()
    } else {
      btf.getScript("https://cdn.jsdelivr.net/npm/abcjs/dist/abcjs-basic-min.min.js").then(abcjsFn)
    }
  }

  if (window.pjax) {
    abcjsInit()
  } else {
    window.addEventListener("load", abcjsInit)
  }

  btf.addGlobalFn("encrypt", abcjsInit, "abcjs")
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: 'Ov23livBmwx65h3XIdfT',
      clientSecret: '9f23bdaa2ea11322f9f405d77bcdc27166077a7d',
      repo: 'wdfk-prog.github.io',
      owner: 'wdfk-prog',
      admin: ['wdfk-prog'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || '33dd8c4a575cfbdc2b7996b5cf6e38d4'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script>window.newestComments = {
  changeContent: content => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<code>.*?<\/code>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g, "") // remove html tag

    if (content.length > 150) {
      content = content.substring(0, 150) + '...'
    }
    return content
  },

  generateHtml: (array, ele) => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class="aside-list-item">'

        if (true && array[i].avatar) {
          const imgAttr = 'data-lazy-src'
          const lazyloadNative = ''
          result += `<a href="${array[i].url}" class="thumbnail"><img ${imgAttr}="${array[i].avatar}" alt="${array[i].nick}" ${lazyloadNative}></a>`
        }

        result += `<div class="content">
        <a class="comment" href="${array[i].url}" title="${array[i].content}">${array[i].content}</a>
        <div class="name"><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '暂无评论'
    }

    ele.innerHTML = result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh(ele)
  },

  newestCommentInit: (name, getComment) => {
    const $dom = document.querySelector('#card-newest-comments .aside-list')
    if ($dom) {
      const data = btf.saveToLocal.get(name)
      if (data) {
        newestComments.generateHtml(JSON.parse(data), $dom)
      } else {
        getComment($dom)
      }
    }
  },

  run: (name, getComment) => {
    newestComments.newestCommentInit(name, getComment)
    btf.addGlobalFn('pjaxComplete', () => newestComments.newestCommentInit(name, getComment), name)
  }
}</script><script>window.addEventListener('load', () => {
  const keyName = 'github-newest-comments'
  const { changeContent, generateHtml, run } = window.newestComments

  const findTrueUrl = (array, ele) => {
    Promise.all(array.map(item =>
      fetch(item.url).then(resp => resp.json()).then(data => {
        let urlArray = data.body ? data.body.match(/(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?/ig) : []
        if (!Array.isArray(urlArray) || urlArray.length === 0) {
          urlArray = [`${data.html_url}`]
        }
        if (data.user.login === 'utterances-bot') {
          return urlArray.pop()
        } else {
          return urlArray.shift()
        }
      })
    )).then(res => {
        array = array.map((i,index)=> {
          return {
            ...i,
            url: res[index]
          }
        })

        btf.saveToLocal.set(keyName, JSON.stringify(array), 10/(60*24))
        generateHtml(array, ele)
    });
  }

  const getComment = ele => {
    fetch('https://api.github.com/repos/wdfk-prog/wdfk-prog.github.io/issues/comments?sort=updated&direction=desc&per_page=6&page=1',{
      "headers": {
        Accept: 'application/vnd.github.v3.html+json'
      }
    })
      .then(response => response.json())
      .then(data => {
        const githubArray = data.map(item => {
          return {
            'avatar': item.user.avatar_url,
            'content': changeContent(item.body_html || item.body),
            'nick': item.user.login,
            'url': item.issue_url,
            'date': item.updated_at
          }
        })
        findTrueUrl(githubArray, ele)
      }).catch(e => {
        console.error(e)
        ele.textContent= "无法获取评论，请确认相关配置是否正确"
      })
  }
  run(keyName, getComment)
})</script><div class="aplayer no-destroy" data-id="60198" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false" data-volume="0.5"></div><script>
  var titleTime, OriginTitile = document.title;
  document.addEventListener("visibilitychange", function() {
    if (document.hidden) {
      titleTime = setTimeout(function() {
        document.title = "w(ﾟДﾟ)w 不要走！再看看嘛！";
      }, 300);
    } else {
      document.title = "♪(^∇^*)欢迎回来！" + OriginTitile;
      titleTime = setTimeout(function() {
        document.title = OriginTitile;
      }, 2000);
    }
  });
</script>
<script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script>(() => {
  window.ChatraID = '5cPWcnA8HKGzg5hoc'
  window.Chatra = window.Chatra || function() {
    (window.Chatra.q = window.Chatra.q || []).push(arguments)
  }

  btf.getScript('https://call.chatra.io/chatra.js').then(() => {
    const isChatBtn = true
    const isChatHideShow = true

    if (isChatBtn) {
      const close = () => {
        Chatra('minimizeWidget')
        Chatra('hide')
      }

      const open = () => {
        Chatra('openChat', true)
        Chatra('show')
      }

      window.ChatraSetup = { startHidden: true }
    
      window.chatBtnFn = () => document.getElementById('chatra').classList.contains('chatra--expanded') ? close() : open()

      document.getElementById('chat-btn').style.display = 'block'
    } else if (isChatHideShow) {
      window.chatBtn = {
        hide: () => Chatra('hide'),
        show: () => Chatra('show')
      }
    }
  })
})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: true,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => {
      try {
        fn()
      } catch (err) {
        console.debug('Pjax callback failed:', err)
      }
    })
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      true
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden="hidden"></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"/></div><hr/><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none;"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MF3J339H" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript></div><script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const heatmapChartDom = document.getElementById('heatmapChart');
                if(heatmapChartDom){
                    const heatmapChart = echarts.init(heatmapChartDom, 'dark');
                    const cellSize = [18, 18];
                    
                    const groupByYear = (data) => {
                        const result = {};
                        data.forEach(([date, value]) => {
                            const [year] = date.split('-').map(Number);
                            if (!result[year]) {
                                result[year] = [];
                            }
                            result[year].push([date, value]);
                        });
                        return result;
                    };
                    
                    const groupedData = groupByYear([["2025-10-03",392],["2025-10-04",5],["2025-10-06",9],["2025-10-07",8]]);
                    const years = Object.keys(groupedData).reverse();
                    
                    var initYear = parseInt(heatmapChartDom.getAttribute('year')) || new Date().getFullYear();
                    const minYear = years[years.length - 1];
                    const maxYear = years[0];
                    if (initYear < minYear || initYear > maxYear) {
                        initYear = maxYear;
                    }
                    console.log('[hexo-graph]generateHeatmapChart|initYear:', initYear, 'minYear:', minYear, 'maxYear:', maxYear);
                    
                    heatmapChart.setOption({
                        grid: {},
                        tooltip: { 
                            position: 'top', 
                            formatter: params => `${params.value[0]}: ${params.value[1]} Articles` 
                        },
                        calendar: { 
                            top: '10%',
                            left: 'left', 
                            right: '8%',
                            range: initYear,
                            cellSize: cellSize, 
                            splitLine: { lineStyle: { color: '#E0E0E0', width: 1 } }, 
                            itemStyle: { borderWidth: 1, borderColor: '#E0E0E0' }, 
                            dayLabel: { show: false },
                            monthLabel: { show: true },
                            yearLabel: { show: false },
                        },
                        visualMap: { 
                            show: true,
                            right: '8%',
                            bottom: '5%',
                            type: 'piecewise',
                            orient: 'horizontal',
                            text: ['More', 'Less'],
                            min: 0,
                            max: Math.max(...groupedData[initYear].map(item => item[1])),
                            inRange: { color: ["#ACE7AE","#69C16D","#549F57"] }
                        },
                        legend: {
                            type: 'scroll',
                            icon: 'none',
                            data: years,
                            orient: 'vertical',
                            top: '5%',
                            right: 'right',
                            itemWidth: 20,
                            itemHeight: 20,
                            itemGap: 10,
                            pageIconSize: 10,
                            pageTextStyle: { fontSize: 14 },
                            selectedMode: 'single',
                        },
                        series: years.map(year => ({
                            type: 'heatmap',
                            coordinateSystem: 'calendar',
                            data: groupedData[year],
                            name: year,
                            emphasis: {
                                disabled: true,
                            },
                            silent: year !== initYear,
                        })),
                    });
                    
                    // init selected year
                    heatmapChart.dispatchAction({
                        type: 'legendSelect',
                        name: initYear,
                    });
                    
                    heatmapChart.on('legendselectchanged', function(params) {
                        console.log('[hexo-graph]generateHeatmapChart|legendselectchanged:', params);
                        const selectedYear = Object.keys(params.selected).find(key => params.selected[key]);
                        if (selectedYear && groupedData[selectedYear]) {
                            heatmapChart.setOption({
                                calendar: {
                                    range: selectedYear,
                                },
                                visualMap: {
                                    max: Math.max(...groupedData[selectedYear].map(item => item[1])),
                                },
                                series: years.map(year => ({
                                    type: 'heatmap',
                                    coordinateSystem: 'calendar',
                                    data: groupedData[year],
                                    name: year,
                                    emphasis: {
                                        disabled: true,
                                    },
                                    silent: year !== selectedYear,
                                })),
                            });
                        }
                    });
                    
                    heatmapChart.on('click', function (params) {
                        if (params.componentType === 'series') {
                            const [year, month] = params.value[0].split('-');
                            window.location.href = '/archives/' + year + '/' + month;
                        }
                    });
                }
            });
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const monthlyChartDom = document.getElementById('monthlyChart');
                if(monthlyChartDom){
                    const monthlyChart = echarts.init(monthlyChartDom, 'dark');
                    monthlyChart.setOption({
                        xAxis: { 
                            type: 'category', 
                            data: ["2025-10"], 
                            axisLabel: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        },
                        yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#ccc' } } },
                        series: [{
                            name: 'Articles',
                            type: 'line',
                            data: [414],
                            smooth: true,
                            lineStyle: { color: '#5470C6', width: 2 },
                            itemStyle: { color: '#5470C6' },
                            areaStyle: { color: 'rgba(84, 112, 198, 0.4)' },
                            symbolSize: 10,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: params => params.value,
                                fontSize: 14,
                                color: '#000',
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            }
                        }]
                    });

                    monthlyChart.on('click', function (params) {
                        const [year, month] = params.name.split('-');
                        window.location.href = '/archives/' + year + '/' + month;
                    });
                }
            })
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const tagsChartDom = document.getElementById('tagsChart');
                if(tagsChartDom){
                    const tagsChart = echarts.init(tagsChartDom, 'dark');
                    tagsChart.setOption({
                        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                        series: [{
                            type: 'pie',
                            radius: '60%',
                            data: [{"name":"linux","value":227},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44},{"name":"drivers","value":39},{"name":"fs","value":37},{"name":"other","value":28}],
                            label: {
                                position: 'outside',
                                formatter: '{b} {c} ({d}%)',
                                fontSize: 14,
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            },
                            color: ["#5470C6","#91CC75","#FAC858","#EE6666","#73C0DE","#3BA272","#FC8452","#9A60B4"],
                            labelLine: { show: true }
                        }],
                        legend: {
                            bottom: '0',
                            left: 'center',
                            data: [{"name":"linux","value":227},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44},{"name":"drivers","value":39},{"name":"fs","value":37},{"name":"other","value":28}].map(tag => tag.name),
                            textStyle: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        }
                    });

                    tagsChart.on('click', function (params) {
                        window.location.href = '/tags/' + params.name;
                    });
                }
            })
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const categoriesChartDom = document.getElementById('categoriesChart');
                if(categoriesChartDom){
                    const categoriesChart = echarts.init(categoriesChartDom, 'dark');
                    categoriesChart.setOption({
                        xAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: '#ccc' } } },
                        yAxis: { 
                            type: 'category', 
                            data: [{"name":"linux","value":227},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44}].map(category => category.name).reverse(), 
                            axisLabel: { fontSize: 14, fontWeight: 'bold', fontFamily: 'Microsoft YaHei, SimSun, serif' }
                        },
                        series: [{
                            name: 'Category Count',
                            type: 'bar',
                            data: [{"name":"linux","value":227},{"name":"uboot","value":68},{"name":"kernel","value":61},{"name":"rt-thread","value":44},{"name":"u-boot分类","value":44}].map(category => category.value).reverse(),
                            label: {
                                show: true,
                                position: 'right',
                                formatter: params => params.value,
                                fontSize: 14,
                                color: '#000',
                                fontWeight: 'bold',
                                fontFamily: 'Microsoft YaHei, SimSun, serif'
                            },
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    { offset: 0, color: '#91CC75' },
                                    { offset: 1, color: '#73C0DE' }
                                ])
                            }
                        }]
                    });

                    categoriesChart.on('click', function (params) {
                        window.location.href = '/categories/' + params.name;
                    });
                }
            });
        </script>
    
        
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const categoriesTreeChartDom = document.getElementById('categoriesTreeChart');
                if(categoriesTreeChartDom){
                    const treeChart = echarts.init(categoriesTreeChartDom, 'dark');
                    treeChart.setOption({
                        title: {
                            text: '操作提示：单击展开分类，双击进入具体分类页面',
                            textStyle: {
                                fontSize: 12,
                                color: '#999',
                                fontWeight: 'normal'
                            },
                            bottom: 0,
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'item',
                            triggerOn: 'mousemove'
                        },
                        series: [{
                            type: 'tree',
                            data: [{"name":"Categories","children":[{"name":"uboot","children":[{"name":"other","children":[],"count":12,"path":"uboot/other"},{"name":"子目录","children":[],"count":10,"path":"uboot/子目录"},{"name":"u-boot分类","children":[{"name":"api","children":[],"count":1,"path":"uboot/u-boot分类/api"},{"name":"arch","children":[{"name":"arm","children":[],"count":2,"path":"uboot/u-boot分类/arch/arm"}],"count":3,"path":"uboot/u-boot分类/arch"},{"name":"boot","children":[],"count":4,"path":"uboot/u-boot分类/boot"},{"name":"common","children":[],"count":10,"path":"uboot/u-boot分类/common"},{"name":"cmd","children":[],"count":1,"path":"uboot/u-boot分类/cmd"},{"name":"dm","children":[],"count":15,"path":"uboot/u-boot分类/dm"},{"name":"env","children":[],"count":1,"path":"uboot/u-boot分类/env"},{"name":"fdt","children":[],"count":1,"path":"uboot/u-boot分类/fdt"},{"name":"lib","children":[],"count":4,"path":"uboot/u-boot分类/lib"},{"name":"include","children":[],"count":3,"path":"uboot/u-boot分类/include"},{"name":"test","children":[],"count":1,"path":"uboot/u-boot分类/test"}],"count":44,"path":"uboot/u-boot分类"}],"count":68,"path":"uboot"},{"name":"rt-thread","children":[{"name":"其他资料","children":[{"name":"fatfs","children":[],"count":1,"path":"rt-thread/其他资料/fatfs"}],"count":1,"path":"rt-thread/其他资料"}],"count":44,"path":"rt-thread"},{"name":"linux","children":[{"name":"fs","children":[],"count":37,"path":"linux/fs"},{"name":"lib","children":[],"count":19,"path":"linux/lib"},{"name":"mm","children":[],"count":19,"path":"linux/mm"},{"name":"kernel","children":[{"name":"time","children":[],"count":10,"path":"linux/kernel/time"},{"name":"irq","children":[],"count":5,"path":"linux/kernel/irq"},{"name":"rcu","children":[],"count":3,"path":"linux/kernel/rcu"},{"name":"lock","children":[],"count":7,"path":"linux/kernel/lock"},{"name":"sched","children":[],"count":7,"path":"linux/kernel/sched"}],"count":61,"path":"linux/kernel"},{"name":"other","children":[],"count":17,"path":"linux/other"},{"name":"scripts","children":[],"count":2,"path":"linux/scripts"},{"name":"security","children":[],"count":1,"path":"linux/security"},{"name":"include","children":[],"count":10,"path":"linux/include"},{"name":"block","children":[],"count":5,"path":"linux/block"},{"name":"drivers","children":[{"name":"clk","children":[],"count":2,"path":"linux/drivers/clk"},{"name":"base","children":[],"count":14,"path":"linux/drivers/base"},{"name":"tty","children":[],"count":2,"path":"linux/drivers/tty"}],"count":39,"path":"linux/drivers"},{"name":"arch","children":[{"name":"arm","children":[],"count":10,"path":"linux/arch/arm"}],"count":10,"path":"linux/arch"}],"count":227,"path":"linux"},{"name":"hpatch","children":[{"name":"SA-IS","children":[],"count":1,"path":"hpatch/SA-IS"},{"name":"libdivsufsort","children":[],"count":3,"path":"hpatch/libdivsufsort"}],"count":10,"path":"hpatch"},{"name":"杂谈","children":[],"count":8,"path":"杂谈"},{"name":"MCU","children":[],"count":23,"path":"MCU"},{"name":"git","children":[],"count":6,"path":"git"},{"name":"LoraWan","children":[{"name":"LoRaWAN标准","children":[{"name":"LoRaWAN-Specification_ZH_CN","children":[{"name":"LoRaWAN-Specification_ZH_CN-190102","children":[{"name":"chapter","children":[],"count":20,"path":"LoraWan/LoRaWAN标准/LoRaWAN-Specification_ZH_CN/LoRaWAN-Specification_ZH_CN-190102/chapter"}],"count":22,"path":"LoraWan/LoRaWAN标准/LoRaWAN-Specification_ZH_CN/LoRaWAN-Specification_ZH_CN-190102"}],"count":22,"path":"LoraWan/LoRaWAN标准/LoRaWAN-Specification_ZH_CN"}],"count":22,"path":"LoraWan/LoRaWAN标准"}],"count":23,"path":"LoraWan"},{"name":"freertos","children":[],"count":1,"path":"freertos"},{"name":"tmc5160","children":[],"count":1,"path":"tmc5160"}],"count":0,"path":""}],
                            initialTreeDepth: -1,
                            top: '5%',
                            bottom: '10%',
                            left: '0%',
                            right: '0%',
                            symbolSize: 15,
                            layout: 'orthogonal',
                            orient: 'TB',
                            itemStyle: {
                                color: '#91CC75',
                                borderColor: '#73C0DE'
                            },
                            label: {
                                position: 'bottom',
                                verticalAlign: 'middle',
                                align: 'center',
                                fontSize: 14,
                                distance: 28,
                                formatter: function(params) {
                                    return params.data.name + (params.data.count ? ' (' + params.data.count + ')' : '');
                                }
                            },
                            leaves: {
                                label: {
                                    position: 'top',
                                    verticalAlign: 'middle',
                                    align: 'center'
                                }
                            },
                            emphasis: {
                                focus: 'descendant'
                            },
                            expandAndCollapse: true
                        }]
                    });

                    treeChart.on('dblclick', function (params) {
                        if (params.data && params.data.path) {
                            window.location.href = '/categories/' + params.data.path;
                        }
                    });
                }
            });
        </script>
    
    <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>